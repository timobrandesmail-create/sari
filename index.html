import React, { useMemo, useState, useEffect } from "react";

/**
 * SARI Governance – Pitch SPA (React, single-file)
 * v2: Dashboard with urgency-sorted SARI tiles + SARI Detail with timeline (Dry Run @60d, PP @100d)
 * - No backend; demo SARIs in-memory
 * - Hash routing: #/ (dashboard), #/sari/:id (detail)
 * - Pitch Mode toggle (read-only snapshot)
 */

// ---- Utilities ----
const addDays = (iso, d) => {
  if (!iso) return null;
  const t = new Date(iso);
  const x = new Date(t.getTime());
  x.setDate(t.getDate() + d);
  return x.toISOString().slice(0, 10);
};
const todayISO = () => new Date(Date.now()).toISOString().slice(0, 10);
const daysBetween = (a, b) => {
  if (!a || !b) return null;
  const A = new Date(a), B = new Date(b);
  return Math.round((B - A) / (24 * 3600 * 1000));
};
const deltaFromToday = (target) => (target ? daysBetween(todayISO(), target) : null);
const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

// ---- Demo Data ----
const mkSari = (id, level, day1, sod, meta = {}) => ({
  id, level, day1, sod, meta,
  steps: {
    s0: { customerInfo: "", firstEvent: day1, lineStop: "Nein", stockProof: "" },
    s1: { leader: "", sponsor: "", owner: "", ops: "", members: "" },
    s2: { issue: "", supply: "", a5w2h: "", isNot: "" },
    s3: { validation: "", trace: "", trigger: "Nein", curative: "Nein" },
    s4: { rc1: "", rc2: "", rc3: "", whys: [] },
    s5: { pca: [] },
    s6: { eff: [] },
    s7: { lookAcross: "", sop: "", fmea: "" },
    s8: { checks: { eff: false, docs: false, lessons: false, why: false }, comment: "" },
  },
  milestones: { dryRun: { target: addDays(day1, 60) }, pp: { target: addDays(day1, 100) } },
  status: "Open",
});

const demoSARIs = [
  mkSari("SE-25.0123", "L1", "2025-09-01", { s: 8, o: 5, d: 9 }, { title: "GEN-004 Incorrect Assembly – hinge bracket" }),
  mkSari("SE-25.0456", "L2", "2025-08-30", { s: 6, o: 6, d: 6 }, { title: "GEN-010 Torque issue – fasteners" }),
  mkSari("SE-25.0789", "L3", "2025-10-01", { s: 4, o: 5, d: 7 }, { title: "GEN-001 FOD – wiring bay" }),
  mkSari("SE-25.0999", "L2", "2025-07-20", { s: 7, o: 7, d: 7 }, { title: "GEN-012 Corrosion – panel" }),
];
// seed some content so tiles look alive
 demoSARIs[0].steps.s2.issue = "1 object / 1 defect: hinge mis-assembly on LH door";
 demoSARIs[0].steps.s5.pca = [
   { txt: "Introduce Poka-Yoke", owner: "Ops", due: "2025-10-12", rc: "RC2", metric: "Cpk >=1.33", status: "In Arbeit" },
   { txt: "Revise SOP 27-14", owner: "QE", due: "2025-10-20", rc: "RC3", metric: "Audit=0 NC", status: "Offen" },
 ];
 demoSARIs[1].steps.s4.rc1 = "Incorrect torque procedure";
 demoSARIs[1].steps.s4.rc2 = "Missing in-process torque check";
 demoSARIs[2].status = "In Dry Run";

// ---- Routing ----
function useRouter() {
  const parse = () => {
    const hash = window.location.hash.replace(/^#\/?/, "");
    const seg = hash.split("/");
    if (!hash || hash === "" || hash === "dashboard") return { page: "dashboard" };
    if (seg[0] === "sari" && seg[1]) return { page: "sari", id: seg[1] };
    return { page: "dashboard" };
  };
  const [route, setRoute] = useState(parse());
  useEffect(() => {
    const onHash = () => setRoute(parse());
    window.addEventListener("hashchange", onHash);
    return () => window.removeEventListener("hashchange", onHash);
  }, []);
  const go = (to) => (window.location.hash = to);
  return [route, go];
}

// ---- UI Primitives ----
function Card({ children, style }) {
  return (
    <div style={{ background: "#131a24", border: "1px solid #263142", borderRadius: 12, padding: 14, ...style }}>{children}</div>
  );
}
function Label({ children }) {
  return <label style={{ color: "#91a2b2", fontSize: 12, display: "block", marginBottom: 4 }}>{children}</label>;
}
function Row({ children, cols = 2, gap = 12, style }) {
  return (
    <div style={{ display: "grid", gridTemplateColumns: `repeat(${cols}, minmax(0,1fr))`, gap, marginBottom: 12, ...style }}>{children}</div>
  );
}
function ToolbarButton({ children, onClick, primary }) {
  return (
    <button onClick={onClick} style={{ padding: "8px 12px", borderRadius: 10, border: primary ? "none" : "1px solid #324055", background: primary ? "linear-gradient(135deg,#4ab1ff,#62e3b2)" : "#1a2230", color: primary ? "#07130c" : "#e8eef6", fontWeight: primary ? 700 : 500, cursor: "pointer" }}>{children}</button>
  );
}
const td = { padding: 8, background: "#131a24", border: "1px solid #263142", borderRadius: 8 };

// ---- Derived helpers ----
const computeRPN = (sod) => (Number(sod.s) || 0) * (Number(sod.o) || 0) * (Number(sod.d) || 0);
const computeProgress = (sari) => {
  const { steps } = sari;
  const checks = [
    !!(steps.s0.customerInfo && steps.s0.firstEvent),
    !!(steps.s1.leader && steps.s1.sponsor && steps.s1.owner && steps.s1.ops),
    !!(steps.s2.issue && steps.s2.a5w2h),
    !!steps.s3.validation,
    !!(steps.s4.rc1 && steps.s4.rc2),
    steps.s5.pca.length > 0,
    steps.s6.eff.every((e) => e.effective),
    sari.level === "L1" || computeRPN(sari.sod) >= 300 ? !!(steps.s7.fmea || steps.s7.sop) : true,
    Object.values(steps.s8.checks).every(Boolean),
  ];
  const done = checks.filter(Boolean).length;
  return Math.round((done / checks.length) * 100);
};

// urgency sort per spec: level, dryRun delta, pp delta, rpn, overdue pcas
const urgencyScore = (s) => {
  const lvl = s.level === "L1" ? 3 : s.level === "L2" ? 2 : 1;
  const dDry = deltaFromToday(s.milestones.dryRun?.target) ?? 9999; // negative = overdue
  const dPP = deltaFromToday(s.milestones.pp?.target) ?? 9999;
  const rpn = computeRPN(s.sod);
  const overdue = (s.steps.s5.pca || []).filter((p) => p.due && p.status !== "Erledigt" && p.due < todayISO()).length;
  // lower is more urgent; return tuple emulation
  return [ -lvl, (dDry>=0? dDry: dDry*2), (dPP>=0? dPP: dPP*1.5), -rpn, -overdue ];
};
const compareTuple = (a,b)=>{ for(let i=0;i<Math.max(a.length,b.length);i++){ const d=(a[i]||0)-(b[i]||0); if(d!==0) return d; } return 0; };

// ---- Components ----
function KPI({ label, value, sub }) {
  return (
    <Card>
      <div style={{ color: "#93a4b6", fontSize: 12, textTransform: "uppercase", letterSpacing: ".06em" }}>{label}</div>
      <div style={{ fontSize: 22, fontWeight: 800 }}>{value}</div>
      {sub && <div style={{ fontSize: 12, color: "#93a4b6" }}>{sub}</div>}
    </Card>
  );
}

function Dashboard({ list, onOpen }) {
  const sorted = useMemo(() => [...list].sort((a,b)=> compareTuple(urgencyScore(a), urgencyScore(b))), [list]);
  const totals = useMemo(()=>({
    open: list.filter(s=> s.status!=="Closed").length,
    overdueMs: list.filter(s=> (deltaFromToday(s.milestones.dryRun?.target)??1)<0 || (deltaFromToday(s.milestones.pp?.target)??1)<0).length,
    avgDry: Math.round(list.reduce((acc,s)=>acc+(deltaFromToday(s.milestones.dryRun?.target)??0),0)/Math.max(1,list.length)),
    avgPP: Math.round(list.reduce((acc,s)=>acc+(deltaFromToday(s.milestones.pp?.target)??0),0)/Math.max(1,list.length)),
    topIrr: list.filter(s=> s.level==="L1" || computeRPN(s.sod)>=300).length,
  }),[list]);

  return (
    <>
      <Row cols={5}>
        <KPI label="Open SARIs" value={totals.open} />
        <KPI label="Overdue Milestones" value={totals.overdueMs} />
        <KPI label="Ø Days to Dry Run" value={totals.avgDry} />
        <KPI label="Ø Days to PP" value={totals.avgPP} />
        <KPI label="Top Irritants" value={totals.topIrr} />
      </Row>
      <Row cols={3} gap={16}>
        {sorted.map((s)=> (
          <SariTile key={s.id} sari={s} onOpen={()=> onOpen(s)} />
        ))}
      </Row>
    </>
  );
}

function Chip({ children, tone="muted" }){
  const palette = { muted: "#1a2332", warn: "#3a2a10", ok: "#0f2a22", info: "#1a2438" };
  const color = { muted: "#9bb0c7", warn: "#f6d18b", ok: "#9fe6cb", info: "#a9c4ff" };
  return <span style={{ fontSize: 12, padding: "3px 8px", borderRadius: 999, background: palette[tone], color: color[tone], border: "1px solid #2a3750" }}>{children}</span>;
}

function SariTile({ sari, onOpen }){
  const rpn = computeRPN(sari.sod);
  const prog = computeProgress(sari);
  const dDry = deltaFromToday(sari.milestones.dryRun?.target);
  const dPP = deltaFromToday(sari.milestones.pp?.target);
  const dryTxt = dDry==null? "—" : dDry<0? `DRY RUN ${Math.abs(dDry)}d overdue` : `DRY RUN in ${dDry}d`;
  const ppTxt = dPP==null? "—" : dPP<0? `PP ${Math.abs(dPP)}d overdue` : `PP in ${dPP}d`;
  const overdue = (sari.steps.s5.pca||[]).filter(p=> p.due && p.status!=="Erledigt" && p.due<todayISO()).length;
  return (
    <Card>
      <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:8 }}>
        <div style={{ fontWeight:800 }}>{sari.id}</div>
        <div style={{ display:"flex", gap:8, alignItems:"center" }}>
          <Chip tone="info">{sari.level}</Chip>
          { (sari.level==="L1" || rpn>=300) && <Chip tone="warn">Top Irritant</Chip> }
        </div>
      </div>
      <div style={{ color:"#9ab0c6", fontSize:12 }}>{sari.meta?.title || sari.steps.s2.issue || "—"}</div>
      <Row cols={3} style={{ marginTop:8 }}>
        <div><Label>RPN</Label><div style={{ fontWeight:700 }}>{rpn}</div><div style={{color:"#9ab0c6", fontSize:12}}>S/O/D {sari.sod.s}/{sari.sod.o}/{sari.sod.d}</div></div>
        <div><Label>Fortschritt</Label><div style={{ fontWeight:700 }}>{prog}%</div></div>
        <div><Label>Overdue Aktionen</Label><div style={{ fontWeight:700 }}>{overdue}</div></div>
      </Row>
      <Row cols={2}>
        <div><Chip tone={dDry<0?"warn":"info"}>{dryTxt}</Chip></div>
        <div><Chip tone={dPP<0?"warn":"info"}>{ppTxt}</Chip></div>
      </Row>
      <div style={{ display:"flex", justifyContent:"flex-end" }}>
        <ToolbarButton primary onClick={onOpen}>Öffnen</ToolbarButton>
      </div>
    </Card>
  );
}

function Timeline({ sari, onJump }){
  const nodes = [
    { id:"s0", label:"S0" },{ id:"s1", label:"S1" },{ id:"s2", label:"S2" },{ id:"s3", label:"S3" },{ id:"s4", label:"S4" },{ id:"s5", label:"S5" },
    { id:"dry", label:"Dry Run", milestone:true, target: sari.milestones.dryRun?.target },
    { id:"s6", label:"S6" },
    { id:"pp", label:"PP", milestone:true, target: sari.milestones.pp?.target },
    { id:"s7", label:"S7" },{ id:"s8", label:"S8" },
  ];
  return (
    <div style={{ display:"flex", gap:16, overflowX:"auto", padding:"6px 2px" }}>
      {nodes.map(n=>{
        const isMilestone = !!n.milestone;
        const due = n.target;
        const d = n.milestone ? deltaFromToday(due) : null;
        const tone = isMilestone ? (d!=null && d<0 ? "#ffcc66" : "#a9c4ff") : "#9ab0c6";
        return (
          <div key={n.id} onClick={()=> onJump && onJump(n.id)} style={{ minWidth: 100, cursor:"pointer" }}>
            <div style={{ width:12, height:12, borderRadius:999, background: tone, marginBottom:6 }} />
            <div style={{ fontWeight: isMilestone?800:600 }}>{n.label}</div>
            {isMilestone && <div style={{ fontSize:12, color:"#9ab0c6" }}>{due || "—"}</div>}
          </div>
        );
      })}
    </div>
  );
}

function StepPanel({ title, children }){
  return (
    <Card style={{ minWidth: 320 }}>
      <div style={{ fontWeight: 700, marginBottom: 6 }}>{title}</div>
      {children}
    </Card>
  );
}

function SariCoreLane({ sari }){
  const ref = React.useRef(null);
  const jump = (id)=>{
    const el = ref.current?.querySelector(`[data-panel="${id}"]`);
    el?.scrollIntoView({ behavior:"smooth", inline:"start", block:"nearest" });
  };
  return (
    <>
      <Timeline sari={sari} onJump={jump} />
      <div ref={ref} style={{ display:"flex", gap:12, overflowX:"auto", paddingTop:8 }}>
        <div data-panel="s0"><StepPanel title="S0 • Containment">
          <Row>
            <div><Label>Kundeninfo</Label><div>{sari.steps.s0.customerInfo || "—"}</div></div>
            <div><Label>Line Stop</Label><div>{sari.steps.s0.lineStop}</div></div>
          </Row>
          <Label>Bestandsprüfung</Label><div style={td}>{sari.steps.s0.stockProof || "—"}</div>
        </StepPanel></div>

        <div data-panel="s1"><StepPanel title="S1 • Team Charter">
          <Row cols={3}>
            <div><Label>Leader</Label><div>{sari.steps.s1.leader || "—"}</div></div>
            <div><Label>Sponsor</Label><div>{sari.steps.s1.sponsor || "—"}</div></div>
            <div><Label>Owner</Label><div>{sari.steps.s1.owner || "—"}</div></div>
          </Row>
          <Row>
            <div><Label>Ops</Label><div>{sari.steps.s1.ops || "—"}</div></div>
            <div><Label>MFT</Label><div>{sari.steps.s1.members || "—"}</div></div>
          </Row>
        </StepPanel></div>

        <div data-panel="s2"><StepPanel title="S2 • Evidence Hub">
          <Label>Issue</Label><div style={td}>{sari.steps.s2.issue || "—"}</div>
          <Row>
            <div><Label>5W2H</Label><div style={td}>{sari.steps.s2.a5w2h || "—"}</div></div>
            <div><Label>IS / IS NOT</Label><div style={td}>{sari.steps.s2.isNot || "—"}</div></div>
          </Row>
        </StepPanel></div>

        <div data-panel="s3"><StepPanel title="S3 • Validate Containment">
          <Row>
            <div><Label>Validierung</Label><div>{sari.steps.s3.validation || "—"}</div></div>
            <div><Label>Traceability</Label><div>{sari.steps.s3.trace || "—"}</div></div>
          </Row>
        </StepPanel></div>

        <div data-panel="s4"><StepPanel title="S4 • RCA">
          <Row cols={3}>
            <div><Label>RC1</Label><div>{sari.steps.s4.rc1 || "—"}</div></div>
            <div><Label>RC2</Label><div>{sari.steps.s4.rc2 || "—"}</div></div>
            <div><Label>RC3</Label><div>{sari.steps.s4.rc3 || "—"}</div></div>
          </Row>
          {sari.steps.s4.whys?.length>0 && (<>
            <Label>5‑Whys</Label>
            <ol>{sari.steps.s4.whys.map((w,i)=>(<li key={i}>{w}</li>))}</ol>
          </>)}
        </StepPanel></div>

        <div data-panel="s5"><StepPanel title="S5 • Corrective Actions">
          {sari.steps.s5.pca.length===0? <div style={{ color: "#93a4b6" }}>Keine Maßnahmen erfasst.</div> : (
            <table style={{ width:"100%", borderCollapse:"separate", borderSpacing:"0 8px" }}>
              <thead><tr>{["Maßnahme","Owner","Fällig","RC","Metrik","Status"].map(h=> <th key={h} style={{ textAlign:"left", padding:8, color:"#93a4b6", fontSize:12 }}>{h}</th>)}</tr></thead>
              <tbody>
                {sari.steps.s5.pca.map((p,i)=> (
                  <tr key={i}>
                    <td style={td}>{p.txt}</td><td style={td}>{p.owner}</td><td style={td}>{p.due}</td>
                    <td style={td}>{p.rc}</td><td style={td}>{p.metric}</td><td style={td}>{p.status}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </StepPanel></div>

        <div data-panel="dry"><StepPanel title="Milestone • Dry Run (≤60d)">
          <Label>Zieltermin</Label><div style={td}>{sari.milestones.dryRun?.target || "—"}</div>
          <div style={{ fontSize:12, color:"#9ab0c6", marginTop:6 }}>Dry Run ist die interne Generalprobe zwischen S5 und S6.</div>
        </StepPanel></div>

        <div data-panel="s6"><StepPanel title="S6 • Implement & Effectiveness">
          {sari.steps.s6.eff.length===0? <div style={{ color: "#93a4b6" }}>Noch keine Wirksamkeitsnachweise.</div> : (
            <ul>{sari.steps.s6.eff.map((e,i)=> (<li key={i}>{e.txt || `Maßnahme ${i+1}`} – {e.effective? "wirksam":"offen"}</li>))}</ul>
          )}
        </StepPanel></div>

        <div data-panel="pp"><StepPanel title="Milestone • PP (≤100d)">
          <Label>Zieltermin</Label><div style={td}>{sari.milestones.pp?.target || "—"}</div>
          <div style={{ fontSize:12, color:"#9ab0c6", marginTop:6 }}>Production Panel – formale Validierung nach S6.</div>
        </StepPanel></div>

        <div data-panel="s7"><StepPanel title="S7 • Standardize & Prevent">
          <Label>Look‑Across</Label><div style={td}>{sari.steps.s7.lookAcross || "—"}</div>
          <Label>SOP / FMEA</Label><div style={td}>{sari.steps.s7.sop || sari.steps.s7.fmea || "—"}</div>
        </StepPanel></div>

        <div data-panel="s8"><StepPanel title="S8 • Close & Recognize">
          <Row>{Object.entries(sari.steps.s8.checks).map(([k,v])=> (<div key={k}><Label>{k}</Label><div>{v?"✔":"—"}</div></div>))}</Row>
          <Label>Kommentar</Label><div style={td}>{sari.steps.s8.comment || "—"}</div>
        </StepPanel></div>
      </div>
    </>
  );
}

// ---- Shell Layout ----
function Layout({ children }) {
  return (
    <div style={{ display: "grid", gridTemplateColumns: "260px 1fr", minHeight: "100vh" }}>
      <aside style={{ background: "#0f1622", borderRight: "1px solid #223049", padding: 16, position: "sticky", top: 0, height: "100vh", overflow: "auto" }}>
        <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 8 }}>
          <div style={{ width: 26, height: 26, borderRadius: 6, background: "linear-gradient(135deg,#62e3b2,#4ab1ff)" }} />
          <div>
            <div style={{ fontWeight: 700 }}>SARI Governance</div>
            <div style={{ fontSize: 12, color: "#9aacc0" }}>Pitch Prototype</div>
          </div>
        </div>
        <div style={{ display:"grid", gap:6, marginTop: 8 }}>
          <a href="#/" style={navLinkStyle}>🏠 Dashboard</a>
        </div>
        <div style={{ marginTop: 14, display: "flex", gap: 8, flexWrap: "wrap" }}>
          {/* Buttons can be wired if we add edit mode later */}
        </div>
      </aside>
      <main style={{ padding: 18 }}>{children}</main>
    </div>
  );
}
const navLinkStyle = { color: "#e8eef6", textDecoration: "none", padding: "8px 12px", borderRadius: 10, border: "1px solid #2c3a4f", background: "#1a2332", display:"inline-block" };

// ---- App ----
export default function App(){
  const [route, go] = useRouter();
  const [list, setList] = useState(demoSARIs);

  const openSari = (s) => go(`#/sari/${s.id}`);
  const sari = route.page === "sari" ? list.find(x=> x.id === route.id) : null;

  return (
    <Layout>
      {route.page === "dashboard" && (
        <Dashboard list={list} onOpen={openSari} />
      )}
      {route.page === "sari" && sari && (
        <>
          <Card>
            <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center" }}>
              <div>
                <div style={{ fontSize:18, fontWeight:800 }}>{sari.id}</div>
                <div style={{ color: "#9ab0c6", fontSize:12 }}>ATA {sari.meta?.ata || "—"} • SIM {sari.meta?.sim || "—"}</div>
              </div>
              <div style={{ display:"flex", gap:8, alignItems:"center" }}>
                <Chip tone="info">{sari.level}</Chip>
                <Chip tone="muted">RPN {computeRPN(sari.sod)}</Chip>
                <Chip tone="muted">Status {sari.status}</Chip>
              </div>
            </div>
          </Card>
          <div style={{ height: 10 }} />
          <Card>
            <Timeline sari={sari} />
          </Card>
          <div style={{ height: 10 }} />
          <SariCoreLane sari={sari} />
        </>
      )}
      {route.page === "sari" && !sari && (
        <Card>Unbekanntes SARI.</Card>
      )}
    </Layout>
  );
}
