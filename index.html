<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SARI Governance ‚Äì Single‚ÄëFile (GitHub Pages)</title>
  <style>
    :root{--bg:#0b1220;--panel:#131a24;--line:#263142;--ink:#e8eef6;--muted:#9ab0c6;--chip:#1a2332;--chip-warn:#3a2a10;--chip-ok:#0f2a22;--chip-info:#1a2438;--chip-ink:#9bb0c7;--chip-warn-ink:#f6d18b;--chip-ok-ink:#9fe6cb;--chip-info-ink:#a9c4ff;--accent1:#4ab1ff;--accent2:#62e3b2;--danger:#ff6b6b;--warn:#f6d18b;--ok:#83f3c7}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .grid{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
    aside{background:#0f1622;border-right:1px solid #223049;padding:16px;position:sticky;top:0;height:100vh;overflow:auto}
    main{padding:18px}
    .brand{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .brand .logo{width:26px;height:26px;border-radius:6px;background:linear-gradient(135deg,var(--accent2),var(--accent1))}
    .nav a{color:var(--ink);text-decoration:none;padding:8px 12px;border-radius:10px;border:1px solid #2c3a4f;background:#1a2332;display:inline-block}
    .row{display:grid;gap:12px;margin-bottom:12px}
    .row.c2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .row.c3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .row.c4{grid-template-columns:repeat(4,minmax(0,1fr))}
    .row.c5{grid-template-columns:repeat(5,minmax(0,1fr))}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
    .kpi .l{color:#93a4b6;font-size:12px;text-transform:uppercase;letter-spacing:.06em}
    .kpi .v{font-size:22px;font-weight:800}
    .kpi .s{font-size:12px;color:#93a4b6}
    .lab{color:#91a2b2;font-size:12px;display:block;margin-bottom:4px}
    .chip{font-size:12px;padding:3px 8px;border-radius:999px;background:var(--chip);color:var(--chip-ink);border:1px solid #2a3750;display:inline-block}
    .chip.warn{background:var(--chip-warn);color:var(--chip-warn-ink)}
    .chip.ok{background:var(--chip-ok);color:var(--chip-ok-ink)}
    .chip.info{background:var(--chip-info);color:var(--chip-info-ink)}
    .td{padding:8px;background:#131a24;border:1px solid #263142;border-radius:8px}
    .tile{cursor:pointer}
    .timeline{display:flex;gap:16px;overflow:auto;padding:6px 2px}
    .timeline .n{min-width:100px;cursor:pointer}
    .timeline .d{width:12px;height:12px;border-radius:999px;background:#9ab0c6;margin-bottom:6px}
    .timeline .d.ms{background:#a9c4ff}
    .timeline .d.over{background:#ffcc66}
    .lane{display:flex;gap:12px;overflow:auto;padding-top:8px}
    .p{min-width:340px}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2b3647;background:#0e1420;color:#e8eef6}
    textarea{min-height:100px}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th{text-align:left;padding:8px;color:#93a4b6;font-size:12px}
    .qg{font-size:12px;margin-bottom:6px}
    .ok{color:#9fe6cb}
    .open{color:#f6d18b}
    .muted{color:var(--muted)}
    .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .actions{display:flex;gap:8px;align-items:center}
    .help{cursor:pointer;border:1px solid #2a3750;border-radius:999px;background:#1a2332;color:#a9c4ff;width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-weight:900}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
    .modal.open{display:flex}
    .modal .box{background:#0f1622;border:1px solid #223049;border-radius:12px;max-width:880px;width:92%;padding:16px;color:#e8eef6}
    .box h3{margin:0 0 8px 0}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .lvl{border:1px solid #223049;border-radius:10px;padding:10px}
    .lvl h4{margin:0 0 8px 0;color:#a9c4ff}
    .lvl ul{margin:0;padding-left:18px}
    .lvl li{margin:6px 0}
    .tick{font-weight:800;margin-right:6px}
  </style>
</head>
<body>
  <div class="grid">
    <aside>
      <div class="brand"><div class="logo"></div><div><div style="font-weight:700">SARI Governance</div><div style="font-size:12px;color:#9aacc0">Pitch Prototype</div></div></div>
      <div class="nav"><a href="#/">üè† Dashboard</a></div>
    </aside>
    <main id="app"></main>
  </div>

  <!-- Global modal -->
  <div id="modal" class="modal"><div class="box"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><h3 id="modalTitle">Checklist</h3><span id="modalClose" class="help" title="Schlie√üen">√ó</span></div><div id="modalBody"></div></div></div>

<script>
// ===== Pure JS (kein React/kein Build) =====
const addDays=(iso,d)=>{if(!iso)return null;const t=new Date(iso);const x=new Date(t.getTime());x.setDate(t.getDate()+d);return x.toISOString().slice(0,10)};
const todayISO=()=>new Date(Date.now()).toISOString().slice(0,10);
const daysBetween=(a,b)=>{if(!a||!b)return null;const A=new Date(a),B=new Date(b);return Math.round((B-A)/(24*3600*1000))};
const deltaFromToday=t=>t?daysBetween(todayISO(),t):null;
const el=(tag,attrs={},...kids)=>{const n=document.createElement(tag);for(const[k,v]of Object.entries(attrs)){if(k==='class')n.className=v;else if(k==='style')Object.assign(n.style,v);else if(k.startsWith('on'))n.addEventListener(k.slice(2),v);else n.setAttribute(k,v)};kids.forEach(c=>{if(c==null)return;if(typeof c==='string')n.appendChild(document.createTextNode(c));else n.appendChild(c)});return n};
const computeRPN=sod=>(+sod.s||0)*(+sod.o||0)*(+sod.d||0);

// ===== Canon QG (Requirements in place) =====
function QG(step,sari){
  const S0=()=> step.s0 && step.s0.customer_informed_on && step.s0.first_event_date && daysBetween(step.s0.first_event_date,step.s0.customer_informed_on)<=3 && !!step.s0.containment_action_plan && !!step.s0.line_stop===true && within(step.s0.first_event_date,step.s0.wip_check_on,3) && within(step.s0.first_event_date,step.s0.quarantine_on,3);
  const S1=()=> step.s1 && step.s1.leader && step.s1.sponsor && step.s1.problem_owner && step.s1.operations_rep && within(sari.day1,step.s1.kickoff_on,5) && !!step.s1.skills_matrix;
  const S2=()=> step.s2 && step.s2.issue_description && step.s2.fiveWtwoH && (!step.s2.complex_case || (step.s2.complex_case && step.s2.is_is_not)) && step.s2.problem_statement && !/\b(fix|l√∂sen|solution|workaround)\b/i.test(step.s2.issue_description);
  const S3=()=> step.s3 && step.s3.containment_validation_report && (step.s3.traceability_report_toac || step.s3.traceability_alt) && step.s3.curative_actions_done===true;
  const rpn=computeRPN(sari.sod);
  const S4=()=> step.s4 && step.s4.rc1_occurrence && step.s4.rc2_non_detection && ((sari.level==='L1'||rpn>=300)?!!step.s4.rc3_systemic:true) && (step.s4.rc_evidence && step.s4.rc_evidence.length>0) && step.s4.ishikawa_used===true && step.s4.pfmea_checked===true;
  const S5=()=>{const a=step.s5?.pca||[];if(a.length===0)return false;const has={RC1:false,RC2:false,RC3:false};const need={RC1:!!sari.steps.s4.rc1_occurrence,RC2:!!sari.steps.s4.rc2_non_detection,RC3:!!sari.steps.s4.rc3_systemic};for(const p of a){if(!(p.action&&p.owner&&p.due_date&&p.effectiveness_metric&&p.rc_link))return false;if(has[p.rc_link]!==undefined)has[p.rc_link]=true;}return (!need.RC1||has.RC1)&&(!need.RC2||has.RC2)&&(!need.RC3||has.RC3)&& (!!step.s5.nd_actions_multilevel||true) };
  const Dry=()=> step.dry && step.dry.id_card_ready && step.dry.pca_plan_consistent && step.dry.demo_artifacts && step.dry.open_risks_listed;
  const S6=()=>{const L=step.s6?.pca_effectiveness||[];if(L.length===0)return false;return L.every(e=>e.implemented===true&&e.effective===true&&!!e.effectiveness_evidence)};
  const PP =()=> step.pp && step.pp.ppm_review_green && step.pp.risks_documented && step.pp.pp_pack_ready;
  const S7=()=> step.s7 && step.s7.sop_updated && ((sari.level==='L1'||rpn>=300)? step.s7.fmea_updated : true) && step.s7.look_across;
  const S8=()=> step.s8 && step.s8.checks && step.s8.checks.each_action_effective && step.s8.checks.docs_complete && step.s8.checks.lessons_integrated && step.s8.checks.five_why_valid;
  return {S0:S0(),S1:S1(),S2:S2(),S3:S3(),S4:S4(),S5:S5(),Dry:Dry(),S6:S6(),PP:PP(),S7:S7(),S8:S8()}
}
function progress(s){const qg=QG(s.steps,s);const arr=Object.values(qg);return Math.round(arr.filter(Boolean).length/arr.length*100)}
function within(ref,ts,days){if(!ref||!ts)return false;const d=daysBetween(ref,ts);return d!=null&&d<=days}

// ===== Maturity per Level (1..5) for Checklist & Guidance =====
function maturityFor(stepKey,s){
  const st=s.steps;
  const L=(lvl,items)=>({lvl,items});
  const I=(label,ok)=>({label,ok});
  switch(stepKey){
    case 's0':{
      const S0=st.s0||{};const d=daysBetween(S0.first_event_date,S0.customer_informed_on);
      return [
        L(2,[
          I('WIP/Stocks gepr√ºft ‚â§3 Tage', within(S0.first_event_date,S0.wip_check_on,3)),
          I('Non‚Äëconforming Teile quarantiniert ‚â§3 Tage', within(S0.first_event_date,S0.quarantine_on,3)),
          I('Kunde ‚â§7 Tage informiert', d!=null && d<=7)
        ]),
        L(3,[
          I('Formaler Containment‚ÄëPlan vorhanden', !!S0.containment_action_plan)
        ]),
        L(4,[
          I('Linie sofort gestoppt', !!S0.line_stop),
          I('Kunde ‚â§3 Tage informiert', d!=null && d<=3)
        ]),
        L(5,[
          I('Produktion mit wirksamer Eind√§mmung ‚â§24h wieder gestartet', within(S0.first_event_date,S0.restart_on,1))
        ])
      ]}
    case 's1':{
      const S1=st.s1||{};
      return [
        L(2,[ I('MFT benannt (Leader, Sponsor, Problem Owner, Ops)', !!(S1.leader&&S1.sponsor&&S1.problem_owner&&S1.operations_rep)) ]),
        L(3,[ I('Operations im Team vertreten', !!S1.operations_rep) ]),
        L(4,[ I('Kick‚Äëoff ‚â§5 Tage ab Day‚Äë1', within(s.day1,S1.kickoff_on,5)), I('Skills‚ÄëMatrix vorhanden', !!S1.skills_matrix) ]),
        L(5,[ I('Lieferant integriert (falls relevant)', !!S1.supplier_integrated) ])
      ]}
    case 's2':{
      const S2=st.s2||{};const okIs=!S2.complex_case||!!S2.is_is_not;
      return [
        L(2,[ I('1 Objekt / 1 Defekt', !!S2.issue_description) ]),
        L(3,[ I('5W2H abgeschlossen', !!S2.fiveWtwoH) ]),
        L(4,[ I('Problem Statement (Synthese) vorhanden', !!S2.problem_statement), I('IS/IS NOT bei komplexen F√§llen', okIs) ]),
        L(5,[ I('Prozess‚ÄëWorkflow bis Lieferung dokumentiert', !!S2.process_workflow) ])
      ]}
    case 's3':{
      const S3=st.s3||{};
      return [
        L(2,[ I('Eind√§mmung implementiert', !!S3.containment_validation_report) ]),
        L(3,[ I('Wirksamkeit nachgewiesen (intern)', !!S3.containment_validation_report) ]),
        L(4,[ I('Vollst√§ndige Traceability (TOAC/alt.)', !!(S3.traceability_report_toac||S3.traceability_alt)), I('Curatives umgesetzt', S3.curative_actions_done===true) ]),
        L(5,[ I('Wirksamkeit fortlaufend √ºberwacht', !!S3.continuous_review) ])
      ]}
    case 's4':{
      const S4=st.s4||{};const needSys=(s.level==='L1'||computeRPN(s.sod)>=300);
      return [
        L(2,[ I('Trennung RC1/RC2', !!(S4.rc1_occurrence&&S4.rc2_non_detection)) ]),
        L(3,[ I('5‚ÄëWhys/Why‚ÄëTree vorhanden', !!S4.why_tree) ]),
        L(4,[ I('Ishikawa genutzt', S4.ishikawa_used===true), I('RC(s) per Evidenz belegt', (S4.rc_evidence||[]).length>0), I('Systemische RC identifiziert (Top Irritant)', !needSys || !!S4.rc3_systemic), I('PFMEA gepr√ºft', S4.pfmea_checked===true) ]),
        L(5,[ I('Methodik passend gew√§hlt (DoE/Shainin/KTs)', !!S4.advanced_method) ])
      ]}
    case 's5':{
      const S5=st.s5||{};const a=S5.pca||[];const hasRC=(rc)=>a.some(p=>p.rc_link===rc);
      return [
        L(2,[ I('Owner & Termin je Ma√ünahme gesetzt', a.every(p=>p.owner&&p.due_date)) ]),
        L(3,[ I('RC‚ÄëAbdeckung: RC1/RC2 (RC3 wenn vorhanden)', hasRC('RC1') && hasRC('RC2') && (!st.s4?.rc3_systemic || hasRC('RC3'))) ]),
        L(4,[ I('Nicht‚ÄëErkennung an allen Stufen adressiert', !!S5.nd_actions_multilevel) ]),
        L(5,[ I('Erfolgskriterien je Ma√ünahme definiert', a.every(p=>!!p.effectiveness_metric)), I('Risikoanalyse der Ma√ünahmen vorhanden', !!S5.risk_analysis_done) ])
      ]}
    case 's6':{
      const S6=st.s6||{};const Lst=S6.pca_effectiveness||[];
      return [
        L(3,[ I('100% der geplanten Ma√ünahmen implementiert', Lst.every(e=>e.implemented===true)) ]),
        L(4,[ I('Wirksamkeit statistisch belegt', Lst.every(e=>e.effective===true && !!e.effectiveness_evidence)) ]),
        L(5,[ I('Containment erst nach Wirksamkeit geschlossen', !!S6.containment_closed_post_effectiveness) ])
      ]}
    case 's7':{
      const S7=st.s7||{};return [ L(3,[ I('SOP/CP aktualisiert', !!S7.sop_updated) ]), L(4,[ I('FMEA aktualisiert (Top Irritants Pflicht)', (s.level!=='L1'&&computeRPN(s.sod)<300) || !!S7.fmea_updated) ]), L(5,[ I('Look‚ÄëAcross / Lessons Learned & Supplier Pr√§vention', !!S7.look_across) ]) ]}
    case 's8':{
      const C=st.s8?.checks||{};return [ L(4,[ I('Alle Ma√ünahmen wirksam', !!C.each_action_effective), I('Dokumente vollst√§ndig', !!C.docs_complete), I('Lessons Learned integriert', !!C.lessons_integrated), I('5‚ÄëWhys valide', !!C.five_why_valid) ]), L(5,[ I('Methodik‚ÄëSelbstbewertung durchgef√ºhrt', !!st.s8?.method_eval_done) ]) ]}
  }
  return []
}
function maturityLevel(stepKey,s){
  const lvls=maturityFor(stepKey,s);let lvl=0;for(const L of lvls){if(L.items.every(it=>it.ok)) lvl=L.lvl; else break}return {lvl,lvls}
}

// ===== Data =====
function mkSari(id,level,day1,sod,meta={}){
  return {id,level,day1,sod,meta,
    milestones:{dryRun:{target:addDays(day1,60)},pp:{target:addDays(day1,100)}},status:'Open',
    steps:{
      s0:{first_event_date:day1,customer_informed_on:day1,line_stop:false,containment_action_plan:{name:'plan.pdf'},wip_check_on:null,quarantine_on:null,restart_on:null},
      s1:{leader:'',sponsor:'',problem_owner:'',operations_rep:'',mft_members:[],kickoff_on:null,skills_matrix:null,supplier_integrated:false},
      s2:{issue_description:'',fiveWtwoH:'',complex_case:false,is_is_not:'',supply_chain_breakdown:'',problem_statement:'',process_workflow:''},
      s3:{containment_validation_report:null,traceability_report_toac:null,traceability_alt:null,curative_actions_done:false,continuous_review:false},
      s4:{rc1_occurrence:'',rc2_non_detection:'',rc3_systemic:'',rc_evidence:[],ishikawa_used:false,pfmea_checked:false,why_tree:false,advanced_method:false},
      s5:{pca:[],nd_actions_multilevel:false,risk_analysis_done:false},
      dry:{id_card_ready:false,pca_plan_consistent:false,demo_artifacts:false,open_risks_listed:false},
      s6:{pca_effectiveness:[],containment_closed_post_effectiveness:false},
      pp:{ppm_review_green:false,risks_documented:false,pp_pack_ready:false},
      s7:{sop_updated:null,fmea_updated:null,look_across:null},
      s8:{checks:{each_action_effective:false,docs_complete:false,lessons_integrated:false,five_why_valid:false},customer_closure_comm:null,closure_comment:'',method_eval_done:false}
    }
  }
}
const DB=[
  mkSari('SE-25.0123','L1','2025-09-01',{s:8,o:5,d:9},{title:'GEN-004 Incorrect Assembly ‚Äì hinge bracket'}),
  mkSari('SE-25.0456','L2','2025-08-30',{s:6,o:6,d:6},{title:'GEN-010 Torque issue ‚Äì fasteners'}),
  mkSari('SE-25.0789','L3','2025-10-01',{s:4,o:5,d:7},{title:'GEN-001 FOD ‚Äì wiring bay'}),
  mkSari('SE-25.0999','L2','2025-07-20',{s:7,o:7,d:7},{title:'GEN-012 Corrosion ‚Äì panel'})
];
DB[0].steps.s2.issue_description='1 object / 1 defect: hinge mis-assembly on LH door';
DB[0].steps.s5.pca=[
  {action:'Introduce Poka-Yoke',owner:'Ops',due_date:'2025-10-12',rc_link:'RC2',effectiveness_metric:'Cpk >=1.33',status:'In Arbeit'},
  {action:'Revise SOP 27-14',owner:'QE',due_date:'2025-10-20',rc_link:'RC3',effectiveness_metric:'Audit=0 NC',status:'Offen'}
];

// ===== Urgency / Tiles =====
function urgencyTuple(s){const lvl=s.level==='L1'?3:s.level==='L2'?2:1;const dDry=deltaFromToday(s.milestones.dryRun?.target)??9999;const dPP=deltaFromToday(s.milestones.pp?.target)??9999;const rpn=computeRPN(s.sod);const overdue=(s.steps.s5.pca||[]).filter(p=>p.due_date&&p.status!=='Erledigt'&&p.due_date<todayISO()).length;return[-lvl,(dDry>=0?dDry:dDry*2),(dPP>=0?dPP:dPP*1.5),-rpn,-overdue]}
function cmp(a,b){for(let i=0;i<Math.max(a.length,b.length);i++){const d=(a[i]||0)-(b[i]||0);if(d!==0)return d}return 0}

// ===== Render =====
function kpi(l,v,s){const r=el('div',{class:'card kpi'});r.append(el('div',{class:'l'},l),el('div',{class:'v'},String(v)));if(s)r.append(el('div',{class:'s'},s));return r}
function chip(txt,tone){return el('span',{class:'chip '+(tone||'')},txt)}

function renderDashboard(){
  const wrap=el('div');
  const open=DB.filter(s=>s.status!=='Closed').length;
  const overdueMs=DB.filter(s=>(deltaFromToday(s.milestones.dryRun?.target)??1)<0||(deltaFromToday(s.milestones.pp?.target)??1)<0).length;
  const avgDry=Math.round(DB.reduce((a,s)=>a+(deltaFromToday(s.milestones.dryRun?.target)??0),0)/Math.max(1,DB.length));
  const avgPP=Math.round(DB.reduce((a,s)=>a+(deltaFromToday(s.milestones.pp?.target)??0),0)/Math.max(1,DB.length));
  const topIrr=DB.filter(s=>s.level==='L1'||computeRPN(s.sod)>=300).length;
  const row=el('div',{class:'row c5'});
  row.append(kpi('Open SARIs',open),kpi('Overdue Milestones',overdueMs),kpi('√ò Days to Dry Run',avgDry),kpi('√ò Days to PP',avgPP),kpi('Top Irritants',topIrr));
  wrap.append(row);

  const sorted=[...DB].sort((a,b)=>cmp(urgencyTuple(a),urgencyTuple(b)));
  const grid=el('div',{class:'row c3',style:{gap:'16px'}});
  sorted.forEach(s=>grid.append(tile(s)));
  wrap.append(grid);
  return wrap
}

function tile(s){
  const rpn=computeRPN(s.sod);const prog=progress(s);
  const dDry=deltaFromToday(s.milestones.dryRun?.target);const dPP=deltaFromToday(s.milestones.pp?.target);
  const dryTxt=dDry==null?'‚Äî':dDry<0?`DRY RUN ${Math.abs(dDry)}d overdue`:`DRY RUN in ${dDry}d`;
  const ppTxt=dPP==null?'‚Äî':dPP<0?`PP ${Math.abs(dPP)}d overdue`:`PP in ${dPP}d`;
  const overdue=(s.steps.s5.pca||[]).filter(p=>p.due_date&&p.status!=='Erledigt'&&p.due_date<todayISO()).length;
  const card=el('div',{class:'card tile'});
  card.addEventListener('click',()=>location.hash=`#/sari/${s.id}`);
  const head=el('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'8px'}});
  head.append(el('div',{style:{fontWeight:'800'}},s.id));
  const badges=el('div',{style:{display:'flex',gap:'8px',alignItems:'center'}});
  badges.append(chip(s.level,'info')); if(s.level==='L1'||rpn>=300)badges.append(chip('Top Irritant','warn'));
  head.append(badges); card.append(head);
  card.append(el('div',{class:'muted'}, s.meta?.title || s.steps?.s2?.issue_description || '‚Äî'));
  const row=el('div',{class:'row c3',style:{marginTop:'8px'}});
  const b1=el('div'); b1.append(el('label',{class:'lab'},'RPN'), el('div',{style:{fontWeight:'700'}},String(rpn)), el('div',{class:'muted',style:{fontSize:'12px'}},`S/O/D ${s.sod.s}/${s.sod.o}/${s.sod.d}`));
  const b2=el('div'); b2.append(el('label',{class:'lab'},'Fortschritt'), el('div',{style:{fontWeight:'700'}},`${prog}%`));
  const b3=el('div'); b3.append(el('label',{class:'lab'},'Overdue Aktionen'), el('div',{style:{fontWeight:'700'}},String(overdue)));
  row.append(b1,b2,b3); card.append(row);
  const chips=el('div',{class:'row c2'});
  chips.append(el('div',{},chip(dryTxt,dDry<0?'warn':'info'))); chips.append(el('div',{},chip(ppTxt,dPP<0?'warn':'info')));
  card.append(chips);
  return card
}

function timeline(s){
  const nodes=[{id:'s0',label:'S0'},{id:'s1',label:'S1'},{id:'s2',label:'S2'},{id:'s3',label:'S3'},{id:'s4',label:'S4'},{id:'s5',label:'S5'},{id:'dry',label:'Dry Run',ms:true,target:s.milestones.dryRun?.target},{id:'s6',label:'S6'},{id:'pp',label:'PP',ms:true,target:s.milestones.pp?.target},{id:'s7',label:'S7'},{id:'s8',label:'S8'}];
  const bar=el('div',{class:'timeline'});
  nodes.forEach(n=>{const d=n.ms?deltaFromToday(n.target):null;const node=el('div',{class:'n'});const dot=el('div',{class:'d '+(n.ms?'ms':'')+' '+(d!=null&&d<0?'over':'')});node.append(dot,el('div',{style:{fontWeight:n.ms?800:600}},n.label));if(n.ms)node.append(el('div',{class:'muted',style:{fontSize:'12px'}},n.target||'‚Äî'));node.addEventListener('click',()=>document.querySelector(`[data-panel="${n.id}"]`)?.scrollIntoView({behavior:'smooth',inline:'start',block:'nearest'}));bar.append(node)});
  return bar
}

function panel(title,id,key,s){
  const p=el('div',{class:'card p','data-panel':id});
  const hdr=el('div',{class:'head'});
  hdr.append(el('div',{style:{fontWeight:'700'}},title));
  const act=el('div',{class:'actions'});
  if(key){const hb=el('span',{class:'help',title:'Maturity‚ÄëCheck (Levels 1‚Äì5)',onclick:()=>openChecklist(key,s)},'?');act.append(hb)}
  hdr.append(act); p.append(hdr);
  return p
}
function qg(ok){return el('div',{class:'qg '+(ok?'ok':'open')}, ok?'Requirements OK':'Requirements offen')}
function f(label,input){const w=el('div');w.append(el('label',{class:'lab'},label),input);return w}
function iText(val,on){const i=el('input',{value:val||''});i.addEventListener('input',e=>on(e.target.value));return i}
function iDate(val,on){const i=el('input',{type:'date',value:val||''});i.addEventListener('input',e=>on(e.target.value));return i}
function iArea(val,on){const i=el('textarea',{});i.value=val||'';i.addEventListener('input',e=>on(e.target.value));return i}
function iCheck(val,on,label){const l=el('label',{style:{display:'flex',gap:'8px',alignItems:'center',marginTop:'6px'}});const i=el('input',{type:'checkbox'});i.checked=!!val;i.addEventListener('change',e=>on(!!e.target.checked));l.append(i,document.createTextNode(label));return l}

function maturityBadge(stepKey,s){const {lvl,lvls}=maturityLevel(stepKey,s);const b=el('div',{class:'muted',style:{fontSize:'12px',margin:'6px 0'}});b.append(chip(`Maturity: L${lvl}/${lvls.length||5}`,'info')); const needTo4=(lvls.find(L=>L.lvl===4)||{items:[]}).items.filter(it=>!it.ok).map(it=>it.label); if(needTo4.length){b.append(el('div',{class:'muted',style:{marginTop:'4px'}},'‚Üí Fehlt zu L4: '+needTo4.join('; ')))} return b}

function openChecklist(stepKey,s){
  const m=document.getElementById('modal');const body=document.getElementById('modalBody');const title=document.getElementById('modalTitle');
  const {lvls,lvl}=maturityLevel(stepKey,s);
  title.textContent=`Maturity‚ÄëChecklist ${stepKey.toUpperCase()} (aktuell L${lvl})`;
  body.innerHTML='';
  const grid=el('div',{class:'grid-2'});
  lvls.forEach(L=>{
    const box=el('div',{class:'lvl'});
    box.append(el('h4',{},`Level ${L.lvl}`));
    const ul=el('ul');
    L.items.forEach(it=>ul.append(el('li',{}, el('span',{class:'tick',style:{color:it.ok?varOk():varWarn()}}, it.ok?'‚úì':'‚Ä¢'), it.label)));
    box.append(ul); grid.append(box);
  });
  body.append(grid);
  m.classList.add('open');
}
function varOk(){return '#9fe6cb'}; function varWarn(){return '#a9c4ff'}
const modalClose=()=>document.getElementById('modal').classList.remove('open');
window.addEventListener('click',e=>{if(e.target.id==='modal') modalClose()});
document.getElementById('modalClose').addEventListener('click',modalClose);

function renderDetail(s){
  const wrap=el('div');
  const head=el('div',{class:'card'});
  const top=el('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center'}});
  const left=el('div');left.append(el('div',{style:{fontSize:'18px',fontWeight:'800'}},s.id),el('div',{class:'muted',style:{fontSize:'12px'}},`ATA ${s.meta?.ata||'‚Äî'} ‚Ä¢ SIM ${s.meta?.sim||'‚Äî'}`));
  const right=el('div',{style:{display:'flex',gap:'8px',alignItems:'center'}});right.append(chip(s.level,'info'),chip('RPN '+computeRPN(s.sod)),chip('Status '+s.status));
  top.append(left,right); head.append(top); wrap.append(head);
  wrap.append(el('div',{style:{height:'10px'}})); wrap.append(el('div',{class:'card'}, timeline(s))); wrap.append(el('div',{style:{height:'10px'}}));

  const lane=el('div',{class:'lane'});
  // S0
  const p0=panel('S0 ‚Ä¢ Containment','s0','s0',s);const S0=s.steps.s0; p0.append(qg(QG({s0:S0},s).S0)); p0.append(maturityBadge('s0',s)); p0.append(
    f('First Event', iDate(S0.first_event_date,v=>{S0.first_event_date=v; render()})),
    f('Kundeninfo', iDate(S0.customer_informed_on,v=>{S0.customer_informed_on=v; render()})),
    iCheck(!!S0.line_stop,v=>{S0.line_stop=v; render()},'Linie gestoppt'),
    f('WIP/Stocks gepr√ºft am', iDate(S0.wip_check_on,v=>{S0.wip_check_on=v; render()})),
    f('Quarant√§ne umgesetzt am', iDate(S0.quarantine_on,v=>{S0.quarantine_on=v; render()})),
    f('Containment‚ÄëPlan (Ref)', iText(S0.containment_action_plan?.name||'',v=>{S0.containment_action_plan=v?{name:v}:null; render()})),
    f('Restart (optional, ‚â§24h)', iDate(S0.restart_on,v=>{S0.restart_on=v; render()}))
  ); lane.append(p0);
  // S1
  const p1=panel('S1 ‚Ä¢ Team Charter','s1','s1',s);const S1=s.steps.s1; p1.append(qg(QG({s1:S1},s).S1)); p1.append(maturityBadge('s1',s)); p1.append(
    f('Leader',iText(S1.leader,v=>{S1.leader=v})), f('Sponsor',iText(S1.sponsor,v=>{S1.sponsor=v})), f('Problem Owner',iText(S1.problem_owner,v=>{S1.problem_owner=v})), f('Operations',iText(S1.operations_rep,v=>{S1.operations_rep=v})),
    f('Kick‚Äëoff Datum', iDate(S1.kickoff_on,v=>{S1.kickoff_on=v; render()})),
    f('Skills‚ÄëMatrix (Ref)', iText(S1.skills_matrix?.name||'',v=>{S1.skills_matrix=v?{name:v}:null; render()})),
    iCheck(!!S1.supplier_integrated,v=>{S1.supplier_integrated=v; render()},'Lieferant integriert (falls relevant)')
  ); lane.append(p1);
  // S2
  const p2=panel('S2 ‚Ä¢ Evidence Hub','s2','s2',s);const S2=s.steps.s2; p2.append(qg(QG({s2:S2},s).S2)); p2.append(maturityBadge('s2',s)); p2.append(
    f('Issue (1 Objekt/1 Defekt)', iArea(S2.issue_description,v=>{S2.issue_description=v})),
    f('5W2H', iArea(S2.fiveWtwoH,v=>{S2.fiveWtwoH=v})),
    iCheck(!!S2.complex_case,v=>{S2.complex_case=v; render()},'Komplexer Fall (IS/IS NOT Pflicht)'),
    ...(S2.complex_case?[ f('IS / IS NOT', iArea(S2.is_is_not,v=>{S2.is_is_not=v})) ]:[]),
    f('Problem Statement (Synthese)', iArea(S2.problem_statement,v=>{S2.problem_statement=v})),
    f('Prozess‚ÄëWorkflow (optional)', iArea(S2.process_workflow,v=>{S2.process_workflow=v}))
  ); lane.append(p2);
  // S3
  const p3=panel('S3 ‚Ä¢ Validate Containment','s3','s3',s);const S3=s.steps.s3; p3.append(qg(QG({s3:S3},s).S3)); p3.append(maturityBadge('s3',s)); p3.append(
    f('Validierungsbericht (Ref)', iText(S3.containment_validation_report?.name||'',v=>{S3.containment_validation_report=v?{name:v}:null; render()})),
    f('Traceability (TOAC/Alt)', iText(S3.traceability_report_toac?.name||S3.traceability_alt?.name||'',v=>{S3.traceability_report_toac=v?{name:v}:null; S3.traceability_alt=null; render()})),
    iCheck(!!S3.curative_actions_done,v=>{S3.curative_actions_done=v; render()},'Curatives umgesetzt'),
    iCheck(!!S3.continuous_review,v=>{S3.continuous_review=v; render()},'Wirksamkeit fortlaufend √ºberpr√ºft')
  ); lane.append(p3);
  // S4
  const p4=panel('S4 ‚Ä¢ RCA','s4','s4',s);const S4=s.steps.s4; p4.append(qg(QG({s4:S4},s).S4)); p4.append(maturityBadge('s4',s)); p4.append(
    iCheck(!!S4.ishikawa_used,v=>{S4.ishikawa_used=v; render()},'Ishikawa verwendet'),
    iCheck(!!S4.pfmea_checked,v=>{S4.pfmea_checked=v; render()},'PFMEA gepr√ºft'),
    iCheck(!!S4.why_tree,v=>{S4.why_tree=v; render()},'5‚ÄëWhys/Why‚ÄëTree dokumentiert'),
    f('RC1 (Occurrence)', iText(S4.rc1_occurrence,v=>{S4.rc1_occurrence=v})),
    f('RC2 (Non‚ÄëDetection)', iText(S4.rc2_non_detection,v=>{S4.rc2_non_detection=v})),
    f('RC3 (Systemic ‚Äì falls erforderlich)', iText(S4.rc3_systemic,v=>{S4.rc3_systemic=v})),
    (()=>{const ev=el('div'); ev.append(el('label',{class:'lab'},'Evidenzen'), (()=>{const b=el('button',{class:'chip'},'‚ûï Evidenz'); b.addEventListener('click',()=>{ (S4.rc_evidence=S4.rc_evidence||[]).push({name:`evidence-${(S4.rc_evidence.length||0)+1}.pdf`}); render(); }); return b; })() ); if(S4.rc_evidence?.length){const ul=el('ul'); S4.rc_evidence.forEach(e=>ul.append(el('li',{},e.name))); ev.append(ul);} return ev;})()
  ); lane.append(p4);
  // S5
  const p5=panel('S5 ‚Ä¢ Corrective Actions','s5','s5',s);const S5=s.steps.s5; p5.append(qg(QG({s5:S5},s).S5)); p5.append(maturityBadge('s5',s)); const addP=el('button',{class:'chip'},'‚ûï Ma√ünahme'); addP.addEventListener('click',()=>{(S5.pca=S5.pca||[]).push({action:'',owner:'',due_date:'',rc_link:'RC1',effectiveness_metric:'',status:'Offen'}); render()}); p5.append(addP); if((S5.pca||[]).length===0){p5.append(el('div',{class:'muted'},'Keine Ma√ünahmen erfasst.'))} else { const tbl=el('table'); const th=el('thead'); const trh=el('tr'); ['Ma√ünahme','Owner','F√§llig','RC','Metrik','Status'].forEach(h=>trh.append(el('th',{},h))); th.append(trh); tbl.append(th); const tb=el('tbody'); S5.pca.forEach((p,i)=>{ const tr=el('tr'); const rcSel=el('select',{}); ['RC1','RC2','RC3'].forEach(x=>rcSel.append(el('option',{value:x,selected:(p.rc_link||'RC1')===x},x))); rcSel.addEventListener('change',e=>{p.rc_link=e.target.value}); const stSel=el('select',{}); ['Offen','In Arbeit','Erledigt'].forEach(x=>stSel.append(el('option',{value:x,selected:(p.status||'Offen')===x},x))); stSel.addEventListener('change',e=>{p.status=e.target.value}); tr.append(el('td',{class:'td'}, iText(p.action,v=>{p.action=v})), el('td',{class:'td'}, iText(p.owner,v=>{p.owner=v})), el('td',{class:'td'}, iDate(p.due_date,v=>{p.due_date=v})), el('td',{class:'td'}, rcSel), el('td',{class:'td'}, iText(p.effectiveness_metric,v=>{p.effectiveness_metric=v})), el('td',{class:'td'}, stSel)); tb.append(tr); }); tbl.append(tb); p5.append(tbl); }
  p5.append(iCheck(!!S5.nd_actions_multilevel,v=>{S5.nd_actions_multilevel=v; render()},'Non‚ÄëDetection √ºber gesamte Supply Chain adressiert'), iCheck(!!S5.risk_analysis_done,v=>{S5.risk_analysis_done=v; render()},'Risikoanalyse der Ma√ünahmen durchgef√ºhrt')); lane.append(p5);
  // Dry Run
  const pDry=panel('Milestone ‚Ä¢ Dry Run (‚â§60d)','dry','dry',s);const DR=s.steps.dry; pDry.append(qg(QG({dry:DR},s).Dry)); pDry.append(
    f('Zieltermin', el('div',{class:'td'}, s.milestones.dryRun?.target||'‚Äî')),
    iCheck(!!DR.id_card_ready,v=>{DR.id_card_ready=v},'ID‚ÄëCard vorhanden'),
    iCheck(!!DR.pca_plan_consistent,v=>{DR.pca_plan_consistent=v},'PCA‚ÄëPlan konsistent'),
    iCheck(!!DR.demo_artifacts,v=>{DR.demo_artifacts=v},'Demo‚ÄëArtefakte vorhanden'),
    iCheck(!!DR.open_risks_listed,v=>{DR.open_risks_listed=v},'Offene Risiken gelistet')
  ); lane.append(pDry);
  // S6
  const p6=panel('S6 ‚Ä¢ Implement & Effectiveness','s6','s6',s);const S6=s.steps.s6; p6.append(qg(QG({s6:S6},s).S6)); p6.append(maturityBadge('s6',s)); const addE=el('button',{class:'chip'},'‚ûï Wirksamkeitsnachweis'); addE.addEventListener('click',()=>{(S6.pca_effectiveness=S6.pca_effectiveness||[]).push({pca_index:0,implemented:false,effective:false,effectiveness_evidence:{name:'evidence.pdf'}}); render()}); p6.append(addE); if((S6.pca_effectiveness||[]).length===0){p6.append(el('div',{class:'muted'},'Noch keine Wirksamkeitsnachweise.'))} else {const ul=el('ul'); S6.pca_effectiveness.forEach(e=>{ const li=el('li'); li.append(iCheck(!!e.implemented,v=>{e.implemented=v},'Implementiert'),' ', iCheck(!!e.effective,v=>{e.effective=v},'Wirksam'),' ', f('Evidenz', iText(e.effectiveness_evidence?.name||'',v=>{e.effectiveness_evidence=v?{name:v}:null}))); ul.append(li)}); p6.append(ul);} p6.append(iCheck(!!S6.containment_closed_post_effectiveness,v=>{S6.containment_closed_post_effectiveness=v},'Containment erst nach Wirksamkeit geschlossen')); lane.append(p6);
  // PP
  const ppp=panel('Milestone ‚Ä¢ PP (‚â§100d)','pp','pp',s);const PP=s.steps.pp; ppp.append(qg(QG({pp:PP},s).PP)); ppp.append(
    f('Zieltermin', el('div',{class:'td'}, s.milestones.pp?.target||'‚Äî')),
    iCheck(!!PP.ppm_review_green,v=>{PP.ppm_review_green=v},'PPM‚ÄëReview abgeschlossen'),
    iCheck(!!PP.risks_documented,v=>{PP.risks_documented=v},'Residualrisiken dokumentiert'),
    iCheck(!!PP.pp_pack_ready,v=>{PP.pp_pack_ready=v},'PP‚ÄëPack bereit')
  ); lane.append(ppp);
  // S7
  const p7=panel('S7 ‚Ä¢ Standardize & Prevent','s7','s7',s);const S7=s.steps.s7; p7.append(qg(QG({s7:S7},s).S7)); p7.append(maturityBadge('s7',s)); p7.append(
    f('SOP aktualisiert (Ref)', iText(S7.sop_updated?.name||'',v=>{S7.sop_updated=v?{name:v}:null; render()})),
    f('FMEA aktualisiert (Ref)', iText(S7.fmea_updated?.name||'',v=>{S7.fmea_updated=v?{name:v}:null; render()})),
    f('Look‚ÄëAcross / Lessons Learned', iArea(S7.look_across,v=>{S7.look_across=v}))
  ); lane.append(p7);
  // S8
  const p8=panel('S8 ‚Ä¢ Close & Recognize','s8','s8',s);const S8=s.steps.s8; p8.append(qg(QG({s8:S8},s).S8)); p8.append(maturityBadge('s8',s)); const c=S8.checks; p8.append(
    iCheck(!!c.each_action_effective,v=>{c.each_action_effective=v},'Wirksamkeit je Ma√ünahme belegt'),
    iCheck(!!c.docs_complete,v=>{c.docs_complete=v},'Dokumente vollst√§ndig'),
    iCheck(!!c.lessons_integrated,v=>{c.lessons_integrated=v},'Lessons Learned integriert'),
    iCheck(!!c.five_why_valid,v=>{c.five_why_valid=v},'5‚ÄëWhys zeigen tats√§chliche RC'),
    f('Kundenkommunikation (Ref)', iText(S8.customer_closure_comm?.name||'',v=>{S8.customer_closure_comm=v?{name:v}:null})),
    f('Abschluss‚ÄëKommentar', iArea(S8.closure_comment,v=>{S8.closure_comment=v})),
    iCheck(!!s.steps.s8.method_eval_done,v=>{s.steps.s8.method_eval_done=v},'Selbst‚ÄëBewertung der 9S‚ÄëMethodik durchgef√ºhrt')
  ); lane.append(p8);

  wrap.append(lane);
  const kp=el('div',{class:'row c4'});
  kp.append(kpi('RPN', computeRPN(s.sod), `S/O/D ${s.sod.s}/${s.sod.o}/${s.sod.d}`));
  kp.append(kpi('Fortschritt 9S', progress(s)+'%'));
  const dDry=deltaFromToday(s.milestones.dryRun?.target); const dPP=deltaFromToday(s.milestones.pp?.target);
  kp.append(kpi('Dry Run', (s.milestones.dryRun?.target||'‚Äî'), dDry==null?'‚Äî':(dDry<0?`overdue ${Math.abs(dDry)}d`:`in ${dDry}d`)));
  kp.append(kpi('PP', (s.milestones.pp?.target||'‚Äî'), dPP==null?'‚Äî':(dPP<0?`overdue ${Math.abs(dPP)}d`:`in ${dPP}d`)));
  wrap.append(kp);
  return wrap;
  function render(){ renderApp(); }
}

function renderApp(){
  const app=document.getElementById('app'); app.innerHTML='';
  const hash=location.hash.replace(/^#\/?/,''); const seg=hash.split('/');
  if(!hash||seg[0]===''||seg[0]==='dashboard'){ app.append(renderDashboard()); return; }
  if(seg[0]==='sari'&&seg[1]){ const s=DB.find(x=>x.id===seg[1]); app.append(s?renderDetail(s):el('div',{class:'card'},'Unbekanntes SARI.')); return; }
  app.append(renderDashboard());
}
window.addEventListener('hashchange',renderApp);
renderApp();
</script>
</body>
</html>
