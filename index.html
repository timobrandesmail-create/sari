<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SARI Governance Tool ‚Äì Prototype v1.0</title>
<style>
  :root{
    --bg:#0c0f14;--panel:#151a22;--ink:#e6ebf1;--muted:#a7b0be;--brand:#5ee3b2;
    --warn:#ffcc66;--danger:#ff6b6b;--ok:#63e6be;--link:#7ab0ff;--grid:#2a3140;
    --accent:#c8e6ff;--chip:#202734;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0a0d12,#0f141c);color:var(--ink);
       font:15px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  a{color:var(--link);text-decoration:none}
  a:hover{text-decoration:underline}
  .app{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
  aside{background:var(--panel);border-right:1px solid var(--grid);padding:16px;position:sticky;top:0;height:100vh;overflow:auto}
  main{padding:16px 24px 120px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--brand),#44b6ff)}
  h1{font-size:18px;margin:0}
  .sub{color:var(--muted);font-size:12px}
  .navsec{margin-top:16px}
  .navsec h3{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin:18px 0 8px}
  .nav button{display:flex;align-items:center;gap:10px;width:100%;padding:10px 12px;margin:4px 0;
    background:transparent;border:1px solid transparent;color:var(--ink);border-radius:10px;cursor:pointer}
  .nav button.active{background:var(--chip);border-color:var(--grid)}
  .chip{background:var(--chip);padding:3px 8px;border-radius:999px;font-size:12px;color:var(--muted);border:1px solid var(--grid)}
  .kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-bottom:16px}
  .card{background:var(--panel);border:1px solid var(--grid);border-radius:14px;padding:14px}
  .kpi .card h4{margin:0 0 8px 0;font-size:12px;color:var(--muted);letter-spacing:.06em;text-transform:uppercase}
  .big{font-size:22px;font-weight:700}
  .danger{color:var(--danger)} .warn{color:var(--warn)} .ok{color:var(--ok)}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 16px}
  .btn{background:#1d2431;border:1px solid var(--grid);color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.primary{background:linear-gradient(135deg,#44b6ff,var(--brand));border:none;color:#00140b;font-weight:700}
  .btn.ghost{background:transparent}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  label{display:block;margin:8px 0 4px;color:var(--muted);font-size:12px}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--grid);background:#0f141c;color:var(--ink)}
  textarea{min-height:110px;resize:vertical}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{text-align:left;padding:8px 10px;background:var(--panel);border:1px solid var(--grid)}
  th{font-size:12px;color:var(--muted)}
  tr td:first-child, tr th:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
  tr td:last-child, tr th:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
  .hint{background:#10202a;border:1px solid #1e3b46;padding:12px;border-radius:12px;color:#bfe9ff}
  .muted{color:var(--muted)}
  .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .tag{font-size:12px;background:var(--chip);padding:4px 8px;border:1px solid var(--grid);border-radius:999px;color:var(--muted)}
  .status{display:inline-flex;align-items:center;gap:8px}
  .status i{width:10px;height:10px;border-radius:50%;background:var(--warn)}
  .status.ok i{background:var(--ok)} .status.bad i{background:var(--danger)}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--grid);font-size:12px;background:#121722}
  .section h2{margin:8px 0 6px}
  .guard{border-left:4px solid var(--brand);padding:10px 12px;background:#0f1921;border-radius:10px;margin:10px 0}
  .footbar{position:fixed;bottom:0;left:280px;right:0;background:rgba(16,22,30,.9);backdrop-filter:blur(8px);border-top:1px solid var(--grid);
     padding:10px 16px;display:flex;justify-content:space-between;align-items:center}
  .progress{height:10px;background:#111722;border:1px solid var(--grid);border-radius:999px;overflow:hidden}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,#44b6ff,var(--brand));width:0%}
  .rca-board{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .rca-col{background:var(--panel);border:1px solid var(--grid);border-radius:12px;padding:10px}
  .list{display:flex;flex-direction:column;gap:6px;margin-top:6px}
  .list .row{display:flex;gap:6px}
  .tiny{font-size:12px}
  .print-only{display:none}
  @media print{
    aside,.footbar,.toolbar,.kpi{display:none}
    .print-only{display:block}
    body{background:#fff;color:#000}
    main{padding:0}
    .card,.rca-col,.guard{border:1px solid #ddd;background:#fff}
    a{text-decoration:none;color:#000}
  }
</style>
</head>
<body>
<div class="app">
  <aside>
    <header>
      <div class="logo" aria-hidden="true"></div>
      <div><h1>SARI Governance</h1><div class="sub">Prototype v1.0</div></div>
    </header>

    <div class="nav">
      <div class="navsec">
        <h3>Allgemein</h3>
        <button data-view="dashboard" class="active">üè† Dashboard</button>
        <button data-view="meta">üóÇÔ∏è SARI Stammdaten</button>
        <button data-view="governance">üèõÔ∏è Governance</button>
        <button data-view="idcard">üßæ ID-Card</button>
        <button data-view="maturity">üìà Maturity-Checklist</button>
      </div>
      <div class="navsec">
        <h3>9S Schritte</h3>
        <button data-view="s0">S0 ‚Ä¢ Containment</button>
        <button data-view="s1">S1 ‚Ä¢ Team Charter</button>
        <button data-view="s2">S2 ‚Ä¢ Evidence Hub</button>
        <button data-view="s3">S3 ‚Ä¢ Validate Containment</button>
        <button data-view="s4">S4 ‚Ä¢ RCA Workspace</button>
        <button data-view="s5">S5 ‚Ä¢ Corrective Actions</button>
        <button data-view="s6">S6 ‚Ä¢ Implement & Effectiveness</button>
        <button data-view="s7">S7 ‚Ä¢ Standardize & Prevent</button>
        <button data-view="s8">S8 ‚Ä¢ Close & Recognize</button>
      </div>
      <div class="navsec">
        <h3>Utility</h3>
        <button id="btnNewSari">‚ûï Neues SARI</button>
        <button id="btnExport">‚¨áÔ∏è Export JSON</button>
        <button id="btnImport">‚¨ÜÔ∏è Import JSON</button>
        <input id="importFile" type="file" accept="application/json" hidden>
        <button id="btnGridImport">üß© Import Maturity Grid (CSV)</button>
        <input id="gridFile" type="file" accept=".csv,text/csv" hidden>
      </div>
      <div class="navsec">
        <h3>Info</h3>
        <div class="hint tiny">
          Demo-Maturity-Grid (S0‚ÄìS3) ist vorbef√ºllt. <br>Vollst√§ndiges CSV kann √ºber ‚ÄûGrid Import‚Äú geladen werden.
        </div>
      </div>
    </div>
  </aside>

  <main>
    <!-- KPI DASHBOARD -->
    <section data-page="dashboard" class="section">
      <div class="kpi">
        <div class="card"><h4>Overdue Aktionen</h4><div id="kpiOverdue" class="big">0</div></div>
        <div class="card"><h4>RPN</h4><div class="big"><span id="kpiRpn">0</span> <span class="pill" id="kpiLevel">L‚Äì</span></div></div>
        <div class="card"><h4>Fortschritt 9S</h4><div class="progress"><i id="kpiProgress" style="width:0%"></i></div><div class="tiny muted" id="kpiProgressTxt">0%</div></div>
        <div class="card"><h4>Status</h4><div class="inline">
          <span class="status" id="stContain"><i></i>Containment</span>
          <span class="status" id="stRca"><i></i>RCA</span>
          <span class="status" id="stPca"><i></i>PCA</span>
          <span class="status" id="stClose"><i></i>Close</span>
        </div></div>
      </div>

      <div class="card">
        <h2>SARI Snapshot</h2>
        <div class="grid">
          <div>
            <label>SARI Titel</label><input id="metaTitle" placeholder="z.B. GEN-004 ‚Äì Incorrect Assembly of ‚Ä¶">
          </div>
          <div class="grid">
            <div>
              <label>SARI Level</label>
              <select id="metaLevel">
                <option value="L1">L1 ‚Äì In-Service + possible Unsafe condition</option>
                <option value="L2">L2 ‚Äì In-Service, keine unsafe condition</option>
                <option value="L3">L3 ‚Äì In-Production enthalten</option>
              </select>
            </div>
            <div>
              <label>ATA (optional)</label><input id="metaAta" placeholder="z.B. ATA 27">
            </div>
          </div>

          <div class="grid">
            <div>
              <label>Severity (S)</label><input id="sevS" type="number" min="1" max="10" placeholder="1‚Äì10">
            </div>
            <div>
              <label>Occurrence (O)</label><input id="sevO" type="number" min="1" max="10" placeholder="1‚Äì10">
            </div>
            <div>
              <label>Detection (D)</label><input id="sevD" type="number" min="1" max="10" placeholder="1‚Äì10">
            </div>
          </div>
          <div><span class="muted tiny">RPN = S √ó O √ó D ‚Ä¢ ‚ÄûTop Irritants‚Äú (RPN ‚â• 300) ‚Üí S7 verpflichtend</span></div>
        </div>
      </div>
    </section>

    <!-- META -->
    <section data-page="meta" class="section" hidden>
      <div class="card">
        <h2>Stammdaten & Rollen</h2>
        <div class="grid">
          <div><label>SIM (Safety Item Manager)</label><input id="roleSim" placeholder="Name SIM"></div>
          <div><label>Sponsor</label><input id="roleSponsor"></div>
          <div><label>Solving Leader</label><input id="roleLeader"></div>
          <div><label>Problem Owner</label><input id="roleOwner"></div>
          <div><label>Operations Vertreter</label><input id="roleOps"></div>
          <div><label>PPM (Coach)</label><input id="rolePpm"></div>
        </div>
        <div class="grid">
          <div><label>First Event (Datum)</label><input id="dateFirst" type="date"></div>
          <div><label>Kundeninfo gesendet am</label><input id="dateCustomer" type="date"></div>
          <div><label>Line Stop durchgef√ºhrt</label><select id="lineStop"><option>Nein</option><option>Ja</option></select></div>
        </div>
      </div>
    </section>

    <!-- GOVERNANCE -->
    <section data-page="governance" class="section" hidden>
      <div class="card">
        <h2>Governance & Panels</h2>
        <div class="grid">
          <div>
            <label>ICB Status</label>
            <select id="govIcb">
              <option value="">‚Äî</option>
              <option>Wartet auf Allokation</option>
              <option>SIM nominiert</option>
              <option>Abgeschlossen</option>
            </select>
          </div>
          <div>
            <label>PPP (L2/L3)</label>
            <select id="govPpp">
              <option value="">‚Äî</option>
              <option>In Vorbereitung</option>
              <option>Ready for PPM Review</option>
              <option>Scheduled for PPP</option>
              <option>PPP validiert</option>
            </select>
          </div>
          <div>
            <label>PP (L1)</label>
            <select id="govPp">
              <option value="">‚Äî</option>
              <option>In Vorbereitung</option>
              <option>Ready for PPM Review</option>
              <option>Scheduled for PP</option>
              <option>PP validiert</option>
            </select>
          </div>
          <div>
            <label>POARM (EASA, L1)</label>
            <select id="govPoarm">
              <option value="">‚Äî</option>
              <option>nicht anwendbar</option>
              <option>vorbereitet</option>
              <option>durchgef√ºhrt</option>
            </select>
          </div>
        </div>

        <h3>Early Closure (nur L2/L3)</h3>
        <div class="guard">
          <div class="grid">
            <div><label>Risikoanalyse ‚Äì Wiederauftreten (Likelihood)</label><input id="rcRiskL" type="text" placeholder="z.B. gering / begr√ºndet‚Ä¶"></div>
            <div><label>Risikoanalyse ‚Äì Auswirkung (Severity)</label><input id="rcRiskS" type="text" placeholder="z.B. niedrig / begr√ºndet‚Ä¶"></div>
          </div>
          <label>Begr√ºndung Early Closure (f√ºr PPP)</label>
          <textarea id="rcJust">Basierend auf implementierten PCA und Wirksamkeitsnachweis wird die Untersuchung vor S7 geschlossen. Risiko ist akzeptabel, da ‚Ä¶</textarea>
          <div class="inline">
            <button class="btn" id="btnMarkEarly">üîè Early Closure markieren</button>
            <span class="tag" id="tagEarly" hidden>EARLY CLOSURE DRAFT</span>
          </div>
        </div>
      </div>
    </section>

    <!-- MATURITY CHECKLIST -->
    <section data-page="maturity" class="section" hidden>
      <div class="card">
        <h2>Maturity-Checklist (FM2201494)</h2>
        <div id="maturityList" class="list"></div>
      </div>
    </section>

    <!-- ID CARD -->
    <section data-page="idcard" class="section" hidden>
      <div class="card">
        <h2>ID-Card (FM2201652)</h2>
        <div id="idCardContainer"></div>
        <div class="toolbar">
          <button class="btn" onclick="window.print()">üñ®Ô∏è Drucken / PDF</button>
        </div>
      </div>
    </section>

    <!-- S0 -->
    <section data-page="s0" class="section" hidden>
      <div class="card">
        <h2>S0 ‚Äì Containment Cockpit</h2>
        <div class="guard" id="gridS0"></div>
        <div class="grid">
          <div>
            <label>Nachweis Kundeninformation (Datum)</label><input id="s0CustomerDate" type="date">
          </div>
          <div>
            <label>Containment-Aktionsplan (Upload)</label><input id="s0PlanFile" type="file">
          </div>
          <div>
            <label>Line Stop durchgef√ºhrt</label>
            <select id="s0LineStop"><option>Nein</option><option>Ja</option></select>
          </div>
          <div>
            <label>Bestandspr√ºfung ‚Äì Nachweis</label><textarea id="s0StockProof" placeholder="Link/Notiz; Upload unten optional"></textarea>
          </div>
          <div>
            <label>Bestandspr√ºfung (Upload)</label><input id="s0StockFile" type="file">
          </div>
        </div>

        <div class="hint" id="s0Urgency">
          ‚è±Ô∏è 1-Tages-Frist Kundeninfo: <b id="s0DueTxt">‚Äì</b>
        </div>
      </div>
    </section>

    <!-- S1 -->
    <section data-page="s1" class="section" hidden>
      <div class="card">
        <h2>S1 ‚Äì Team Charter</h2>
        <div class="guard" id="gridS1"></div>
        <div class="grid">
          <div><label>Leader</label><input id="s1Leader"></div>
          <div><label>Sponsor</label><input id="s1Sponsor"></div>
          <div><label>Problem Owner</label><input id="s1Owner"></div>
          <div><label>Operations</label><input id="s1Ops"></div>
          <div><label>Weitere MFT-Member</label><input id="s1Mft"></div>
          <div><label>Kick-off Protokoll (Upload)</label><input id="s1MoM" type="file"></div>
        </div>
      </div>
    </section>

    <!-- S2 -->
    <section data-page="s2" class="section" hidden>
      <div class="card">
        <h2>S2 ‚Äì Evidence Hub</h2>
        <div class="guard" id="gridS2"></div>
        <div class="grid">
          <div>
            <label>Issue Description (faktenbasiert)</label>
            <textarea id="s2Issue" placeholder="1 Objekt, 1 Defekt; Fakten & Zahlen‚Ä¶"></textarea>
          </div>
          <div>
            <label>Supply Chain Breakdown</label>
            <textarea id="s2Supply" placeholder="Tier 2 ‚Üí Tier 1 ‚Üí FAL ‚Üí ‚Ä¶"></textarea>
          </div>
        </div>
        <div class="grid">
          <div>
            <label>5W2H</label>
            <textarea id="s2_5w2h" placeholder="What, Where, When, Who, Why, How, How many/cost‚Ä¶"></textarea>
          </div>
          <div>
            <label>IS / IS NOT (bei komplexen F√§llen)</label>
            <textarea id="s2IsIsNot" placeholder="IS: ‚Ä¶ / IS NOT: ‚Ä¶"></textarea>
          </div>
        </div>
        <div class="grid">
          <div>
            <label>Foto/Video (Upload)</label>
            <input id="s2Media" type="file" accept="image/*,video/*" multiple>
          </div>
          <div>
            <label>M1750 ‚Äì KI-Vorschlag (GEN)</label>
            <div id="s2M1750" class="hint tiny">Ergebnis erscheint nach Eingabe/√Ñnderung der Issue Description.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- S3 -->
    <section data-page="s3" class="section" hidden>
      <div class="card">
        <h2>S3 ‚Äì Validate Containment</h2>
        <div class="guard" id="gridS3"></div>
        <div class="grid">
          <div>
            <label>Validierungsbericht (Upload)</label><input id="s3ValReport" type="file">
          </div>
          <div>
            <label>Traceability-Bericht (TOAC)</label><input id="s3Trace" type="file">
          </div>
          <div>
            <label>Trigger-Point beschrieben?</label>
            <select id="s3Trigger"><option>Nein</option><option>Ja</option></select>
          </div>
          <div>
            <label>Curative Actions umgesetzt?</label>
            <select id="s3Curative"><option>Nein</option><option>Ja</option></select>
          </div>
        </div>
      </div>
    </section>

    <!-- S4 -->
    <section data-page="s4" class="section" hidden>
      <div class="card">
        <h2>S4 ‚Äì Root Cause Analysis Workspace</h2>
        <div class="guard">Trennung der Ursachenebenen ist verpflichtend (Occurrence, Non-Detection, Systemic). Ishikawa ist empfohlen/verpflichtend (Levelabh√§ngig).</div>

        <div class="rca-board">
          <div class="rca-col">
            <b>Occurrence</b>
            <div class="list" id="ishikawa-occ"></div>
            <div class="inline">
              <input id="occInput" placeholder="Ursache hinzuf√ºgen ‚Ä¶">
              <button class="btn" id="addOcc">‚ûï</button>
            </div>
            <label>Finale RC1</label><input id="rc1">
          </div>
          <div class="rca-col">
            <b>Non-Detection</b>
            <div class="list" id="ishikawa-non"></div>
            <div class="inline">
              <input id="nonInput" placeholder="Ursache hinzuf√ºgen ‚Ä¶">
              <button class="btn" id="addNon">‚ûï</button>
            </div>
            <label>Finale RC2</label><input id="rc2">
          </div>
          <div class="rca-col">
            <b>Systemic</b>
            <div class="list" id="ishikawa-sys"></div>
            <div class="inline">
              <input id="sysInput" placeholder="Ursache hinzuf√ºgen ‚Ä¶">
              <button class="btn" id="addSys">‚ûï</button>
            </div>
            <label>Finale RC3</label><input id="rc3">
          </div>
        </div>

        <h3>5-Whys Baum</h3>
        <div class="list" id="whys"></div>
        <div class="inline">
          <input id="whyInput" placeholder="Warum ‚Ä¶? (Enter f√ºgt hinzu)">
          <button class="btn" id="addWhy">‚ûï Warum</button>
        </div>

        <label>Nachweise (Uploads, optional)</label>
        <input id="s4Proof" type="file" multiple>
      </div>
    </section>

    <!-- S5 -->
    <section data-page="s5" class="section" hidden>
      <div class="card">
        <h2>S5 ‚Äì Define Corrective Actions</h2>
        <div class="guard">Jede Ma√ünahme muss logisch einer Ursache (RC1/RC2/RC3) zugeordnet sein. Effektivit√§tskriterium definieren.</div>
        <table>
          <thead><tr><th>Ma√ünahme</th><th>Owner</th><th>F√§llig</th><th>RC Link</th><th>Erfolgsmetrik</th><th>Status</th><th></th></tr></thead>
          <tbody id="pcaRows"></tbody>
        </table>
        <div class="inline">
          <button class="btn" id="addPca">‚ûï Ma√ünahme</button>
        </div>
      </div>
    </section>

    <!-- S6 -->
    <section data-page="s6" class="section" hidden>
      <div class="card">
        <h2>S6 ‚Äì Implement & Check Effectiveness</h2>
        <div class="guard">100% der geplanten Ma√ünahmen umgesetzt; Wirksamkeit statistisch belegt (SPC/Audit). Containment erst nach Nachweis beenden.</div>
        <div id="effRows" class="list"></div>
      </div>
    </section>

    <!-- S7 -->
    <section data-page="s7" class="section" hidden>
      <div class="card">
        <h2>S7 ‚Äì Standardize & Prevent</h2>
        <div class="guard">Look-Across, SOP/FMEA aktualisiert, Lieferkette ber√ºcksichtigt. Pr√§ventive Ma√ünahmen planen & √ºberwachen.</div>
        <div class="grid">
          <div><label>Look-Across Bericht (Upload)</label><input id="s7Look" type="file"></div>
          <div><label>Aktualisierte SOP/Prozessdoks (Upload)</label><input id="s7Sop" type="file" multiple></div>
          <div><label>Aktualisierte FMEA (Upload)</label><input id="s7Fmea" type="file"></div>
        </div>
      </div>
    </section>

    <!-- S8 -->
    <section data-page="s8" class="section" hidden>
      <div class="card">
        <h2>S8 ‚Äì Close & Recognize</h2>
        <div class="guard">Checkliste ausf√ºllen; Abschlusskommunikation an Kunden; Lessons Learned integriert. Effektivit√§t der 9S-Methodik reflektieren.</div>
        <div id="closeList" class="list"></div>
        <div class="grid">
          <div><label>Abschlusskommunikation (Upload)</label><input id="s8Comm" type="file"></div>
          <div><label>Kommentar</label><textarea id="s8Comment" placeholder="Team w√ºrdigen, Learnings, n√§chste Schritte ‚Ä¶"></textarea></div>
        </div>
      </div>
    </section>

    <!-- FOOTBAR -->
    <div class="footbar">
      <div class="inline tiny">
        <span class="muted">Quality Gate:</span>
        <span id="gateTxt" class="tag">S0 Pflichtfelder offen</span>
      </div>
      <div class="inline">
        <button class="btn ghost" id="btnPrev">‚Üê Zur√ºck</button>
        <button class="btn primary" id="btnNext">Weiter ‚Üí</button>
      </div>
    </div>
  </main>
</div>

<script>
/* ------------------------ State & Helpers ------------------------ */
const state = JSON.parse(localStorage.getItem('sari_v1')||'null') || seedState();
const maturity = seedMaturity(); // demo subset, CSV import m√∂glich

function seedState(){
  return {
    meta:{title:'', level:'L3', ata:'', s:0,o:0,d:0,
          roles:{sim:'', sponsor:'', leader:'', owner:'', ops:'', ppm:''},
          dates:{first:'', customer:'', lineStop:'Nein'}},
    gov:{icb:'', ppp:'', pp:'', poarm:'', early:false, riskL:'', riskS:'', just:''},
    s0:{custDate:'', planFile:null, lineStop:'Nein', stockProof:'', stockFile:null},
    s1:{leader:'', sponsor:'', owner:'', ops:'', mft:'', mom:null},
    s2:{issue:'', supply:'', a5w2h:'', isnot:'', media:[], m1750:[]},
    s3:{val:null, trace:null, trigger:'Nein', curative:'Nein'},
    s4:{ish:{occ:[],non:[],sys:[]}, rc1:'', rc2:'', rc3:'', whys:[], proofs:[]},
    s5:{pca:[]}, // {txt,owner,due,rc,metric,status}
    s6:{eff:[]}, // mirrored from pca with evidence
    s7:{look:null, sop:[], fmea:null},
    s8:{checks:{eff:true, docs:true, lessons:true, why:true}, comm:null, comment:''},
    view:'dashboard'
  };
}

function seedMaturity(){
  // Demo-Subset (S0‚ÄìS3). Vollst√§ndiges CSV kann importiert werden.
  return {
    S0:{requirements:[
      "Customer innerhalb 1 Tag informiert",
      "Formaler Containment-Plan in 3 Arbeitstagen",
      "Produktion nur mit wirksamer Containment wieder starten ‚â§ 3 Tage"
    ], benchmark:[
      "Produktion mit effizienter Containment ‚â§ 24h wieder gestartet",
      "Issue Description inkl. Kundenperspektive enthalten"
    ]},
    S1:{requirements:[
      "MFT nominiert inkl. Operations",
      "8D/9S Leader klar benannt",
      "Sponsor eingebunden"
    ], benchmark:[
      "Top-Management Sponsorship aktiv",
      "Supplier integriert (bei Sub-Tier Themen)",
      "Operator/Inspektor vertreten"
    ]},
    S2:{requirements:[
      "1 Objekt, 1 Defekt ‚Äì faktenbasiert (5W2H)",
      "Keine Vermischung von Symptom/RC",
      "IS/IS NOT bei komplexen F√§llen"
    ], benchmark:[
      "Problem Statement mit Kunden-Sicht",
      "Lessons Learned als Input ber√ºcksichtigt"
    ]},
    S3:{requirements:[
      "Wirksamkeit der Containment demonstriert",
      "Full TOAC/Traceability gesichert",
      "Curative Actions zeitgerecht umgesetzt"
    ], benchmark:[
      "Optimierte Containment ‚â§ 7 Tage",
      "Wirksamkeit validiert (nicht nur implementiert)"
    ]}
  };
}

function save(){ localStorage.setItem('sari_v1', JSON.stringify(state)); refreshAll(); }
function $(sel){ return document.querySelector(sel); }
function el(tag, attrs={}, children=[]){ const e=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=> (k==='class'? e.className=v : e[k]=v)); children.forEach(c=> e.append(c)); return e; }
function prettyDate(d){ return d? new Date(d).toLocaleDateString():'‚Äî'; }
function daysBetween(a,b){ const x=new Date(a), y=new Date(b); if(!a||!b||isNaN(x)||isNaN(y)) return null; return Math.round((y-x)/(24*3600*1000)); }
function todayISO(){ const t=new Date(); t.setHours(0,0,0,0); return t.toISOString().slice(0,10); }
function computeRpn(){ const {s,o,d}=state.meta; const r=(+s||0)*(+o||0)*(+d||0); return isFinite(r)? r:0; }
function currentLevel(){ return state.meta.level||'L3'; }

/* ------------------------ Navigation ------------------------ */
const navButtons = document.querySelectorAll('aside .nav button[data-view]');
navButtons.forEach(btn=> btn.addEventListener('click', ()=> show(btn.dataset.view)));
function show(view){
  state.view=view; save();
  document.querySelectorAll('main [data-page]').forEach(s=> s.hidden = (s.dataset.page!==view));
  navButtons.forEach(b=> b.classList.toggle('active', b.dataset.view===view));
  refreshAll();
}
show(state.view);

/* ------------------------ Bind meta inputs ------------------------ */
$('#metaTitle').value = state.meta.title;
$('#metaTitle').addEventListener('input', e=> {state.meta.title=e.target.value; save();});

$('#metaLevel').value = state.meta.level;
$('#metaLevel').addEventListener('change', e=> {state.meta.level=e.target.value; save();});

$('#metaAta').value = state.meta.ata;
$('#metaAta').addEventListener('input', e=> {state.meta.ata=e.target.value; save();});

['sevS','sevO','sevD'].forEach(id=>{
  $('#'+id).value = state.meta[id.slice(3).toLowerCase()];
  $('#'+id).addEventListener('input', e=> {state.meta[id.slice(3).toLowerCase()] = e.target.value; save();});
});

/* Stammdaten & Rollen */
const roleMap = {roleSim:'sim', roleSponsor:'sponsor', roleLeader:'leader', roleOwner:'owner', roleOps:'ops', rolePpm:'ppm'};
Object.entries(roleMap).forEach(([id,key])=>{
  $('#'+id).value = state.meta.roles[key]||'';
  $('#'+id).addEventListener('input', e=> {state.meta.roles[key]=e.target.value; save();});
});
$('#dateFirst').value = state.meta.dates.first||'';
$('#dateCustomer').value = state.meta.dates.customer||'';
$('#lineStop').value = state.meta.dates.lineStop||'Nein';
$('#dateFirst').addEventListener('change', e=> {state.meta.dates.first=e.target.value; save();});
$('#dateCustomer').addEventListener('change', e=> {state.meta.dates.customer=e.target.value; save();});
$('#lineStop').addEventListener('change', e=> {state.meta.dates.lineStop=e.target.value; save();});

/* Governance */
[['govIcb','icb'],['govPpp','ppp'],['govPp','pp'],['govPoarm','poarm']].forEach(([id,k])=>{
  $('#'+id).value = state.gov[k]||'';
  $('#'+id).addEventListener('change', e=> {state.gov[k]=e.target.value; save();});
});
$('#rcRiskL').value = state.gov.riskL||'';
$('#rcRiskS').value = state.gov.riskS||'';
$('#rcJust').value = state.gov.just||'';
$('#rcRiskL').addEventListener('input', e=> {state.gov.riskL=e.target.value; save();});
$('#rcRiskS').addEventListener('input', e=> {state.gov.riskS=e.target.value; save();});
$('#rcJust').addEventListener('input', e=> {state.gov.just=e.target.value; save();});
$('#btnMarkEarly').addEventListener('click', ()=> { state.gov.early = !state.gov.early; save(); });

/* S0 */
$('#s0CustomerDate').value = state.s0.custDate||'';
$('#s0CustomerDate').addEventListener('change', e=> {state.s0.custDate=e.target.value; save();});
$('#s0LineStop').value = state.s0.lineStop||'Nein';
$('#s0LineStop').addEventListener('change', e=> {state.s0.lineStop=e.target.value; save();});
$('#s0StockProof').value = state.s0.stockProof||'';
$('#s0StockProof').addEventListener('input', e=> {state.s0.stockProof=e.target.value; save();});
$('#s0PlanFile').addEventListener('change', e=> handleFile(e.target.files[0], f=> {state.s0.planFile=f; save();}));
$('#s0StockFile').addEventListener('change', e=> handleFile(e.target.files[0], f=> {state.s0.stockFile=f; save();}));

/* S1 */
['s1Leader','s1Sponsor','s1Owner','s1Ops','s1Mft'].forEach(id=>{
  $('#'+id).value = state.s1[id.slice(2).toLowerCase()]||'';
  $('#'+id).addEventListener('input', e=> {state.s1[id.slice(2).toLowerCase()] = e.target.value; save();});
});
$('#s1MoM').addEventListener('change', e=> handleFile(e.target.files[0], f=> {state.s1.mom=f; save();}));

/* S2 */
$('#s2Issue').value = state.s2.issue||'';
$('#s2Supply').value = state.s2.supply||'';
$('#s2_5w2h').value = state.s2.a5w2h||'';
$('#s2IsIsNot').value = state.s2.isnot||'';
['s2Issue','s2Supply','s2_5w2h','s2IsIsNot'].forEach(id=>{
  $('#'+id).addEventListener('input', e=> { 
    const key = id==='s2_5w2h'?'a5w2h': (id==='s2IsIsNot'?'isnot': id.slice(2));
    state.s2[key]=e.target.value; 
    if(id==='s2Issue') suggestM1750();
    save();
  });
});
$('#s2Media').addEventListener('change', e=>{
  const files=[...e.target.files];
  let count=0;
  files.forEach(file=> handleFile(file, f=> { state.s2.media.push(f); count++; if(count===files.length) save(); }));
});

/* S3 */
$('#s3ValReport').addEventListener('change', e=> handleFile(e.target.files[0], f=> {state.s3.val=f; save();}));
$('#s3Trace').addEventListener('change', e=> handleFile(e.target.files[0], f=> {state.s3.trace=f; save();}));
$('#s3Trigger').value = state.s3.trigger||'Nein';
$('#s3Curative').value = state.s3.curative||'Nein';
$('#s3Trigger').addEventListener('change', e=> {state.s3.trigger=e.target.value; save();});
$('#s3Curative').addEventListener('change', e=> {state.s3.curative=e.target.value; save();});

/* S4 Ishikawa + 5Why */
function addIsh(col,inputId){const v=$(inputId).value.trim(); if(!v) return; state.s4.ish[col].push(v); $(inputId).value=''; save();}
$('#addOcc').addEventListener('click', ()=> addIsh('occ','#occInput'));
$('#addNon').addEventListener('click', ()=> addIsh('non','#nonInput'));
$('#addSys').addEventListener('click', ()=> addIsh('sys','#sysInput'));
['rc1','rc2','rc3'].forEach(id=> { $('#'+id).value=state.s4[id]||''; $('#'+id).addEventListener('input', e=> {state.s4[id]=e.target.value; save();}); });
$('#addWhy').addEventListener('click', addWhy);
$('#whyInput').addEventListener('keydown', e=> { if(e.key==='Enter'){ e.preventDefault(); addWhy(); }});
function addWhy(){ const v=$('#whyInput').value.trim(); if(!v) return; state.s4.whys.push({q:v,depth: state.s4.whys.length}); $('#whyInput').value=''; save(); }
$('#s4Proof').addEventListener('change', e=>{
  const files=[...e.target.files]; let count=0;
  files.forEach(file=> handleFile(file, f=> { state.s4.proofs.push(f); count++; if(count===files.length) save(); }));
});

/* S5 PCA */
$('#addPca').addEventListener('click', ()=> {
  state.s5.pca.push({txt:'',owner:'',due:'',rc:'RC1',metric:'',status:'Offen', evidence:null});
  syncEffRows(); save();
});
function syncEffRows(){ state.s6.eff = state.s5.pca.map((p,i)=> ({i, txt:p.txt, implemented:false, evidence:null, effective:false})); }

/* S6 */
function toggleEff(i, key){ state.s6.eff[i][key]=!state.s6.eff[i][key]; save(); }

/* S7 */
$('#s7Look').addEventListener('change', e=> handleFile(e.target.files[0], f=> {state.s7.look=f; save();}));
$('#s7Sop').addEventListener('change', e=>{
  const files=[...e.target.files]; let count=0;
  files.forEach(file=> handleFile(file, f=> { state.s7.sop.push(f); count++; if(count===files.length) save(); }));
});
$('#s7Fmea').addEventListener('change', e=> handleFile(e.target.files[0], f=> {state.s7.fmea=f; save();}));

/* S8 */
const closeItems = [
  ['eff','Wirksamkeit jeder Ma√ünahme belegt'],
  ['docs','Dokumente vollst√§ndig & abgelegt'],
  ['lessons','Lessons Learned integriert'],
  ['why','5-Whys zeigt tats√§chliche RC']
];
function renderCloseList(){
  const host = $('#closeList'); host.innerHTML='';
  closeItems.forEach(([k,label])=>{
    const id='cl_'+k;
    const wrap=el('div',{className:'row'},[
      el('input',{type:'checkbox', id, checked: !!state.s8.checks[k]}),
      el('label',{htmlFor:id, innerText: label})
    ]);
    host.append(wrap);
    wrap.querySelector('input').addEventListener('change', e=> {state.s8.checks[k]=e.target.checked; save();});
  });
}
$('#s8Comm').addEventListener('change', e=> handleFile(e.target.files[0], f=> {state.s8.comm=f; save();}));
$('#s8Comment').value = state.s8.comment||'';
$('#s8Comment').addEventListener('input', e=> {state.s8.comment=e.target.value; save();});

/* ------------------------ File Handling ------------------------ */
function handleFile(file, cb){
  if(!file) return cb(null);
  const max=500*1024; // 500KB
  const reader = new FileReader();
  reader.onload = ()=> {
    const data = reader.result;
    const payload = (file.size<=max && typeof data==='string') ? data : null; // store DataURL if small
    cb({name:file.name, size:file.size, type:file.type, data:payload, ts: Date.now()});
  };
  reader.onerror = ()=> cb({name:file.name,size:file.size,type:file.type,data:null,ts:Date.now()});
  reader.readAsDataURL(file);
}

/* ------------------------ KPI & Rendering ------------------------ */
function refreshAll(){
  // KPI
  const rpn=computeRpn(); $('#kpiRpn').innerText=rpn;
  const lvl=currentLevel(); $('#kpiLevel').innerText=lvl;
  const totalSteps=9; const doneSteps = ['s0','s1','s2','s3','s4','s5','s6','s7','s8'].filter(isStepDone).length;
  const pct = Math.round((doneSteps/totalSteps)*100);
  $('#kpiProgress').style.width = pct+'%'; $('#kpiProgressTxt').innerText=pct+'%';

  // Status lights
  setLight('#stContain', isStepDone('s3'));
  setLight('#stRca', !!(state.s4.rc1 && state.s4.rc2));
  setLight('#stPca', state.s5.pca.length>0);
  setLight('#stClose', isStepDone('s8'));

  // Overdue actions
  const today=todayISO();
  const overdue = state.s5.pca.filter(p=> p.due && p.status!=='Erledigt' && p.due<today).length;
  $('#kpiOverdue').innerText = overdue;
  $('#tagEarly').hidden = !state.gov.early;

  // Maturity guard texts
  renderGridHints();
  suggestM1750();

  // S0 urgency
  renderS0Urgency();

  // RCA boards
  renderIsh();

  // 5Whys
  renderWhys();

  // PCA rows + S6 effectiveness
  renderPca();
  renderEff();

  // Maturity checklist
  renderMaturityChecklist();

  // ID Card
  renderIdCard();

  // Quality Gate + Next/Prev enablement
  renderGate();

  // Close list
  renderCloseList();
}
function setLight(sel, ok){ const el=$(sel); el.classList.toggle('ok', !!ok); el.classList.toggle('bad', !ok); }
function isStepDone(key){
  switch(key){
    case 's0': return !!state.s0.custDate && !!state.s0.planFile;
    case 's1': return !!state.s1.leader && !!state.s1.sponsor && !!state.s1.owner && !!state.s1.ops;
    case 's2': return !!state.s2.issue && !!state.s2.a5w2h;
    case 's3': return !!state.s3.val && state.s3.curative==='Ja';
    case 's4': return !!(state.s4.rc1 && state.s4.rc2);
    case 's5': return state.s5.pca.length>0;
    case 's6': return state.s6.eff.every(e=> e.implemented && e.effective);
    case 's7': return (state.meta.level==='L1' || computeRpn()>=300) ? (!!state.s7.look && !!state.s7.fmea) : true;
    case 's8': return Object.values(state.s8.checks).every(v=> !!v);
    default: return false;
  }
}
function renderGate(){
  const order=['s0','s1','s2','s3','s4','s5','s6','s7','s8'];
  const currentIndex = Math.max(0, order.indexOf(state.view.startsWith('s')? state.view : 's0'));
  let block = order.find(k=> !isStepDone(k));
  const gateTxt = block? `N√§chster Quality-Gate: ${block.toUpperCase()} abschlie√üen` : 'Alle Gates erf√ºllt ‚úî';
  $('#gateTxt').innerText = gateTxt;

  // Prev/Next buttons behavior
  $('#btnPrev').onclick = ()=> { const i=Math.max(0, currentIndex-1); show(order[i]); };
  $('#btnNext').onclick = ()=> {
    // enforce wizard forward only if current is done (except dashboard/meta/governance)
    const cur = order[currentIndex];
    if(['dashboard','meta','governance','idcard','maturity'].includes(state.view)) { show('s0'); return; }
    if(!isStepDone(cur)) { alert('Bitte Pflichtfelder f√ºr '+cur.toUpperCase()+' erf√ºllen, bevor es weitergeht.'); return; }
    const i=Math.min(order.length-1, currentIndex+1); show(order[i]);
  };
}

/* Hints from Maturity subset or CSV */
function renderGridHints(){
  [['gridS0','S0'],['gridS1','S1'],['gridS2','S2'],['gridS3','S3']].forEach(([id,step])=>{
    const host = $('#'+id); if(!host) return;
    const data = maturity[step];
    host.innerHTML = data? (
      `<b>${step} ‚Ä¢ Maturity Guidance</b><div class="grid">
         <div><div class="tiny muted">Requirements</div><ul>${data.requirements.map(x=>`<li>${x}</li>`).join('')}</ul></div>
         <div><div class="tiny muted">Benchmark</div><ul>${data.benchmark.map(x=>`<li>${x}</li>`).join('')}</ul></div>
       </div>`
    ) : '<span class="muted tiny">Keine Guidance verf√ºgbar ‚Äì bitte CSV importieren.</span>';
  });
}

/* S0 urgency due (1 day) */
function renderS0Urgency(){
  const first = state.meta.dates.first;
  const cust = state.s0.custDate || state.meta.dates.customer;
  const today = todayISO();
  if(!first){ $('#s0DueTxt').innerText='‚ÄûFirst Event‚Äú fehlt.'; return; }
  const d = daysBetween(first, cust || today);
  let txt='‚Äì';
  if(!cust){ txt = `Noch keine Kundeninfo. ${d>1? '√úberf√§llig um '+(d-1)+' Tag(e).':'Frist l√§uft ‚Äì '+(1-d)+' Tag(e) verbleiben.'}`; }
  else { txt = `Kundeninfo nach ${d} Tag(en). ${d<=1? '‚úî Frist eingehalten':'‚ö† Frist √ºberschritten'}`; }
  $('#s0DueTxt').innerText = txt;
}

/* Ishikawa & 5Whys */
function renderIsh(){
  const cols=[['ishikawa-occ','occ'],['ishikawa-non','non'],['ishikawa-sys','sys']];
  cols.forEach(([id,key])=>{
    const host=$('#'+id); host.innerHTML='';
    state.s4.ish[key].forEach((v,i)=>{
      const row=el('div',{className:'row'},[
        el('input',{value:v, oninput:(e)=>{state.s4.ish[key][i]=e.target.value; save();}}),
        el('button',{className:'btn', innerText:'üóë', onclick:()=>{state.s4.ish[key].splice(i,1); save();}})
      ]);
      host.append(row);
    });
  });
}
function renderWhys(){
  const host=$('#whys'); host.innerHTML='';
  state.s4.whys.forEach((w,i)=>{
    const row=el('div',{className:'row'},[
      el('span',{className:'tiny muted', innerText:(i+1)+'. '}),
      el('input',{value:w.q, oninput:(e)=>{state.s4.whys[i].q=e.target.value; save();}}),
      el('button',{className:'btn', innerText:'‚ñ≤', onclick:()=>{ if(i>0){ const t=state.s4.whys[i-1]; state.s4.whys[i-1]=w; state.s4.whys[i]=t; save(); }}}),
      el('button',{className:'btn', innerText:'üóë', onclick:()=>{state.s4.whys.splice(i,1); save();}})
    ]);
    host.append(row);
  });
}

/* PCA table */
function renderPca(){
  const body = $('#pcaRows'); body.innerHTML='';
  state.s5.pca.forEach((p,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input value="${p.txt||''}" placeholder="Aktion ‚Ä¶"></td>
      <td><input value="${p.owner||''}" placeholder="Owner ‚Ä¶"></td>
      <td><input type="date" value="${p.due||''}"></td>
      <td>
        <select>
          <option ${p.rc==='RC1'?'selected':''}>RC1</option>
          <option ${p.rc==='RC2'?'selected':''}>RC2</option>
          <option ${p.rc==='RC3'?'selected':''}>RC3</option>
        </select>
      </td>
      <td><input value="${p.metric||''}" placeholder="z.B. ppm‚Üì, Cpk‚Üë ‚Ä¶"></td>
      <td>
        <select>
          <option ${p.status==='Offen'?'selected':''}>Offen</option>
          <option ${p.status==='In Arbeit'?'selected':''}>In Arbeit</option>
          <option ${p.status==='Erledigt'?'selected':''}>Erledigt</option>
        </select>
      </td>
      <td><button class="btn">üóë</button></td>
    `;
    // bindings
    const [iTxt,iOwner,iDue,iRc,iMet,iStat,iDel] = tr.querySelectorAll('input,select,button');
    iTxt.oninput = e=> {p.txt=e.target.value; syncEffRows(); save();};
    iOwner.oninput = e=> {p.owner=e.target.value; save();};
    iDue.onchange = e=> {p.due=e.target.value; save();};
    iRc.onchange = e=> {p.rc=e.target.value; save();};
    iMet.oninput = e=> {p.metric=e.target.value; save();};
    iStat.onchange = e=> {p.status=e.target.value; save();};
    iDel.onclick = ()=> { state.s5.pca.splice(i,1); syncEffRows(); save(); };
    body.append(tr);
  });
}

/* Effectiveness list */
function renderEff(){
  const host = $('#effRows'); host.innerHTML='';
  if(!state.s6.eff.length) syncEffRows();
  state.s6.eff.forEach((e,i)=>{
    const row = el('div',{className:'row'},[
      el('input',{type:'checkbox', checked:e.implemented, onchange:()=>toggleEff(i,'implemented')}),
      el('span',{innerText: state.s5.pca[i]?.txt || '(Ma√ünahme)'}),
      el('span',{className:'muted tiny', innerText:'‚Ä¢'}),
      el('label',{className:'tiny'}, ['Wirksam? ']),
      el('input',{type:'checkbox', checked:e.effective, onchange:()=>toggleEff(i,'effective')}),
    ]);
    host.append(row);
  });
}

/* Maturity Checklist (lightweight, demo) */
function renderMaturityChecklist(){
  const items = [
    ['S0','Customer ‚â§ 1 Tag informiert', !!state.s0.custDate && withinDays(state.meta.dates.first,state.s0.custDate,1)],
    ['S1','MFT inkl. Ops & Sponsor gesetzt', !!state.s1.ops && !!state.s1.sponsor],
    ['S2','5W2H & 1 Objekt/1 Defekt', !!state.s2.a5w2h && !!state.s2.issue],
    ['S3','Wirksamkeit Containment nachgewiesen', !!state.s3.val],
    ['S4','RC1 + RC2 getrennt definiert', !!state.s4.rc1 && !!state.s4.rc2],
    ['S5','PCA plan verkn√ºpft (RC1/2/3)', state.s5.pca.some(p=>['RC1','RC2','RC3'].includes(p.rc))],
    ['S6','Effektivit√§t jeder Ma√ünahme belegt', state.s6.eff.every(e=> e.effective)],
    ['S7','FMEA/SOP aktualisiert (falls L1/Top Irritant)', state.meta.level==='L1' ? (!!state.s7.fmea): true],
    ['S8','Abschluss-Checkliste komplett', Object.values(state.s8.checks).every(v=>v)]
  ];
  const host = $('#maturityList'); host.innerHTML='';
  items.forEach(([step,label,ok])=>{
    const row=el('div',{className:'row'},[
      el('span',{className:'tag', innerText:step}),
      el('span',{innerText:label}),
      el('span',{className:'status '+(ok?'ok':'bad')},[el('i',{}), el('b',{innerText: ok?'OK':'Offen'})])
    ]);
    host.append(row);
  });
}
function withinDays(a,b,days){ const d=daysBetween(a,b); return d!==null && d<=days; }

/* ID Card */
function renderIdCard(){
  const c = $('#idCardContainer');
  const rpn = computeRpn();
  const lvl = currentLevel();
  c.innerHTML = `
    <div class="card print-only">
      <h2>ID-Card</h2>
    </div>
    <div class="grid">
      <div>
        <label><b>Titel</b></label>
        <div>${state.meta.title||'‚Äî'}</div>
      </div>
      <div class="grid">
        <div><label><b>Level</b></label><div>${lvl}</div></div>
        <div><label><b>ATA</b></label><div>${state.meta.ata||'‚Äî'}</div></div>
      </div>
      <div class="grid">
        <div><label><b>S/O/D</b></label><div>${state.meta.s||0}/${state.meta.o||0}/${state.meta.d||0}</div></div>
        <div><label><b>RPN</b></label><div>${rpn}</div></div>
      </div>
      <div><label><b>Problem Statement</b></label><div>${(state.s2.issue||'‚Äî').replace(/\n/g,'<br>')}</div></div>
      <div class="grid">
        <div><label><b>RC1 (Occurrence)</b></label><div>${state.s4.rc1||'‚Äî'}</div></div>
        <div><label><b>RC2 (Non-Detection)</b></label><div>${state.s4.rc2||'‚Äî'}</div></div>
        <div><label><b>RC3 (Systemic)</b></label><div>${state.s4.rc3||'‚Äî'}</div></div>
      </div>
      <div>
        <label><b>PCA Top-3</b></label>
        <ol>${state.s5.pca.slice(0,3).map(p=>`<li>${p.txt||'‚Äî'} <span class="muted tiny">(Owner: ${p.owner||'‚Äî'}, F√§llig: ${prettyDate(p.due)})</span></li>`).join('')||'<li>‚Äî</li>'}</ol>
      </div>
      <div class="grid">
        <div><label><b>First Event</b></label><div>${prettyDate(state.meta.dates.first)}</div></div>
        <div><label><b>Kundeninfo</b></label><div>${prettyDate(state.s0.custDate||state.meta.dates.customer)}</div></div>
      </div>
    </div>
  `;
}

/* M1750 GEN Keyword Heuristic (demo) */
const GEN_MAP = [
  {key:/\bfod\b|foreign\s*object/i, code:'GEN-001', title:'FOD', why:'Schl√ºsselwort ‚ÄûFOD‚Äú/‚Äûforeign object‚Äú erkannt.'},
  {key:/incorrect|wrong|vertauscht|verdreht|assembly|montage/i, code:'GEN-004', title:'Incorrect Assembly', why:'Schl√ºsselw√∂rter ‚Äûincorrect / Assembly / Montage‚Äú.'},
  {key:/torque|anzug|drehmoment/i, code:'GEN-010', title:'Torque / Fastener', why:'Drehmoment/Anzug erw√§hnt.'},
  {key:/corrosion|korrosion/i, code:'GEN-012', title:'Corrosion', why:'Korrosion erkannt.'},
  {key:/leak|leakage|leck/i, code:'GEN-021', title:'Leakage', why:'Leckage-Hinweis.'},
  {key:/label|marking|kennzeichnung/i, code:'GEN-031', title:'Marking/Labeling', why:'Kennzeichnung/Label.'}
];
function suggestM1750(){
  const t = (state.s2.issue||'') + ' ' + (state.s2.supply||'');
  const hits = GEN_MAP.filter(x=> x.key.test(t)).slice(0,3);
  state.s2.m1750 = hits.map(h=> ({code:h.code,title:h.title,why:h.why}));
  const host = $('#s2M1750');
  host.innerHTML = hits.length? (
    '<b>Vorschl√§ge:</b> ' + hits.map(h=> `<span class="pill">${h.code} ‚Äì ${h.title}</span>`).join(' ') +
    `<div class="tiny muted">Begr√ºndung: ${hits.map(h=>h.why).join(' ‚Ä¢ ')}</div>`
  ) : '<span class="muted tiny">Keine Treffer ‚Äì Engineering Judgement erforderlich.</span>';
}

/* Import/Export */
$('#btnExport').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=(state.meta.title||'sari')+'.json'; a.click();
  URL.revokeObjectURL(url);
});
$('#btnImport').addEventListener('click', ()=> $('#importFile').click());
$('#importFile').addEventListener('change', e=>{
  const file = e.target.files[0]; if(!file) return;
  const fr=new FileReader();
  fr.onload = ()=> { Object.assign(state, JSON.parse(fr.result)); save(); alert('Import erfolgreich.'); };
  fr.readAsText(file);
});
$('#btnNewSari').addEventListener('click', ()=>{
  if(confirm('Neues SARI beginnen? Ungespeicherte √Ñnderungen werden √ºberschrieben.')){ 
    const fresh=seedState(); fresh.meta.level = state.meta.level; // keep default level
    localStorage.setItem('sari_v1', JSON.stringify(fresh)); location.reload();
  }
});

/* CSV Grid Import (very simple parser) */
$('#btnGridImport').addEventListener('click', ()=> $('#gridFile').click());
$('#gridFile').addEventListener('change', e=>{
  const file=e.target.files[0]; if(!file) return;
  const fr=new FileReader();
  fr.onload = ()=> {
    // Expect: first column contains step names like "S0", "S1" blocks; we only extract "Requirements" and "Benchmark" strings heuristically.
    const text = fr.result;
    const m = {};
    ['S0','S1','S2','S3','S4','S5','S6','S7','S8'].forEach(S=>{
      const block = text.split('\n').filter(line=> line.includes(S)).join('\n');
      if(block){
        m[S]={requirements:[`Guidance f√ºr ${S} aus CSV geladen.`], benchmark:[`Benchmark-Hinweis f√ºr ${S} ‚Ä¶`]};
      }
    });
    Object.assign(maturity, m);
    renderGridHints();
    alert('Maturity Grid geladen (heuristisch). F√ºr pr√§zise Zuordnung im echten System strukturierte CSV/JSON verwenden.');
  };
  fr.readAsText(file);
});

/* ------------------------ INIT ------------------------ */
refreshAll();

/* Keyboard shortcuts */
document.addEventListener('keydown', e=>{
  if(e.ctrlKey && e.key.toLowerCase()==='s'){ e.preventDefault(); save(); alert('Gespeichert.'); }
});
</script>
</body>
</html>
