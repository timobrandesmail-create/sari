<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SARI Governance ‚Äì Pitch SPA (Single‚ÄëFile)</title>
  <style>
    :root{
      --bg:#0b1220;--panel:#131a24;--line:#263142;--ink:#e8eef6;--muted:#9ab0c6;
      --chip:#1a2332;--chip-warn:#3a2a10;--chip-ok:#0f2a22;--chip-info:#1a2438;
      --chip-ink:#9bb0c7;--chip-warn-ink:#f6d18b;--chip-ok-ink:#9fe6cb;--chip-info-ink:#a9c4ff;
      --accent1:#4ab1ff;--accent2:#62e3b2;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;}
    .grid{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
    aside{background:#0f1622;border-right:1px solid #223049;padding:16px;position:sticky;top:0;height:100vh;overflow:auto}
    main{padding:18px}
    .brand{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .brand .logo{width:26px;height:26px;border-radius:6px;background:linear-gradient(135deg,var(--accent2),var(--accent1))}
    .nav a{color:var(--ink);text-decoration:none;padding:8px 12px;border-radius:10px;border:1px solid #2c3a4f;background:#1a2332;display:inline-block}
    .row{display:grid;gap:12px;margin-bottom:12px}
    .row.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .row.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .row.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    .row.cols-5{grid-template-columns:repeat(5,minmax(0,1fr))}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
    .kpi .label{color:#93a4b6;font-size:12px;text-transform:uppercase;letter-spacing:.06em}
    .kpi .value{font-size:22px;font-weight:800}
    .kpi .sub{font-size:12px;color:#93a4b6}
    .label{color:#91a2b2;font-size:12px;display:block;margin-bottom:4px}
    .chip{font-size:12px;padding:3px 8px;border-radius:999px;background:var(--chip);color:var(--chip-ink);border:1px solid #2a3750;display:inline-block}
    .chip.warn{background:var(--chip-warn);color:var(--chip-warn-ink)}
    .chip.ok{background:var(--chip-ok);color:var(--chip-ok-ink)}
    .chip.info{background:var(--chip-info);color:var(--chip-info-ink)}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #324055;background:#1a2230;color:var(--ink);cursor:pointer}
    .btn.primary{border:none;background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#07130c;font-weight:700}
    .td{padding:8px;background:#131a24;border:1px solid #263142;border-radius:8px}
    .tile{cursor:pointer}
    .timeline{display:flex;gap:16px;overflow:auto;padding:6px 2px}
    .timeline .node{min-width:100px;cursor:pointer}
    .timeline .dot{width:12px;height:12px;border-radius:999px;background:#9ab0c6;margin-bottom:6px}
    .timeline .dot.milestone{background:#a9c4ff}
    .timeline .dot.overdue{background:#ffcc66}
    .lane{display:flex;gap:12px;overflow:auto;padding-top:8px}
    .panel{min-width:320px}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2b3647;background:#0e1420;color:#e8eef6}
    textarea{min-height:100px}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th{text-align:left;padding:8px;color:#93a4b6;font-size:12px}
    td{vertical-align:top}
    .qg{font-size:12px}
    .qg.ok{color:#9fe6cb}
    .qg.open{color:#f6d18b}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="grid">
    <aside>
      <div class="brand"><div class="logo"></div><div><div style="font-weight:700">SARI Governance</div><div style="font-size:12px;color:#9aacc0">Pitch Prototype</div></div></div>
      <div class="nav"><a href="#/">üè† Dashboard</a></div>
      <div style="margin-top:14px;display:flex;gap:8;flex-wrap:wrap"></div>
    </aside>
    <main id="app"></main>
  </div>

<script>
// ===== Utilities =====
const addDays = (iso, d) => { if(!iso) return null; const t=new Date(iso); const x=new Date(t.getTime()); x.setDate(t.getDate()+d); return x.toISOString().slice(0,10); };
const todayISO = () => new Date(Date.now()).toISOString().slice(0,10);
const daysBetween = (a,b) => { if(!a||!b) return null; const A=new Date(a), B=new Date(b); return Math.round((B-A)/(24*3600*1000)); };
const deltaFromToday = (target) => (target ? daysBetween(todayISO(), target) : null);
const el = (tag, attrs={}, ...children) => { const n=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>{ if(k==="class") n.className=v; else if(k==="style") Object.assign(n.style,v); else if(k.startsWith("on")) n.addEventListener(k.slice(2),v); else n.setAttribute(k,v); }); children.forEach(c=>{ if(c==null) return; if(typeof c==="string") n.appendChild(document.createTextNode(c)); else n.appendChild(c);}); return n; };
const clamp = (n,a,b)=> Math.max(a, Math.min(b,n));

// ===== Canon ‚Äî QG rules from Maturity Grid =====
function computeRPN(sod){ return (Number(sod.s)||0)*(Number(sod.o)||0)*(Number(sod.d)||0); }
function canon_QG(s, sari){
  const S0 = () => (s.customer_informed_on && s.first_event_date && daysBetween(s.first_event_date, s.customer_informed_on) <= 1 && !!s.containment_action_plan);
  const S1 = () => !!(s.leader && s.sponsor && s.problem_owner && s.operations_rep);
  const S2 = () => !!(s.issue_description && s.fiveWtwoH && (!s.complex_case || (s.complex_case && s.is_is_not)) && !/\b(fix|l√∂sen|solution|workaround)\b/i.test(s.issue_description));
  const S3 = () => !!(s.containment_validation_report && (s.traceability_report_toac || s.traceability_alt) && s.curative_actions_done===true);
  const rpn = computeRPN(sari.sod);
  const S4 = () => !!(s.rc1_occurrence && s.rc2_non_detection && (sari.level==="L1" || rpn>=300 ? !!s.rc3_systemic : true) && (s.rc_evidence && s.rc_evidence.length>0));
  const S5 = () => {
    if(!s.pca || s.pca.length===0) return false;
    const hasRC1 = !!sari.steps.s4?.rc1_occurrence; const hasRC2 = !!sari.steps.s4?.rc2_non_detection; const hasRC3 = !!sari.steps.s4?.rc3_systemic;
    const byRC = {RC1:false,RC2:false,RC3:false};
    for(const a of s.pca){ if(!(a.action&&a.owner&&a.due_date&&a.effectiveness_metric&&a.rc_link)) return false; if(byRC[a.rc_link]!==undefined) byRC[a.rc_link]=true; }
    const cover = (has,flag)=> has? flag:true; // cover required RCs
    return cover(hasRC1,byRC.RC1) && cover(hasRC2,byRC.RC2) && cover(hasRC3,byRC.RC3);
  };
  const Dry = () => !!(s.id_card_ready && s.pca_plan_consistent && s.demo_artifacts && s.open_risks_listed);
  const S6 = () => {
    if(!s.pca_effectiveness || s.pca_effectiveness.length===0) return false;
    for(const e of s.pca_effectiveness){ if(!(e.implemented===true && e.effective===true && e.effectiveness_evidence)) return false; }
    return true;
  };
  const PP = () => !!(s.ppm_review_green && s.risks_documented && s.pp_pack_ready);
  const S7 = () => !!(s.sop_updated && ( (sari.level==="L1" || computeRPN(sari.sod)>=300) ? s.fmea_updated : true));
  const S8 = () => !!(s.checks && s.checks.each_action_effective && s.checks.docs_complete && s.checks.lessons_integrated && s.checks.five_why_valid);
  return {S0:S0(),S1:S1(),S2:S2(),S3:S3(),S4:S4(),S5:S5(),Dry:Dry(),S6:S6(),PP:PP(),S7:S7(),S8:S8()};
}
function computeProgressSari(sari){
  const qg = {
    S0: canon_QG(sari.steps.s0_qg, sari).S0,
    S1: canon_QG(sari.steps.s1_qg, sari).S1,
    S2: canon_QG(sari.steps.s2_qg, sari).S2,
    S3: canon_QG(sari.steps.s3_qg, sari).S3,
    S4: canon_QG(sari.steps.s4_qg, sari).S4,
    S5: canon_QG(sari.steps.s5_qg, sari).S5,
    S6: canon_QG(sari.steps.s6_qg, sari).S6,
    S7: canon_QG(sari.steps.s7_qg, sari).S7,
    S8: canon_QG(sari.steps.s8_qg, sari).S8,
    Dry: canon_QG(sari.steps.dry_run, sari).Dry,
    PP: canon_QG(sari.steps.pp, sari).PP,
  };
  const arr = Object.values(qg);
  return Math.round(arr.filter(Boolean).length / arr.length * 100);
}

// ===== Demo data (with QG sections) =====
function mkSari(id, level, day1, sod, meta={}){
  return {
    id, level, day1, sod, meta,
    milestones:{ dryRun:{ target: addDays(day1,60) }, pp:{ target: addDays(day1,100) } },
    status: "Open",
    steps:{
      s0_qg:{ first_event_date: day1, customer_informed_on: day1, line_stop: "Nein", containment_action_plan: {name:"plan.pdf"} },
      s1_qg:{ leader:"", sponsor:"", problem_owner:"", operations_rep:"", mft_members:[] },
      s2_qg:{ issue_description:"", fiveWtwoH:"", complex_case:false, is_is_not:"", supply_chain_breakdown:"" },
      s3_qg:{ containment_validation_report:null, traceability_report_toac:null, traceability_alt:null, curative_actions_done:false },
      s4_qg:{ rc1_occurrence:"", rc2_non_detection:"", rc3_systemic:"", rc_evidence:[] },
      s5_qg:{ pca:[] },
      dry_run:{ id_card_ready:false, pca_plan_consistent:false, demo_artifacts:false, open_risks_listed:false },
      s6_qg:{ pca_effectiveness:[] },
      pp:{ ppm_review_green:false, risks_documented:false, pp_pack_ready:false },
      s7_qg:{ sop_updated:null, fmea_updated:null },
      s8_qg:{ checks:{ each_action_effective:false, docs_complete:false, lessons_integrated:false, five_why_valid:false }, customer_closure_comm:null, closure_comment:"" }
    }
  };
}
const SARIs = [
  mkSari("SE-25.0123","L1","2025-09-01",{s:8,o:5,d:9},{title:"GEN-004 Incorrect Assembly ‚Äì hinge bracket"}),
  mkSari("SE-25.0456","L2","2025-08-30",{s:6,o:6,d:6},{title:"GEN-010 Torque issue ‚Äì fasteners"}),
  mkSari("SE-25.0789","L3","2025-10-01",{s:4,o:5,d:7},{title:"GEN-001 FOD ‚Äì wiring bay"}),
  mkSari("SE-25.0999","L2","2025-07-20",{s:7,o:7,d:7},{title:"GEN-012 Corrosion ‚Äì panel"}),
];
// seed some realistic fields
SARIs[0].steps.s2_qg.issue_description = "1 object / 1 defect: hinge mis-assembly on LH door";
SARIs[0].steps.s5_qg.pca = [
  { action:"Introduce Poka-Yoke", owner:"Ops", due_date:"2025-10-12", rc_link:"RC2", effectiveness_metric:"Cpk >=1.33", status:"In Arbeit" },
  { action:"Revise SOP 27-14", owner:"QE", due_date:"2025-10-20", rc_link:"RC3", effectiveness_metric:"Audit=0 NC", status:"Offen" }
];

// ===== Urgency sorting & KPIs =====
function urgencyScore(s){
  const lvl = s.level === "L1" ? 3 : s.level === "L2" ? 2 : 1;
  const dDry = deltaFromToday(s.milestones.dryRun?.target) ?? 9999; // negative => overdue
  const dPP = deltaFromToday(s.milestones.pp?.target) ?? 9999;
  const rpn = computeRPN(s.sod);
  const overdue = (s.steps.s5_qg.pca||[]).filter(p=> p.due_date && p.status!=="Erledigt" && p.due_date < todayISO()).length;
  return [ -lvl, (dDry>=0? dDry: dDry*2), (dPP>=0? dPP: dPP*1.5), -rpn, -overdue ]; // lower is more urgent
}
function compareTuple(a,b){ for(let i=0;i<Math.max(a.length,b.length);i++){ const d=(a[i]||0)-(b[i]||0); if(d!==0) return d; } return 0; }

// ===== Rendering =====
function renderApp(){
  const app = document.getElementById('app');
  const hash = location.hash.replace(/^#\/?/, '');
  const seg = hash.split('/');
  app.innerHTML = '';
  if(!hash || seg[0]==='' || seg[0]==='dashboard'){ app.appendChild(renderDashboard()); return; }
  if(seg[0]==='sari' && seg[1]){ const s = SARIs.find(x=> x.id===seg[1]); app.appendChild(s? renderSariDetail(s): el('div',{class:'card'},'Unbekanntes SARI.')); return; }
  app.appendChild(renderDashboard());
}
window.addEventListener('hashchange', renderApp);

function kpi(label, value, sub){
  const r = el('div',{class:'card kpi'});
  r.appendChild(el('div',{class:'label'},label));
  r.appendChild(el('div',{class:'value'}, String(value)));
  if(sub) r.appendChild(el('div',{class:'sub'}, sub));
  return r;
}
function chip(txt, tone){ return el('span',{class:'chip '+(tone||'')}, txt); }

function renderDashboard(){
  const wrap = el('div');
  const open = SARIs.filter(s=> s.status!=="Closed").length;
  const overdueMs = SARIs.filter(s=> (deltaFromToday(s.milestones.dryRun?.target)??1)<0 || (deltaFromToday(s.milestones.pp?.target)??1)<0).length;
  const avgDry = Math.round(SARIs.reduce((a,s)=> a+(deltaFromToday(s.milestones.dryRun?.target)??0),0)/Math.max(1,SARIs.length));
  const avgPP = Math.round(SARIs.reduce((a,s)=> a+(deltaFromToday(s.milestones.pp?.target)??0),0)/Math.max(1,SARIs.length));
  const topIrr = SARIs.filter(s=> s.level==="L1" || computeRPN(s.sod)>=300).length;
  const row = el('div',{class:'row cols-5'});
  row.append(kpi('Open SARIs', open), kpi('Overdue Milestones', overdueMs), kpi('√ò Days to Dry Run', avgDry), kpi('√ò Days to PP', avgPP), kpi('Top Irritants', topIrr));
  wrap.appendChild(row);

  const sorted = [...SARIs].sort((a,b)=> compareTuple(urgencyScore(a), urgencyScore(b)));
  const grid = el('div',{class:'row cols-3', style:{gap:'16px'}});
  sorted.forEach(s=> grid.appendChild(renderTile(s)));
  wrap.appendChild(grid);
  return wrap;
}

function renderTile(s){
  const rpn = computeRPN(s.sod);
  const prog = computeProgressSari(s);
  const dDry = deltaFromToday(s.milestones.dryRun?.target);
  const dPP = deltaFromToday(s.milestones.pp?.target);
  const dryTxt = dDry==null? '‚Äî' : dDry<0? `DRY RUN ${Math.abs(dDry)}d overdue` : `DRY RUN in ${dDry}d`;
  const ppTxt = dPP==null? '‚Äî' : dPP<0? `PP ${Math.abs(dPP)}d overdue` : `PP in ${dPP}d`;
  const overdue = (s.steps.s5_qg.pca||[]).filter(p=> p.due_date && p.status!=='Erledigt' && p.due_date < todayISO()).length;
  const card = el('div',{class:'card tile'});
  card.addEventListener('click', ()=> location.hash = `#/sari/${s.id}`);
  const head = el('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'8px'}});
  head.appendChild(el('div',{style:{fontWeight:'800'}}, s.id));
  const badges = el('div',{style:{display:'flex',gap:'8px',alignItems:'center'}});
  badges.appendChild(chip(s.level,'info'));
  if(s.level==='L1' || rpn>=300) badges.appendChild(chip('Top Irritant','warn'));
  head.appendChild(badges);
  card.appendChild(head);
  card.appendChild(el('div',{class:'muted'}, s.meta?.title || s.steps?.s2_qg?.issue_description || '‚Äî'));
  const row = el('div',{class:'row cols-3', style:{marginTop:'8px'}});
  const rpnBox = el('div'); rpnBox.appendChild(el('label',{class:'label'},'RPN')); rpnBox.appendChild(el('div',{style:{fontWeight:'700'}}, String(rpn))); rpnBox.appendChild(el('div',{class:'muted',style:{fontSize:'12px'}}, `S/O/D ${s.sod.s}/${s.sod.o}/${s.sod.d}`));
  const prgBox = el('div'); prgBox.appendChild(el('label',{class:'label'},'Fortschritt')); prgBox.appendChild(el('div',{style:{fontWeight:'700'}}, `${prog}%`));
  const ovdBox = el('div'); ovdBox.appendChild(el('label',{class:'label'},'Overdue Aktionen')); ovdBox.appendChild(el('div',{style:{fontWeight:'700'}}, String(overdue)));
  row.append(rpnBox, prgBox, ovdBox);
  card.appendChild(row);
  const chips = el('div',{class:'row cols-2'});
  chips.appendChild(el('div',{}, chip(dryTxt, dDry<0?'warn':'info')));
  chips.appendChild(el('div',{}, chip(ppTxt, dPP<0?'warn':'info')));
  card.appendChild(chips);
  return card;
}

function renderTimeline(s){
  const nodes = [
    {id:'s0',label:'S0'}, {id:'s1',label:'S1'}, {id:'s2',label:'S2'}, {id:'s3',label:'S3'}, {id:'s4',label:'S4'}, {id:'s5',label:'S5'},
    {id:'dry',label:'Dry Run', milestone:true, target:s.milestones.dryRun?.target },
    {id:'s6',label:'S6'}, {id:'pp',label:'PP', milestone:true, target:s.milestones.pp?.target }, {id:'s7',label:'S7'}, {id:'s8',label:'S8'}
  ];
  const bar = el('div',{class:'timeline'});
  nodes.forEach(n=>{
    const d = n.milestone ? deltaFromToday(n.target) : null;
    const node = el('div',{class:'node'});
    const dot = el('div',{class:'dot '+(n.milestone?'milestone':'' )+' '+(d!=null && d<0?'overdue':'')});
    node.appendChild(dot);
    node.appendChild(el('div',{style:{fontWeight:n.milestone?800:600}}, n.label));
    if(n.milestone) node.appendChild(el('div',{class:'muted',style:{fontSize:'12px'}}, n.target || '‚Äî'));
    node.addEventListener('click',()=>{
      document.querySelector(`[data-panel="${n.id}"]`)?.scrollIntoView({behavior:'smooth', inline:'start', block:'nearest'});
    });
    bar.appendChild(node);
  });
  return bar;
}

function panel(title, id){ const p = el('div',{class:'card panel', 'data-panel': id}); p.appendChild(el('div',{style:{fontWeight:'700',marginBottom:'6px'}}, title)); return p; }

function field(label, input){ const wrap = el('div'); wrap.appendChild(el('label',{class:'label'}, label)); wrap.appendChild(input); return wrap; }
function inputText(val, on){ const i=el('input',{value:val||''}); i.addEventListener('input', e=> on(e.target.value)); return i; }
function inputDate(val, on){ const i=el('input',{type:'date',value:val||''}); i.addEventListener('input', e=> on(e.target.value)); return i; }
function inputBool(val, on){ const i=el('select',{}); ['Nein','Ja'].forEach(x=> i.appendChild(el('option',{value:x, selected: (val? 'Ja':'Nein')===x}, x))); i.addEventListener('change', e=> on(e.target.value==='Ja')); return i; }
function inputArea(val, on){ const i=el('textarea',{},); i.value = val||''; i.addEventListener('input', e=> on(e.target.value)); return i; }
function inputCheck(val, on, label){ const l=el('label',{style:{display:'flex',gap:'8px',alignItems:'center'}}); const i=el('input',{type:'checkbox'}); i.checked=!!val; i.addEventListener('change', e=> on(!!e.target.checked)); l.appendChild(i); l.appendChild(document.createTextNode(label)); return l; }

function qgBadge(ok){ return el('div',{class:'qg '+(ok?'ok':'open')}, ok? 'Requirements OK' : 'Requirements offen'); }

function renderSariDetail(s){
  const wrap = el('div');
  // Header
  const head = el('div',{class:'card'});
  const top = el('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center'}});
  const left = el('div'); left.appendChild(el('div',{style:{fontSize:'18px',fontWeight:'800'}}, s.id)); left.appendChild(el('div',{class:'muted',style:{fontSize:'12px'}}, `ATA ${s.meta?.ata||'‚Äî'} ‚Ä¢ SIM ${s.meta?.sim||'‚Äî'}`));
  const right = el('div',{style:{display:'flex',gap:'8px',alignItems:'center'}});
  right.appendChild(chip(s.level,'info'));
  right.appendChild(chip('RPN '+computeRPN(s.sod)));
  right.appendChild(chip('Status '+s.status));
  top.append(left,right); head.appendChild(top); wrap.appendChild(head);
  wrap.appendChild(el('div',{style:{height:'10px'}}));
  wrap.appendChild(el('div',{class:'card'}, renderTimeline(s)));
  wrap.appendChild(el('div',{style:{height:'10px'}}));

  // Lane with interactive forms per Canon (edit-in-place)
  const lane = el('div',{class:'lane'});

  // S0
  const p0 = panel('S0 ‚Ä¢ Containment','s0');
  const s0 = s.steps.s0_qg;
  p0.appendChild(qgBadge(canon_QG(s.steps.s0_qg,s).S0));
  p0.appendChild(field('First Event', inputDate(s0.first_event_date, v=>{ s0.first_event_date=v; rerender(); } )));
  p0.appendChild(field('Kundeninfo gesendet am', inputDate(s0.customer_informed_on, v=>{ s0.customer_informed_on=v; rerender(); } )));
  p0.appendChild(field('Line Stop', (function(){ const i=el('select',{}); ['Nein','Ja'].forEach(x=> i.appendChild(el('option',{value:x, selected:(s0.line_stop||'Nein')===x}, x))); i.addEventListener('change', e=>{ s0.line_stop=e.target.value; }); return i; })()));
  p0.appendChild(field('Containment‚ÄëPlan (Nachweis)', inputText(s0.containment_action_plan?.name||'', v=>{ s0.containment_action_plan = v? {name:v}: null; rerender(); })));
  lane.appendChild(p0);

  // S1
  const p1 = panel('S1 ‚Ä¢ Team Charter','s1');
  const s1 = s.steps.s1_qg;
  p1.appendChild(qgBadge(canon_QG(s.steps.s1_qg,s).S1));
  p1.appendChild(field('Leader', inputText(s1.leader, v=>{ s1.leader=v; })));
  p1.appendChild(field('Sponsor', inputText(s1.sponsor, v=>{ s1.sponsor=v; })));
  p1.appendChild(field('Problem Owner', inputText(s1.problem_owner, v=>{ s1.problem_owner=v; })));
  p1.appendChild(field('Operations', inputText(s1.operations_rep, v=>{ s1.operations_rep=v; })));
  lane.appendChild(p1);

  // S2
  const p2 = panel('S2 ‚Ä¢ Evidence Hub','s2');
  const s2 = s.steps.s2_qg;
  p2.appendChild(qgBadge(canon_QG(s.steps.s2_qg,s).S2));
  p2.appendChild(field('Issue Description (1 Objekt / 1 Defekt)', inputArea(s2.issue_description, v=>{ s2.issue_description=v; })));
  p2.appendChild(field('5W2H', inputArea(s2.fiveWtwoH, v=>{ s2.fiveWtwoH=v; })));
  // complex case toggle
  p2.appendChild(inputCheck(!!s2.complex_case, v=>{ s2.complex_case=v; rerender(); }, 'Komplexer Fall (IS/IS NOT Pflicht)'));
  if(s2.complex_case){ p2.appendChild(field('IS / IS NOT', inputArea(s2.is_is_not, v=>{ s2.is_is_not=v; }))); }
  lane.appendChild(p2);

  // S3
  const p3 = panel('S3 ‚Ä¢ Validate Containment','s3');
  const s3 = s.steps.s3_qg;
  p3.appendChild(qgBadge(canon_QG(s.steps.s3_qg,s).S3));
  p3.appendChild(field('Validierungsbericht (Ref)', inputText(s3.containment_validation_report?.name||'', v=>{ s3.containment_validation_report = v? {name:v}: null; rerender(); })));
  p3.appendChild(field('Traceability (TOAC/Alt)', inputText(s3.traceability_report_toac?.name||s3.traceability_alt?.name||'', v=>{ s3.traceability_report_toac = v? {name:v}: null; s3.traceability_alt=null; rerender(); })));
  p3.appendChild(inputCheck(!!s3.curative_actions_done, v=>{ s3.curative_actions_done=v; rerender(); }, 'Curative Actions umgesetzt'));
  lane.appendChild(p3);

  // S4
  const p4 = panel('S4 ‚Ä¢ Root Cause Analysis','s4');
  const s4 = s.steps.s4_qg;
  p4.appendChild(qgBadge(canon_QG(s.steps.s4_qg,s).S4));
  p4.appendChild(field('RC1 (Occurrence)', inputText(s4.rc1_occurrence, v=>{ s4.rc1_occurrence=v; })));
  p4.appendChild(field('RC2 (Non‚ÄëDetection)', inputText(s4.rc2_non_detection, v=>{ s4.rc2_non_detection=v; })));
  p4.appendChild(field('RC3 (Systemic)', inputText(s4.rc3_systemic, v=>{ s4.rc3_systemic=v; })));
  // evidence add quick
  const evidWrap = el('div'); evidWrap.appendChild(el('label',{class:'label'},'Evidenzen'));
  const addE = el('button',{class:'btn'},'‚ûï Evidenz');
  addE.addEventListener('click', ()=>{ s4.rc_evidence.push({name:`evidence-${s4.rc_evidence.length+1}.pdf`}); rerender(); });
  evidWrap.appendChild(addE);
  if(s4.rc_evidence?.length){ const ul=el('ul'); s4.rc_evidence.forEach(e=> ul.appendChild(el('li',{}, e.name))); evidWrap.appendChild(ul); }
  p4.appendChild(evidWrap);
  lane.appendChild(p4);

  // S5
  const p5 = panel('S5 ‚Ä¢ Corrective Actions','s5');
  const s5 = s.steps.s5_qg;
  p5.appendChild(qgBadge(canon_QG(s.steps.s5_qg,s).S5));
  const addP = el('button',{class:'btn'},'‚ûï Ma√ünahme');
  addP.addEventListener('click', ()=>{ (s5.pca=s5.pca||[]).push({ action:'', owner:'', due_date:'', rc_link:'RC1', effectiveness_metric:'', status:'Offen' }); rerender(); });
  p5.appendChild(addP);
  if((s5.pca||[]).length===0){ p5.appendChild(el('div',{class:'muted'},'Keine Ma√ünahmen erfasst.')); }
  else{
    const tbl = el('table');
    const thead = el('thead'); const trh = el('tr'); ['Ma√ünahme','Owner','F√§llig','RC','Metrik','Status'].forEach(h=> trh.appendChild(el('th',{},h))); thead.appendChild(trh); tbl.appendChild(thead);
    const tb = el('tbody');
    s5.pca.forEach((p,i)=>{
      const tr = el('tr');
      const rcSel = el('select',{}); ['RC1','RC2','RC3'].forEach(x=> rcSel.appendChild(el('option',{value:x,selected:(p.rc_link||'RC1')===x},x))); rcSel.addEventListener('change', e=>{ p.rc_link=e.target.value; });
      const stSel = el('select',{}); ['Offen','In Arbeit','Erledigt'].forEach(x=> stSel.appendChild(el('option',{value:x,selected:(p.status||'Offen')===x},x))); stSel.addEventListener('change', e=>{ p.status=e.target.value; });
      tr.appendChild(el('td',{class:'td'}, inputText(p.action, v=>{ p.action=v; })));
      tr.appendChild(el('td',{class:'td'}, inputText(p.owner, v=>{ p.owner=v; })));
      tr.appendChild(el('td',{class:'td'}, inputDate(p.due_date, v=>{ p.due_date=v; })));
      tr.appendChild(el('td',{class:'td'}, rcSel));
      tr.appendChild(el('td',{class:'td'}, inputText(p.effectiveness_metric, v=>{ p.effectiveness_metric=v; })));
      tr.appendChild(el('td',{class:'td'}, stSel));
      tb.appendChild(tr);
    });
    tbl.appendChild(tb);
    p5.appendChild(tbl);
  }
  lane.appendChild(p5);

  // Dry Run
  const pDry = panel('Milestone ‚Ä¢ Dry Run (‚â§60d)','dry');
  const dry = s.steps.dry_run;
  pDry.appendChild(qgBadge(canon_QG(s.steps.dry_run,s).Dry));
  pDry.appendChild(field('Zieltermin', el('div',{class:'td'}, s.milestones.dryRun?.target || '‚Äî')));
  pDry.appendChild(inputCheck(!!dry.id_card_ready, v=>{ dry.id_card_ready=v; }, 'ID‚ÄëCard vorhanden'));
  pDry.appendChild(inputCheck(!!dry.pca_plan_consistent, v=>{ dry.pca_plan_consistent=v; }, 'PCA‚ÄëPlan konsistent zu RCs'));
  pDry.appendChild(inputCheck(!!dry.demo_artifacts, v=>{ dry.demo_artifacts=v; }, 'Demo‚ÄëArtefakte vorhanden'));
  pDry.appendChild(inputCheck(!!dry.open_risks_listed, v=>{ dry.open_risks_listed=v; }, 'Offene Risiken gelistet'));
  lane.appendChild(pDry);

  // S6
  const p6 = panel('S6 ‚Ä¢ Implement & Effectiveness','s6');
  const s6 = s.steps.s6_qg;
  p6.appendChild(qgBadge(canon_QG(s.steps.s6_qg,s).S6));
  const addEff = el('button',{class:'btn'},'‚ûï Wirksamkeitsnachweis');
  addEff.addEventListener('click', ()=>{ (s6.pca_effectiveness=s6.pca_effectiveness||[]).push({ pca_index:0, implemented:false, effective:false, effectiveness_evidence:{name:'evidence.pdf'} }); rerender(); });
  p6.appendChild(addEff);
  if((s6.pca_effectiveness||[]).length===0){ p6.appendChild(el('div',{class:'muted'},'Noch keine Wirksamkeitsnachweise.')); }
  else{
    const ul = el('ul');
    s6.pca_effectiveness.forEach((e,i)=>{
      const li = el('li');
      li.appendChild(inputCheck(!!e.implemented, v=>{ e.implemented=v; }, 'Implementiert'));
      li.appendChild(document.createTextNode(' '));
      li.appendChild(inputCheck(!!e.effective, v=>{ e.effective=v; }, 'Wirksam'));
      li.appendChild(document.createTextNode(' '));
      li.appendChild(field('Evidenz', inputText(e.effectiveness_evidence?.name||'', v=>{ e.effectiveness_evidence = v? {name:v}: null; })));
      ul.appendChild(li);
    });
    p6.appendChild(ul);
  }
  lane.appendChild(p6);

  // PP
  const pPP = panel('Milestone ‚Ä¢ PP (‚â§100d)','pp');
  const pp = s.steps.pp;
  pPP.appendChild(qgBadge(canon_QG(s.steps.pp,s).PP));
  pPP.appendChild(field('Zieltermin', el('div',{class:'td'}, s.milestones.pp?.target || '‚Äî')));
  pPP.appendChild(inputCheck(!!pp.ppm_review_green, v=>{ pp.ppm_review_green=v; }, 'PPM‚ÄëReview abgeschlossen'));
  pPP.appendChild(inputCheck(!!pp.risks_documented, v=>{ pp.risks_documented=v; }, 'Residualrisiken dokumentiert'));
  pPP.appendChild(inputCheck(!!pp.pp_pack_ready, v=>{ pp.pp_pack_ready=v; }, 'PP‚ÄëPack (Slides + ID‚ÄëCard) bereit'));
  lane.appendChild(pPP);

  // S7
  const p7 = panel('S7 ‚Ä¢ Standardize & Prevent','s7');
  const s7 = s.steps.s7_qg;
  p7.appendChild(qgBadge(canon_QG(s.steps.s7_qg,s).S7));
  p7.appendChild(field('SOP aktualisiert (Ref)', inputText(s7.sop_updated?.name||'', v=>{ s7.sop_updated = v? {name:v}: null; rerender(); })));
  p7.appendChild(field('FMEA aktualisiert (Ref)', inputText(s7.fmea_updated?.name||'', v=>{ s7.fmea_updated = v? {name:v}: null; rerender(); })));
  lane.appendChild(p7);

  // S8
  const p8 = panel('S8 ‚Ä¢ Close & Recognize','s8');
  const s8 = s.steps.s8_qg;
  p8.appendChild(qgBadge(canon_QG(s.steps.s8_qg,s).S8));
  const c = s8.checks;
  p8.appendChild(inputCheck(!!c.each_action_effective, v=>{ c.each_action_effective=v; }, 'Wirksamkeit je Ma√ünahme belegt'));
  p8.appendChild(inputCheck(!!c.docs_complete, v=>{ c.docs_complete=v; }, 'Dokumente vollst√§ndig'));
  p8.appendChild(inputCheck(!!c.lessons_integrated, v=>{ c.lessons_integrated=v; }, 'Lessons Learned integriert'));
  p8.appendChild(inputCheck(!!c.five_why_valid, v=>{ c.five_why_valid=v; }, '5‚ÄëWhys zeigen tats√§chliche RC'));
  p8.appendChild(field('Kundenkommunikation (Ref)', inputText(s8.customer_closure_comm?.name||'', v=>{ s8.customer_closure_comm = v? {name:v}: null; })));
  p8.appendChild(field('Abschluss‚ÄëKommentar', inputArea(s8.closure_comment, v=>{ s8.closure_comment=v; })));
  lane.appendChild(p8);

  wrap.appendChild(lane);

  // Footer KPI strip for live progress
  const kp = el('div',{class:'row cols-4'});
  kp.appendChild(kpi('RPN', computeRPN(s.sod), `S/O/D ${s.sod.s}/${s.sod.o}/${s.sod.d}`));
  kp.appendChild(kpi('Fortschritt 9S', computeProgressSari(s)+'%'));
  const dDry = deltaFromToday(s.milestones.dryRun?.target); const dPP = deltaFromToday(s.milestones.pp?.target);
  kp.appendChild(kpi('Dry Run', (s.milestones.dryRun?.target||'‚Äî'), dDry==null?'‚Äî': (dDry<0? `overdue ${Math.abs(dDry)}d`: `in ${dDry}d`)));
  kp.appendChild(kpi('PP', (s.milestones.pp?.target||'‚Äî'), dPP==null?'‚Äî': (dPP<0? `overdue ${Math.abs(dPP)}d`: `in ${dPP}d`)));
  wrap.appendChild(kp);

  return wrap;

  function rerender(){ renderApp(); }
}

// initial render
renderApp();
</script>
</body>
</html>
