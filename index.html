<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SARI Governance Tool</title>
  <style>
    :root{
      --airbus-blue:#005A9C;
      --light-blue:#e6f0f7;
      --gate-grey:#e5e7eb;
      --text-dark:#333;
      --text-light:#555;
      --border-color:#d1d5db;
      --status-green:#28a745;
      --status-orange:#fd7e14;
      --status-red:#dc3545;
      --shadow-sm:0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md:0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    html,body{height:100%;overflow:hidden}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:#f4f7f6;margin:0;color:var(--text-dark);
      display:flex;flex-direction:column;
    }
    #app-wrapper{max-width:1440px;margin:0 auto;width:100%;display:flex;flex-direction:column;height:100%}
    .main-header{
      background:#fff;padding:10px 24px;border-bottom:1px solid var(--border-color);
      display:flex;align-items:center;box-shadow:var(--shadow-sm);flex-shrink:0;gap:12px
    }
    .header-spacer{flex:1}
    .export-btn{
      background:#fff;border:1px solid var(--border-color);color:var(--text-dark);
      padding:8px 12px;border-radius:6px;font-weight:600;cursor:pointer
    }
    .export-btn:hover{background:#f7fafc}
    .dashboard-btn{
      background:var(--airbus-blue);color:#fff;border:none;padding:8px 16px;border-radius:5px;
      font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px
    }
    .dashboard-btn:hover{background:#004a80}
    .dashboard-btn svg{width:16px;height:16px;fill:#fff}
    .main-container{padding:24px;flex-grow:1;display:flex;flex-direction:column;min-height:0}

    /* Dashboard */
    #dashboard-view{overflow-y:auto}
    #dashboard-view h1{margin-top:0}
    .sari-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:24px}
    .sari-card{
      background:#fff;border-radius:8px;border:1px solid var(--border-color);
      box-shadow:var(--shadow-sm);display:flex;flex-direction:column;overflow:hidden;transition:box-shadow .2s
    }
    .sari-card:hover{box-shadow:var(--shadow-md)}
    .sari-card-content{padding:16px;flex-grow:1;display:flex;flex-direction:column}
    .sari-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
    .sari-card-header .sari-id{font-weight:600;color:var(--airbus-blue)}
    .sari-card-header .sari-title{margin-top:4px;font-size:1.1rem}
    .sari-level-badge{padding:4px 8px;border-radius:12px;font-size:.8rem;font-weight:600;color:#fff}
    .sari-level-badge.l1{background:var(--status-red)}
    .sari-level-badge.l2{background:var(--status-orange)}
    .sari-level-badge.l3{background:#6c757d}
    .sari-card-kpis{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
    .kpi-card .kpi-title{font-size:.8rem;color:var(--text-light)}
    .kpi-card .kpi-value{font-size:1.1rem;font-weight:500}

    /* Dashboard progress with step labels */
    .mini-timeline-container{margin-bottom:16px}
    .mini-timeline-label{font-size:.8rem;color:var(--text-light);margin-bottom:6px}
    .mini-timeline{
      display:flex;width:100%;height:22px;border-radius:6px;overflow:hidden;background:var(--gate-grey);
      border:1px solid var(--border-color)
    }
    .mini-seg{
      flex:1;display:flex;align-items:center;justify-content:center;
      font-size:.7rem;font-weight:600;color:#334155;position:relative
    }
    .mini-seg.done{background:#e7f6ee;color:#0f5132}           /* green bg */
    .mini-seg.done::after{content:"✔";position:absolute;left:6px;top:2px;font-size:.75rem;color:#0f5132}
    .mini-seg.late{background:#fde2e1;color:#842029}          /* red bg */
    .mini-seg.cur{background:var(--light-blue);color:var(--airbus-blue)} /* blue */
    .mini-seg.future{background:#f3f4f6;color:#6b7280}        /* grey */

    .sari-card-footer{margin-top:auto}
    .details-btn{
      display:block;width:100%;padding:10px;background:var(--light-blue);color:var(--airbus-blue);
      border:1px solid var(--airbus-blue);border-radius:4px;font-weight:600;text-align:center;text-decoration:none
    }
    .details-btn:hover{background:var(--airbus-blue);color:#fff}

    /* Detail */
    #sari-detail-view{display:none;flex-direction:column;flex-grow:1;min-height:0}
    .header{text-align:center;margin-bottom:16px;padding-bottom:12px;border-bottom:2px solid var(--airbus-blue);flex-shrink:0}
    .header h1{margin:0;font-size:1.75rem}
    .header h2{margin:4px 0 0;color:var(--text-light);font-weight:400;font-size:1.1rem}
    .project-health{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;margin-bottom:16px;
      padding:12px;background:#fff;border-radius:8px;box-shadow:var(--shadow-md);flex-shrink:0
    }
    .kpi-card .kpi-value.red{color:var(--status-red)}
    .kpi-card .kpi-value.orange{color:var(--status-orange)}
    .kpi-card .kpi-value.green{color:var(--status-green)}

    .steps-timeline{
      display:flex;justify-content:space-between;padding:8px 0;margin-bottom:16px;border:1px solid var(--border-color);
      background:#fff;border-radius:8px;box-shadow:var(--shadow-sm);flex-shrink:0
    }
    .step-milestone{
      flex-basis:9%;text-align:center;padding:8px 5px;border-right:1px solid #eee;position:relative;transition:background-color .3s
    }
    .step-milestone:last-child{border-right:none}
    .step-title{font-weight:700;font-size:.9rem;color:var(--airbus-blue)}
    .step-date{font-size:.8rem;color:#777;margin-top:4px}
    .step-milestone.gate{background:var(--gate-grey)}
    .step-milestone.gate .step-title{color:var(--text-dark)}
    .step-milestone.current-step{background:var(--light-blue);border-bottom:3px solid var(--airbus-blue)}
    .step-milestone.done .step-title{color:#137333} /* green */
    .step-milestone.done .step-title::after{content:" ✔";font-weight:900}
    .step-milestone.late .step-title{color:#b42318}

    .steps-details-container{
      display:flex;overflow-x:auto;padding:10px 0;border:2px solid var(--airbus-blue);
      border-radius:10px;background:#fff;box-shadow:var(--shadow-md);flex-grow:1;min-height:0;padding-bottom:2%
    }
    .s-step{
      flex:0 0 420px;margin:20px;border:1px solid var(--border-color);border-radius:8px;box-shadow:var(--shadow-sm);
      transition:all .2s ease;display:flex;flex-direction:column;height:calc(100% - 40px);min-height:360px
    }
    .s-step[open]{box-shadow:var(--shadow-md)}
    .s-step.late{border-color:var(--status-red);border-width:2px}
    .s-step summary{
      display:flex;justify-content:space-between;align-items:center;font-size:1.25rem;font-weight:600;padding:15px;cursor:pointer;
      background:#f9f9f9;border-radius:8px 8px 0 0;border-bottom:1px solid var(--border-color);outline:none;flex-shrink:0
    }
    .s-step[open] summary{background:var(--airbus-blue);color:#fff}
    .s-step.late summary{background:var(--status-red);color:#fff}
    .summary-controls{display:flex;align-items:center;gap:10px}
    .info-btn,.maturity-btn{
      width:24px;height:24px;border-radius:50%;border:1px solid var(--airbus-blue);background:var(--light-blue);
      color:var(--airbus-blue);font-weight:800;font-size:0.95rem;cursor:pointer;display:inline-flex;align-items:center;justify-content:center
    }
    .maturity-btn{font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .s-step[open] .info-btn,.s-step[open] .maturity-btn{color:#fff;background:rgba(255,255,255,.2);border-color:#fff}
    .reminder-btn{border:none;background:none;cursor:pointer;padding:0}
    .reminder-btn svg{width:20px;height:20px;fill:var(--text-light)}
    .s-step[open] .reminder-btn svg{fill:#fff;opacity:.7}
    .s-step[open] .reminder-btn:hover svg{opacity:1}
    .deliverables-list{
      padding:16px;overflow-y:auto;flex-grow:1;min-height:0;max-height:calc(100% - 64px)
    }
    .deliverable-item{margin-bottom:20px;padding:12px;background:#fdfdfd;border:1px solid #e0e0e0;border-radius:5px}
    .deliverable-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .deliverable-title{font-weight:500}
    .header-controls{display:flex;align-items:center;gap:10px}
    .status-light{width:24px;height:24px;border-radius:50%;border:2px solid #555;box-shadow:inset 0 0 4px rgba(0,0,0,.2)}
    .status-light.green{background:var(--status-green);border-color:#1f7d36}
    .status-light.orange{background:var(--status-orange);border-color:#c46210}
    .status-light.red{background:var(--status-red);border-color:#a72833}
    .deliverable-input{width:100%;box-sizing:border-box;padding:8px;border:1px solid var(--border-color);border-radius:4px;margin-top:4px}
    .deliverable-input:focus{border-color:var(--airbus-blue);box-shadow:0 0 5px rgba(0,90,156,.3);outline:none}
    .deliverable-input[readonly]{background:#f8f9fa;color:#6c757d}

    .supply-chain-breakdown{display:flex;align-items:center;justify-content:space-between;margin-top:10px}
    .sc-node{flex:1;text-align:center;padding:8px;border:1px solid var(--border-color);border-radius:4px;background:#fafafa}
    .sc-arrow{margin:0 8px;font-size:1.5rem;color:var(--text-light)}
    .suggestion-box{margin-top:10px;padding:10px;background:var(--light-blue);border:1px solid var(--airbus-blue);border-radius:4px;font-style:italic;color:var(--text-dark)}

    .rca-pca-link{margin-top:15px;border-top:1px dashed var(--border-color);padding-top:15px}
    .rca-pca-link .rc-title{font-weight:600}
    .analyze-btn{display:block;width:100%;padding:10px;margin-top:10px;background:var(--airbus-blue);color:#fff;border:none;border-radius:4px;font-weight:600;cursor:pointer;text-align:center}
    .analyze-btn:hover{background:#004a80}
    .justification-box{margin-top:20px;padding:12px;background:#fffbe6;border:1px solid var(--status-orange);border-radius:5px}
    .justification-box label{font-weight:600;color:var(--text-dark)}

    /* Modals */
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background:rgba(0,0,0,.6);animation:fadeIn .3s}
    .modal-content{background:#fefefe;margin:10% auto;padding:24px;border:1px solid #888;border-radius:8px;width:90%;max-width:800px;box-shadow:var(--shadow-md);animation:slideIn .3s}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideIn{from{transform:translateY(-50px)}to{transform:translateY(0)}}
    .modal-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;padding-bottom:12px;margin-bottom:16px}
    .modal-header h3{margin:0;color:var(--airbus-blue)}
    .modal-close-btn{color:#aaa;font-size:28px;font-weight:bold;cursor:pointer}
    .modal-close-btn:hover{color:#000}
    .modal-body{line-height:1.6}
    .modal-body ul{margin-top:10px;padding-left:20px}

    /* 5-Why */
    #five-why-modal .why-level-container{margin-top:15px}
    #five-why-modal .why-level{display:flex;align-items:flex-start;margin-left:20px;padding-left:20px;border-left:2px solid var(--airbus-blue);margin-top:10px}
    #five-why-modal .why-level-content{flex-grow:1}
    #five-why-modal .why-level label{font-weight:600;font-size:1rem;color:var(--airbus-blue)}
    #five-why-modal .why-level textarea{width:100%;box-sizing:border-box;padding:8px;margin-top:5px;border:1px solid var(--border-color);border-radius:4px;font-family:inherit;font-size:1rem}
    .add-why-btn{margin-left:10px;padding:5px 10px;background:var(--light-blue);border:1px solid var(--airbus-blue);color:var(--airbus-blue);border-radius:4px;cursor:pointer;font-weight:600;height:38px;align-self:center}
    .add-why-btn:hover{background:var(--airbus-blue);color:#fff}
    #five-why-modal .modal-footer{margin-top:20px;text-align:right}
    #save-why-btn{padding:10px 20px;background:var(--airbus-blue);color:#fff;border:none;border-radius:4px;font-weight:600;cursor:pointer}

    /* Checklist modal */
    .maturity-level{margin-bottom:1.5em}
    .maturity-level h4{margin:0 0 .5em 0;padding-bottom:.3em;border-bottom:2px solid}
    .maturity-level ul{list-style:none;padding-left:0;margin:0}
    .maturity-level li{margin-bottom:.5em}
    .level-1 h4{border-color:#6c757d}
    .level-2 h4{border-color:var(--status-red)}
    .level-3 h4{border-color:var(--status-orange)}
    .level-4 h4{border-color:var(--status-green)}
    .level-5 h4{border-color:var(--airbus-blue)}
    .checklist-toggle{margin-top:1em}
    .ishikawa-diagram{display:grid;grid-template-columns:1fr 1fr;gap:10px;border-right:4px solid var(--airbus-blue);padding:10px;background:#fdfdfd}
    .ishikawa-bone h4{margin:0 0 10px 0;padding-bottom:5px;border-bottom:1px solid var(--airbus-blue);color:var(--airbus-blue)}
    .ishikawa-bone textarea{width:100%;height:60px;box-sizing:border-box;border:1px solid #ddd;font-family:monospace;font-size:.85rem}
  </style>
</head>
<body>
  <div id="app-wrapper">
    <header class="main-header">
      <button id="nav-dashboard-btn" class="dashboard-btn">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
        Dashboard
      </button>
      <div class="header-spacer"></div>
      <button class="export-btn" title="No function in demo">Export to ID Card</button>
      <button class="export-btn" title="No function in demo">Export to Capri</button>
    </header>

    <main class="main-container">
      <!-- Dashboard View -->
      <div id="dashboard-view">
        <h1>My SARI Cases</h1>
        <div class="sari-grid"></div>
      </div>

      <!-- SARI Detail View -->
      <div id="sari-detail-view"></div>
    </main>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {

    /* ----------------------- Data ----------------------- */

    const milestones = [
      { id:'s0', name:'S0', due:1 },
      { id:'s1', name:'S1', due:2 },
      { id:'s2', name:'S2', due:7 },
      { id:'s3', name:'S3', due:14 },
      { id:'s4', name:'S4', due:45 },
      { id:'dryrun', name:'Dry Run', due:60, isGate:true },
      { id:'s5', name:'S5', due:80 },
      { id:'pp', name:'PP', due:100, isGate:true },
      { id:'s6', name:'S6', due:150 },
      { id:'s7', name:'S7', due:170 },
      { id:'s8', name:'S8', due:180 }
    ];

    // SARI demo list (with a stepStatus override to steer colors and timeline for the pitch)
    const sariData = [
      {
        id:'SARI SE-25.XXXX',
        title:'Incorrect assembly on LH door hinge – GEN-004 candidate',
        level:'l2',
        sim:'M. Mustermann',
        creationDate:'2025-10-16',      // Demo date kept as given
        complexity:'Medium',
        currentStepIndex: milestones.findIndex(m=>m.id==='s5'), // we are at S5 now
        overallStatus:'orange',
        // manual per-step status for the pitch
        stepStatus:{
          s0:'done', s1:'done',
          s2:'late',     // explicitly late, not done
          s3:'done', s4:'done',
          s5:'current', s6:'future', s7:'future', s8:'future'
        },
        // demo content for prefill (up to S4)
        demo:{
          s0:{ customerDate:'2025-10-16', lineStop:true, plan:true, stock:true },
          s1:{ team:'Leader: J. Smith\nSponsor: A. Brown\nOps: T. Weber\nMembers: QE, ME, Supplier', leader:'J. Smith', sponsor:'A. Brown', ops:true, supplier:true, kickoff:true, lessons:'LL-2025-09-14' },
          s2:{ issue:'1 object / 1 defect: hinge mis-assembly on LH door at station 27. Evidence photo attached. Torque values inconsistent with SOP 27-14.', a5w2h:'What: hinge mis-assembly\nWhere: FAL XXX\nWhen: 2025-10-15\nWho: Ops team A\nHow: torque sequence deviation\nHow much: 2 of 18', isnot:'Is: LH door hinge mis-assembly\nIs not: RH door, other stations', problem:'Mis-assembly of LH door hinge (1 object, 1 defect).', workflow:true, m1750:['GEN-004 Incorrect Assembly','GEN-010 Torque'] },
          s3:{ proof:true, trace:true },
          s4:{ rc1:'Torque sequence deviation due to ambiguous SOP figure.', rc2:'Missing in-process torque check at station 27.', rc3:'SOP governance weak / change mgmt gap.', ishikawa:{ Man:'training gap', Machine:'torque wrench calibration ok', Material:'n/a', Method:'ambiguous SOP figure', Management:'no controlled change briefing', Milieu:'noise, time pressure' }, evidence:true }
        }
      },
      {
        id:'SARI SE-25.YYYY',
        title:'Incorrect torque on wing root',
        level:'l3',
        sim:'E. Mustermann',
        creationDate:'2025-10-17',
        complexity:'Low',
        currentStepIndex:0,
        overallStatus:'green',
        stepStatus:{ s0:'current', s1:'future', s2:'future', s3:'future', s4:'future', s5:'future', s6:'future', s7:'future', s8:'future'}
      },
      {
        id:'SARI SE-25.ZZZZ',
        title:'Corrosion on pylon fitting',
        level:'l1',
        sim:'J. Doe',
        creationDate:'2025-08-22',
        complexity:'High',
        currentStepIndex:4,
        overallStatus:'red',
        stepStatus:{ s0:'done', s1:'done', s2:'done', s3:'done', s4:'current', s5:'future', s6:'future', s7:'future', s8:'future'}
      }
    ];

    // Maturity checklist text from your grid (shortened to essentials for UI)
    const maturityData = {
      s0:[
        {level:1,title:'Not mature at all',items:['No or significantly delayed (>1 week) actions.','Customer is not informed.']},
        {level:2,title:'Early beginning',items:['Actions only partially effective or incomplete.','Customer informed after >5 days.']},
        {level:3,title:'Basics in place',items:['Stocks checked within 3 days.','Non-conforming parts quarantined within 3 days.','Customer informed within 7 days.']},
        {level:4,title:'Requirements in place',items:['Line stopped immediately.','Formal containment plan in 3 days (owner/due).','Customer informed within 1-3 days.']},
        {level:5,title:'Benchmark',items:['Production restarted within 24h with effective containment.','Initial customer-view problem description available.']}
      ],
      s1:[
        {level:1,title:'Not mature at all',items:['No evidence of a team.']},
        {level:2,title:'Early beginning',items:['MFT nominated.','9S Leader identified.','Key functions missing (Ops or Sponsor).']},
        {level:3,title:'Basics in place',items:['Operations representative included.']},
        {level:4,title:'Requirements in place',items:['Sponsor nominated and active.','People doing the job included (operator/inspector).','Supplier integrated where applicable.']},
        {level:5,title:'Benchmark',items:['Problem Owner leads.','Lessons Learned used as input.']}
      ],
      s2:[
        {level:1,title:'Not mature at all',items:['Description focuses only on customer symptoms.']},
        {level:2,title:'Early beginning',items:['Mix of facts and perception.','Fails “1 object / 1 defect”.']},
        {level:3,title:'Basics in place',items:['Fact-based description.','Clear “1 object / 1 defect”.']},
        {level:4,title:'Requirements in place',items:['5W2H completed (facts).','Final Problem Statement documented.']},
        {level:5,title:'Benchmark',items:['IS / IS NOT for complex cases.','Process workflow from origin to delivery.']}
      ],
      s3:[
        {level:1,title:'Not mature at all',items:['Containment not effective / not implemented.']},
        {level:2,title:'Early beginning',items:['Implemented, but effectiveness not demonstrated; traceability incomplete.']},
        {level:3,title:'Basics in place',items:['Effectiveness shown internally (not formal).','Partial control of WIP/Stocks.']},
        {level:4,title:'Requirements in place',items:['Formal proof of 100% effectiveness.','Full traceability secured and documented.']},
        {level:5,title:'Benchmark',items:['Effectiveness continuously reviewed.','Containment extended to similar products/processes.']}
      ],
      s4:[
        {level:1,title:'Not mature at all',items:['No logical link between cause and problem.']},
        {level:2,title:'Early beginning',items:['No clear Occurrence vs Non-Detection split.','5-Why ends with “human error”.']},
        {level:3,title:'Basics in place',items:['Clear split Occurrence/Non-Detection.','5-Why applied to both paths.']},
        {level:4,title:'Requirements in place',items:['Ishikawa used to brainstorm causes.','Root cause proven with evidence.','Systemic/Management RC identified.']},
        {level:5,title:'Benchmark',items:['Appropriate RCA method chosen (Shainin/DoE etc.).']}
      ],
      s5:[
        {level:1,title:'Not mature at all',items:['No link between action and RC.','Actions not sustainable (e.g., “be careful”).']},
        {level:2,title:'Early beginning',items:['Actions linked but unclear ownership/schedule.']},
        {level:3,title:'Basics in place',items:['Clear owner and due date per action.','For low detectability: prevention focus (Poka-Yoke).']},
        {level:4,title:'Requirements in place',items:['Separate specific actions for Occurrence, Non-Detection, and Systemic RCs.']},
        {level:5,title:'Benchmark',items:['Success criteria (KPIs) defined before selection.','Risk analysis performed.']}
      ]
    };

    // Simple keyword mapping for M1750 GEN suggestions
    const M1750_KEYWORDS = [
      {kw:['incorrect assembly','mis-assembly','misassembly','wrong assembly','assembly error','hinge'], code:'GEN-004', label:'Incorrect Assembly'},
      {kw:['torque','fastener','screw','bolt'], code:'GEN-010', label:'Incorrect Torque'},
      {kw:['corrosion','rust','oxidation'], code:'GEN-012', label:'Corrosion'},
      {kw:['fod','foreign object','debris'], code:'GEN-001', label:'FOD'},
      {kw:['leak','hydraulic','fuel','oil'], code:'GEN-020', label:'Fluid Leak (generic)'}
    ];

    /* -------------------- Routing & DOM -------------------- */

    const dashboardView = document.getElementById('dashboard-view');
    const sariDetailView = document.getElementById('sari-detail-view');

    const showDashboard = () => {
      renderDashboard();
      dashboardView.style.display='block';
      sariDetailView.style.display='none';
      window.location.hash = '#/';
    };
    const showSariDetail = (sariId) => {
      const sari = sariData.find(s=>s.id===sariId);
      renderSariDetail(sari);
      dashboardView.style.display='none';
      sariDetailView.style.display='flex';
      window.location.hash = '#/sari/'+encodeURIComponent(sariId);
    };

    document.getElementById('nav-dashboard-btn').onclick = showDashboard;

    /* -------------------- Dashboard Render -------------------- */

    function renderDashboard(){
      const grid = document.querySelector('#dashboard-view .sari-grid');
      grid.innerHTML='';
      const today = new Date();

      sariData.forEach(sari=>{
        const card=document.createElement('div');
        card.className='sari-card';
        card.dataset.sariId = sari.id;
        if(sari.overallStatus==='red') card.style.borderColor='var(--status-red)';

        const creationDate = new Date(sari.creationDate);
        const daysOpen = Math.ceil((today-creationDate)/(1000*60*60*24));

        const nextStep = milestones[sari.currentStepIndex];
        const nextDueDate = new Date(creationDate);
        if(nextStep){ nextDueDate.setDate(creationDate.getDate()+nextStep.due); }

        // Build step segments S0..S8 (exclude gates)
        const stepsOnly = milestones.filter(m=>!m.isGate);
        let segHTML='';
        stepsOnly.forEach((m,idx)=>{
          const status = sari.stepStatus?.[m.id] || (idx < sari.currentStepIndex ? 'done' : idx===sari.currentStepIndex ? 'current' : 'future');
          const cl = status==='done' ? 'done' : status==='late' ? 'late' : status==='current' ? 'cur' : 'future';
          segHTML += `<div class="mini-seg ${cl}" title="${m.name}">${m.name}</div>`;
        });

        card.innerHTML = `
          <div class="sari-card-content">
            <div class="sari-card-header">
              <div>
                <div class="sari-id">${sari.id}</div>
                <h3 class="sari-title">${sari.title}</h3>
              </div>
              <span class="sari-level-badge ${sari.level}">${sari.level.toUpperCase()}</span>
            </div>
            <div class="sari-card-kpis">
              <div class="kpi-card"><div class="kpi-title">Current Step</div><div class="kpi-value">${milestones.find((m,i)=>i===sari.currentStepIndex)?.name||'N/A'}</div></div>
              <div class="kpi-card"><div class="kpi-title">Days Open</div><div class="kpi-value">${daysOpen}</div></div>
              <div class="kpi-card"><div class="kpi-title">Creation Date</div><div class="kpi-value">${creationDate.toLocaleDateString('en-GB')}</div></div>
              <div class="kpi-card"><div class="kpi-title">Complexity</div><div class="kpi-value">${sari.complexity}</div></div>
              <div class="kpi-card"><div class="kpi-title">Next Due</div><div class="kpi-value">${nextStep?nextDueDate.toLocaleDateString('en-GB'):'N/A'}</div></div>
              <div class="kpi-card"><div class="kpi-title">SIM</div><div class="kpi-value">${sari.sim}</div></div>
            </div>
            <div class="mini-timeline-container">
              <div class="mini-timeline-label">Progress</div>
              <div class="mini-timeline">${segHTML}</div>
            </div>
            <div class="sari-card-footer">
              <a href="#" class="details-btn view-details-btn">View Details</a>
            </div>
          </div>
        `;
        grid.appendChild(card);
      });

      document.querySelectorAll('.view-details-btn').forEach(btn=>{
        btn.onclick=(e)=>{
          e.preventDefault();
          const sariId = e.target.closest('.sari-card').dataset.sariId;
          showSariDetail(sariId);
        };
      });
    }

    /* -------------------- Detail Render -------------------- */

    function renderSariDetail(sari){
      const SARI_ID = sari.id;
      const SUPPLIER_EMAIL = "supplier@example.com";
      const AT_RISK_DAYS = 5;

      const creationDate = new Date(sari.creationDate);
      const daysOpen = Math.ceil((new Date() - creationDate)/(1000*60*60*24));
      const currentStepIndex = sari.currentStepIndex;
      const currentStepId = milestones[currentStepIndex].id;

      sariDetailView.innerHTML = `
        <!-- Modals -->
        <div id="info-modal" class="modal">
          <div class="modal-content">
            <div class="modal-header"><h3 id="modal-title"></h3><span class="modal-close-btn">&times;</span></div>
            <div id="modal-body" class="modal-body"></div>
          </div>
        </div>

        <div id="five-why-modal" class="modal">
          <div class="modal-content">
            <div class="modal-header"><h3 id="five-why-title">5-Why Analysis</h3><span class="modal-close-btn">&times;</span></div>
            <div class="modal-body">
              <label for="why-problem-statement">Problem Statement</label>
              <textarea id="why-problem-statement" class="deliverable-input" rows="2"></textarea>
              <div id="why-container"></div>
            </div>
            <div class="modal-footer"><button id="save-why-btn">Save & Close</button></div>
          </div>
        </div>

        <div id="maturity-modal" class="modal">
          <div class="modal-content">
            <div class="modal-header"><h3 id="maturity-title">Maturity Evaluation</h3><span class="modal-close-btn">&times;</span></div>
            <div id="maturity-body" class="modal-body"></div>
          </div>
        </div>

        <div id="checklist-modal" class="modal">
          <div class="modal-content">
            <div class="modal-header"><h3 id="checklist-title"></h3><span class="modal-close-btn">&times;</span></div>
            <div id="checklist-body" class="modal-body"></div>
          </div>
        </div>

        <!-- Header & KPIs -->
        <div class="header">
          <h1>SARI Governance Tool</h1>
          <h2 id="sari-detail-title">${SARI_ID}</h2>
        </div>
        <div class="project-health">
          <div class="kpi-card"><div class="kpi-title">Overall Status</div><div class="kpi-value" id="kpi-status"></div></div>
          <div class="kpi-card"><div class="kpi-title">Days Open</div><div class="kpi-value">${daysOpen}</div></div>
          <div class="kpi-card"><div class="kpi-title">Current Step</div><div class="kpi-value">${milestones[currentStepIndex]?.name || 'N/A'}</div></div>
          <div class="kpi-card"><div class="kpi-title">Next Milestone</div><div class="kpi-value" id="kpi-next-milestone"></div></div>
        </div>

        <!-- Timeline -->
        <div class="steps-timeline"></div>

        <!-- Steps -->
        <div class="steps-details-container"></div>
      `;

      /* Timeline */
      const timelineContainer = sariDetailView.querySelector('.steps-timeline');
      milestones.forEach(m=>{
        const el=document.createElement('div');
        el.className = `step-milestone ${m.isGate?'gate':''}`;
        el.id = `timeline-${m.id}`;
        const dueDate = new Date(creationDate);
        dueDate.setDate(creationDate.getDate()+m.due);

        // decorate per demo status
        const st = sari.stepStatus?.[m.id];
        if(st==='done') el.classList.add('done');
        if(st==='late') el.classList.add('late');
        if(st==='current') el.classList.add('current-step');

        el.innerHTML = `<div class="step-title">${m.name}</div><div class="step-date">${dueDate.toLocaleDateString('en-GB',{day:'2-digit',month:'2-digit'})}</div>`;
        timelineContainer.appendChild(el);
      });

      /* Steps content (keeps your structure, just enriched) */
      const stepsContainer = sariDetailView.querySelector('.steps-details-container');

      // helper to mark a deliverable green/orange/red by due days logic
      const today = new Date();
      let overallStatus = 'green';
      let nextMilestone = { name:'N/A', days: Infinity };

      const s0Open = true;
      const s1Open = true;   // per request
      const s2Open = false;
      const s3Open = true;   // per request
      const s4Open = true;   // filled up to S4
      const s5Open = true;   // current
      const s6Open = false, s7Open=false, s8Open=false;

      stepsContainer.innerHTML = `
        <!-- S0 -->
        <details class="s-step" ${s0Open?'open':''} data-step-id="s0">
          <summary>
            <span>S0: Containment</span>
            <div class="summary-controls">
              <a href="mailto:${SUPPLIER_EMAIL}?subject=Reminder: SARI ${SARI_ID} - Step S0" class="reminder-btn" title="Email Reminder">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
              </a>
              <button class="maturity-btn" title="Evaluate maturity" data-mstep="s0">M</button>
              <button class="info-btn" title="Show maturity checklist" data-step-id="s0">?</button>
            </div>
          </summary>
          <div class="deliverables-list">
            <div class="deliverable-item" data-due-days="1" data-id="s0-d1">
              <div class="deliverable-header">
                <span class="deliverable-title">Customer Notification (date)</span>
                <div class="header-controls"><div class="status-light" id="s0-d1-status"></div></div>
              </div>
              <input id="s0-cust-date" type="date" class="deliverable-input">
            </div>

            <div class="deliverable-item" data-due-days="1" data-id="s0-d2" data-demo-complete="true">
              <div class="deliverable-header">
                <span class="deliverable-title">Containment Action Plan (upload)</span>
                <div class="header-controls"><div class="status-light" id="s0-d2-status"></div></div>
              </div>
              <input id="s0-plan-file" type="file" class="deliverable-input">
            </div>

            <div class="deliverable-item" data-due-days="1" data-id="s0-d3">
              <div class="deliverable-header">
                <span class="deliverable-title">Line Stop confirmed</span>
                <div class="header-controls"><div class="status-light" id="s0-d3-status"></div></div>
              </div>
              <label><input id="s0-line-stop" type="checkbox"> Yes, line was stopped immediately</label>
            </div>

            <div class="deliverable-item" data-due-days="3" data-id="s0-d4" data-demo-complete="true">
              <div class="deliverable-header">
                <span class="deliverable-title">Stocks checked & quarantine evidence</span>
                <div class="header-controls"><div class="status-light" id="s0-d4-status"></div></div>
              </div>
              <input id="s0-stock-file" type="file" class="deliverable-input">
            </div>
          </div>
        </details>

        <!-- S1 -->
        <details class="s-step" ${s1Open?'open':''} data-step-id="s1">
          <summary>
            <span>S1: Team</span>
            <div class="summary-controls">
              <a href="mailto:${SUPPLIER_EMAIL}?subject=Reminder: SARI ${SARI_ID} - Step S1" class="reminder-btn" title="Email Reminder">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
              </a>
              <button class="maturity-btn" title="Evaluate maturity" data-mstep="s1">M</button>
              <button class="info-btn" title="Show maturity checklist" data-step-id="s1">?</button>
            </div>
          </summary>
          <div class="deliverables-list">
            <div class="deliverable-item" data-due-days="2" data-id="s1-d1">
              <div class="deliverable-header">
                <span class="deliverable-title">Team Charter (MFT)</span>
                <div class="header-controls"><div class="status-light" id="s1-d1-status"></div></div>
              </div>
              <textarea id="s1-team" class="deliverable-input" style="height:120px;" placeholder="Leader:&#10;Sponsor:&#10;Ops:&#10;Members:"></textarea>
            </div>

            <div class="deliverable-item" data-due-days="2" data-id="s1-d2">
              <div class="deliverable-header">
                <span class="deliverable-title">Roles</span>
                <div class="header-controls"><div class="status-light" id="s1-d2-status"></div></div>
              </div>
              <input id="s1-leader" class="deliverable-input" placeholder="9S Leader">
              <input id="s1-sponsor" class="deliverable-input" placeholder="Sponsor (Top Mgmt)">
              <label><input id="s1-ops" type="checkbox"> Operations representative included</label>
              <label><input id="s1-supplier" type="checkbox"> Supplier integrated</label>
            </div>

            <div class="deliverable-item" data-due-days="5" data-id="s1-d3" data-demo-complete="true">
              <div class="deliverable-header">
                <span class="deliverable-title">Kick-off meeting evidence</span>
                <div class="header-controls"><div class="status-light" id="s1-d3-status"></div></div>
              </div>
              <input id="s1-kickoff" type="file" class="deliverable-input">
              <input id="s1-ll" class="deliverable-input" placeholder="Lessons Learned reference (optional)">
            </div>
          </div>
        </details>

        <!-- S2 -->
        <details class="s-step" ${s2Open?'open':''} data-step-id="s2">
          <summary>
            <span>S2: Evidence Hub</span>
            <div class="summary-controls">
              <a href="mailto:${SUPPLIER_EMAIL}?subject=Reminder: SARI ${SARI_ID} - Step S2" class="reminder-btn" title="Email Reminder">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
              </a>
              <button class="maturity-btn" title="Evaluate maturity" data-mstep="s2">M</button>
              <button class="info-btn" title="Show maturity checklist" data-step-id="s2">?</button>
            </div>
          </summary>
          <div class="deliverables-list">

            <div class="deliverable-item" data-due-days="7" data-id="s2-d1">
              <div class="deliverable-header">
                <span class="deliverable-title">Issue Description</span>
                <div class="header-controls"><div class="status-light" id="s2-d1-status"></div></div>
              </div>
              <textarea id="issue-description-input" class="deliverable-input" style="height:100px;" placeholder="1 object / 1 defect ..."></textarea>
              <div>
                <button id="m1750-btn" class="analyze-btn" style="margin-top:8px">M1750 Suggestion</button>
                <div id="suggestion-output" class="suggestion-box" style="display:none;"></div>
              </div>
            </div>

            <div class="deliverable-item" data-due-days="7" data-id="s2-d2">
              <div class="deliverable-header">
                <span class="deliverable-title">5W2H</span>
                <div class="header-controls"><div class="status-light" id="s2-d2-status"></div></div>
              </div>
              <textarea id="s2-5w2h" class="deliverable-input" rows="4" placeholder="What / Where / When / Who / Why / How / How much"></textarea>
            </div>

            <div class="deliverable-item" data-due-days="9" data-id="s2-d3">
              <div class="deliverable-header">
                <span class="deliverable-title">IS / IS NOT (for complex)</span>
                <div class="header-controls"><div class="status-light" id="s2-d3-status"></div></div>
              </div>
              <textarea id="s2-isnot" class="deliverable-input" rows="3" placeholder="IS: ...&#10;IS NOT: ..."></textarea>
            </div>

            <div class="deliverable-item" data-due-days="9" data-id="s2-d4">
              <div class="deliverable-header">
                <span class="deliverable-title">Problem Statement (summary of 5W2H)</span>
                <div class="header-controls"><div class="status-light" id="s2-d4-status"></div></div>
              </div>
              <textarea id="s2-problem" class="deliverable-input" rows="2" placeholder="Final problem statement ..."></textarea>
            </div>

            <div class="deliverable-item" data-due-days="12" data-id="s2-d5" data-demo-complete="true">
              <div class="deliverable-header">
                <span class="deliverable-title">Process workflow (origin to delivery)</span>
                <div class="header-controls"><div class="status-light" id="s2-d5-status"></div></div>
              </div>
              <input id="s2-workflow" type="file" class="deliverable-input">
            </div>

          </div>
        </details>

        <!-- S3 -->
        <details class="s-step" ${s3Open?'open':''} data-step-id="s3">
          <summary>
            <span>S3: Validate Containment</span>
            <div class="summary-controls">
              <a href="mailto:${SUPPLIER_EMAIL}?subject=Reminder: SARI ${SARI_ID} - Step S3" class="reminder-btn" title="Email Reminder">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
              </a>
              <button class="maturity-btn" title="Evaluate maturity" data-mstep="s3">M</button>
              <button class="info-btn" title="Show maturity checklist" data-step-id="s3">?</button>
            </div>
          </summary>
          <div class="deliverables-list">
            <div class="deliverable-item" data-due-days="14" data-id="s3-d1" data-demo-complete="true">
              <div class="deliverable-header">
                <span class="deliverable-title">Effectiveness Proof (e.g., test with bad parts)</span>
                <div class="header-controls"><div class="status-light" id="s3-d1-status"></div></div>
              </div>
              <input id="s3-proof" type="file" class="deliverable-input">
            </div>
            <div class="deliverable-item" data-due-days="14" data-id="s3-d2" data-demo-complete="true">
              <div class="deliverable-header">
                <span class="deliverable-title">Traceability Report (TOAC)</span>
                <div class="header-controls"><div class="status-light" id="s3-d2-status"></div></div>
              </div>
              <input id="s3-trace" type="file" class="deliverable-input">
            </div>
          </div>
        </details>

        <!-- S4 -->
        <details class="s-step" ${s4Open?'open':''} data-step-id="s4">
          <summary>
            <span>S4: RCA Cockpit</span>
            <div class="summary-controls">
              <a href="mailto:${SUPPLIER_EMAIL}?subject=Reminder: SARI ${SARI_ID} - Step S4" class="reminder-btn" title="Email Reminder">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
              </a>
              <button class="maturity-btn" title="Evaluate maturity" data-mstep="s4">M</button>
              <button class="info-btn" title="Show maturity checklist" data-step-id="s4">?</button>
            </div>
          </summary>
          <div class="deliverables-list">
            <div class="deliverable-item" data-due-days="45" data-id="s4-d0">
              <div class="deliverable-header">
                <span class="deliverable-title">Ishikawa Diagram</span>
                <div class="header-controls"><div class="status-light" id="s4-d0-status"></div></div>
              </div>
              <div class="ishikawa-diagram">
                <div class="ishikawa-bone"><h4>Man</h4><textarea id="ish-man"></textarea></div>
                <div class="ishikawa-bone"><h4>Machine</h4><textarea id="ish-machine"></textarea></div>
                <div class="ishikawa-bone"><h4>Material</h4><textarea id="ish-material"></textarea></div>
                <div class="ishikawa-bone"><h4>Method</h4><textarea id="ish-method"></textarea></div>
                <div class="ishikawa-bone"><h4>Management</h4><textarea id="ish-management"></textarea></div>
                <div class="ishikawa-bone"><h4>Milieu</h4><textarea id="ish-milieu"></textarea></div>
              </div>
            </div>

            <div class="deliverable-item" data-due-days="45" data-id="s4-d1">
              <div class="deliverable-header">
                <span class="deliverable-title">RC 1: Occurrence</span>
                <div class="header-controls"><div class="status-light" id="s4-d1-status"></div></div>
              </div>
              <input id="rc1-input" class="deliverable-input" readonly>
              <button class="analyze-btn" data-rc-target="rc1-input" data-rc-title="5-Why: RC 1">5-Why</button>
            </div>

            <div class="deliverable-item" data-due-days="45" data-id="s4-d2">
              <div class="deliverable-header">
                <span class="deliverable-title">RC 2: Non-Detection</span>
                <div class="header-controls"><div class="status-light" id="s4-d2-status"></div></div>
              </div>
              <input id="rc2-input" class="deliverable-input" readonly>
              <button class="analyze-btn" data-rc-target="rc2-input" data-rc-title="5-Why: RC 2">5-Why</button>
            </div>

            <div class="deliverable-item" data-due-days="45" data-id="s4-d3">
              <div class="deliverable-header">
                <span class="deliverable-title">RC 3: Systemic</span>
                <div class="header-controls"><div class="status-light" id="s4-d3-status"></div></div>
              </div>
              <input id="rc3-input" class="deliverable-input" placeholder="Systemic / Mgmt RC">
              <input id="s4-evidence" type="file" class="deliverable-input" placeholder="Evidence of RC">
            </div>
          </div>
        </details>

        <!-- S5 -->
        <details class="s-step" ${s5Open?'open':''} data-step-id="s5">
          <summary>
            <span>S5: Define Actions</span>
            <div class="summary-controls">
              <a href="mailto:${SUPPLIER_EMAIL}?subject=Reminder: SARI ${SARI_ID} - Step S5" class="reminder-btn" title="Email Reminder">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
              </a>
              <button class="maturity-btn" title="Evaluate maturity" data-mstep="s5">M</button>
              <button class="info-btn" title="Show maturity checklist" data-step-id="s5">?</button>
            </div>
          </summary>
          <div class="deliverables-list">
            <div class="deliverable-item" data-due-days="80" data-id="s5-d1">
              <div class="deliverable-header">
                <span class="deliverable-title">PCA Action Plan</span>
                <div class="header-controls"><div class="status-light" id="s5-d1-status"></div></div>
              </div>
              <div class="rca-pca-link">
                <div class="rc-title">Actions for RC 1 (Occurrence):</div>
                <textarea id="s5-rc1-actions" class="deliverable-input" placeholder="PCA 1.1..."></textarea>
              </div>
              <div class="rca-pca-link">
                <div class="rc-title">Actions for RC 2 (Non-Detection):</div>
                <textarea id="s5-rc2-actions" class="deliverable-input" placeholder="PCA 2.1..."></textarea>
              </div>
              <input id="s5-kpi" class="deliverable-input" placeholder="Success metric / KPI (e.g., Cpk ≥ 1.33)">
              <textarea id="s5-risk" class="deliverable-input" rows="2" placeholder="Risk analysis for proposed actions"></textarea>
            </div>
          </div>
        </details>

        <!-- S6 -->
        <details class="s-step" ${s6Open?'open':''} data-step-id="s6">
          <summary>
            <span>S6: Implement & Check Effectiveness</span>
            <div class="summary-controls">
              <a href="mailto:${SUPPLIER_EMAIL}?subject=Reminder: SARI ${SARI_ID} - Step S6" class="reminder-btn" title="Email Reminder">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
              </a>
              <button class="maturity-btn" title="Evaluate maturity" data-mstep="s6">M</button>
              <button class="info-btn" title="Show maturity checklist" data-step-id="s6">?</button>
            </div>
          </summary>
          <div class="deliverables-list">
            <div class="deliverable-item" data-due-days="150" data-id="s6-d1">
              <div class="deliverable-header">
                <span class="deliverable-title">Effectiveness Validation (e.g., SPC/Audit)</span>
                <div class="header-controls"><div class="status-light" id="s6-d1-status"></div></div>
              </div>
              <input id="s6-eff" type="file" class="deliverable-input">
            </div>
          </div>
        </details>

        <!-- S7 -->
        <details class="s-step" ${s7Open?'open':''} data-step-id="s7">
          <summary>
            <span>S7: Standardize & Prevent</span>
            <div class="summary-controls">
              <a href="mailto:${SUPPLIER_EMAIL}?subject=Reminder: SARI ${SARI_ID} - Step S7" class="reminder-btn" title="Email Reminder">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
              </a>
              <button class="maturity-btn" title="Evaluate maturity" data-mstep="s7">M</button>
              <button class="info-btn" title="Show maturity checklist" data-step-id="s7">?</button>
            </div>
          </summary>
          <div class="deliverables-list">
            <div class="deliverable-item" data-due-days="170" data-id="s7-d1">
              <div class="deliverable-header">
                <span class="deliverable-title">Look-Across & SOP/FMEA Updates</span>
                <div class="header-controls"><div class="status-light" id="s7-d1-status"></div></div>
              </div>
              <input id="s7-sop" type="file" class="deliverable-input" placeholder="SOP update"/>
              <input id="s7-fmea" type="file" class="deliverable-input" placeholder="FMEA update"/>
              <textarea id="s7-look" class="deliverable-input" rows="2" placeholder="Look across related products/lines"></textarea>
            </div>
          </div>
        </details>

        <!-- S8 -->
        <details class="s-step" ${s8Open?'open':''} data-step-id="s8">
          <summary>
            <span>S8: Close & Recognize</span>
            <div class="summary-controls">
              <a href="mailto:${SUPPLIER_EMAIL}?subject=Reminder: SARI ${SARI_ID} - Step S8" class="reminder-btn" title="Email Reminder">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
              </a>
              <button class="maturity-btn" title="Evaluate maturity" data-mstep="s8">M</button>
              <button class="info-btn" title="Show maturity checklist" data-step-id="s8">?</button>
            </div>
          </summary>
          <div class="deliverables-list">
            <div class="deliverable-item" data-due-days="180" data-id="s8-d1">
              <div class="deliverable-header">
                <span class="deliverable-title">Closure Checklist & Communication</span>
                <div class="header-controls"><div class="status-light" id="s8-d1-status"></div></div>
              </div>
              <textarea id="s8-comment" class="deliverable-input" rows="2" placeholder="Closure notes ..."></textarea>
            </div>
          </div>
        </details>
      `;

      /* Fill demo values for SE-25.XXXX (up to S4) */
      if(sari.demo){
        // S0
        if(sari.demo.s0){
          setDateVal('s0-cust-date', sari.demo.s0.customerDate);
          setCheck('s0-line-stop', !!sari.demo.s0.lineStop);
        }
        // S1
        if(sari.demo.s1){
          setVal('s1-team', sari.demo.s1.team);
          setVal('s1-leader', sari.demo.s1.leader);
          setVal('s1-sponsor', sari.demo.s1.sponsor);
          setCheck('s1-ops', !!sari.demo.s1.ops);
          setCheck('s1-supplier', !!sari.demo.s1.supplier);
          setVal('s1-ll', sari.demo.s1.lessons||'');
        }
        // S2
        if(sari.demo.s2){
          setVal('issue-description-input', sari.demo.s2.issue);
          setVal('s2-5w2h', sari.demo.s2.a5w2h);
          setVal('s2-isnot', sari.demo.s2.isnot);
          setVal('s2-problem', sari.demo.s2.problem);
          // suggestion pre-fill is done on button
        }
        // S3
        // handled via data-demo-complete true flags
        // S4
        if(sari.demo.s4){
          setVal('rc1-input', sari.demo.s4.rc1);
          setVal('rc2-input', sari.demo.s4.rc2);
          setVal('rc3-input', sari.demo.s4.rc3);
          setVal('ish-man', sari.demo.s4.ishikawa.Man);
          setVal('ish-machine', sari.demo.s4.ishikawa.Machine);
          setVal('ish-material', sari.demo.s4.ishikawa.Material);
          setVal('ish-method', sari.demo.s4.ishikawa.Method);
          setVal('ish-management', sari.demo.s4.ishikawa.Management);
          setVal('ish-milieu', sari.demo.s4.ishikawa.Milieu);
        }
      }

      // deliverable status lights + late logic (+ S2 forced late + justification)
      sariDetailView.querySelectorAll('.deliverable-item').forEach(item=>{
        const dueDays = parseInt(item.dataset.dueDays,10);
        if(isNaN(dueDays)) return;
        const dueDate = new Date(creationDate);
        dueDate.setDate(creationDate.getDate()+dueDays);
        const diffDays = Math.ceil((dueDate - today)/(1000*3600*24));

        // compute status
        let currentStatus='green';
        if(diffDays<0) currentStatus='red';
        else if(diffDays<=AT_RISK_DAYS) currentStatus='orange';

        // override for S2 (demo): set to late
        const parentStep = item.closest('.s-step');
        if(parentStep?.dataset.stepId==='s2'){
          // mark the main S2 items as red/late for the pitch
          if(item.dataset.id==='s2-d1' || item.dataset.id==='s2-d2'){
            currentStatus='red';
          }
        }

        // if item has data-demo-complete, keep green unless timeline forces override
        if(item.dataset.demoComplete === 'true' && currentStatus!=='red'){
          currentStatus='green';
        }

        const statusLight = sariDetailView.querySelector(`#${item.dataset.id}-status`);
        if(statusLight) statusLight.classList.add(currentStatus);

        // mark the step panel red and add justification if any child is late
        if(currentStatus==='red'){
          parentStep.classList.add('late');
          if(!parentStep.querySelector('.justification-box')){
            const justificationBox=document.createElement('div');
            justificationBox.className='justification-box';
            const reasonText = parentStep.dataset.stepId==='s2'
              ? 'Delay reason: Supplier data for 5W2H and process mapping not received in time; scope clarification pending.'
              : 'Please provide a reason for the delay...';
            justificationBox.innerHTML=`
              <label>Justification for Delay</label>
              <textarea class="deliverable-input" rows="3">${reasonText}</textarea>`;
            parentStep.querySelector('.deliverables-list').appendChild(justificationBox);
          }
        }

        if(diffDays>=0 && diffDays<nextMilestone.days){
          nextMilestone = {name:item.querySelector('.deliverable-title').textContent, days:diffDays};
        }
        if(currentStatus==='red') overallStatus='red';
        else if(currentStatus==='orange' && overallStatus!=='red') overallStatus='orange';
      });

      const kpiStatus = sariDetailView.querySelector('#kpi-status');
      kpiStatus.textContent = {green:'On Time', orange:'At Risk', red:'Late'}[overallStatus];
      kpiStatus.className = `kpi-value ${overallStatus}`;
      sariDetailView.querySelector('#kpi-next-milestone').textContent = nextMilestone.name;

      // reflect stepStatus (for S2 late + others) on timeline classes (already set), ensure done steps green with check
      Object.entries(sari.stepStatus||{}).forEach(([sid,st])=>{
        const el = document.getElementById(`timeline-${sid}`);
        if(!el) return;
        el.classList.remove('late','done','current-step');
        if(st==='done') el.classList.add('done');
        else if(st==='late') el.classList.add('late');
        else if(st==='current') el.classList.add('current-step');
      });

      /* ---------- Interactions ---------- */

      bindChecklistModal(sariDetailView);     // ? checklist
      bindWhyModal(sariDetailView);           // 5-Why
      bindMaturityEval(sariDetailView);       // M evaluator
      bindM1750Suggestion(sariDetailView);    // S2 M1750

      function setVal(id,val){ const el=document.getElementById(id); if(el) el.value=val; }
      function setDateVal(id,val){ const el=document.getElementById(id); if(el) el.value=val; }
      function setCheck(id,val){ const el=document.getElementById(id); if(el) el.checked=!!val; }
    }

    /* ----------------- Modals: ? Checklist ----------------- */
    function bindChecklistModal(container){
      const checklistModal = container.querySelector('#checklist-modal');
      if(!checklistModal) return;

      container.querySelectorAll('.info-btn').forEach(btn=>{
        btn.onclick = (e)=>{
          e.preventDefault();
          const stepId = e.target.dataset.stepId;
          const data = maturityData[stepId] || [];
          let content = `<p>This checklist is based on the 8D/9S Maturity Assessment Grid. Target level is <strong>Requirements in place (Level 4)</strong> as standard.</p>
          <label class="checklist-toggle"><input type="checkbox" onchange="this.closest('.modal-body').querySelectorAll('.level-5').forEach(el => el.style.display = this.checked ? 'block' : 'none')"> Show Benchmark (Level 5) criteria</label><hr>`;
          data.forEach(levelData=>{
            const itemsHTML = levelData.items.map(item=>`<li>- ${item}</li>`).join('');
            content += `<div class="maturity-level level-${levelData.level}" ${levelData.level===5?'style="display:none"':''}>
              <h4>Level ${levelData.level}: ${levelData.title}</h4><ul>${itemsHTML}</ul></div>`;
          });
          checklistModal.querySelector('#checklist-title').textContent = `Maturity Checklist for Step ${stepId.toUpperCase()}`;
          checklistModal.querySelector('#checklist-body').innerHTML = content;
          checklistModal.style.display="block";
        };
      });

      checklistModal.querySelector('.modal-close-btn').onclick = ()=> checklistModal.style.display="none";
      window.addEventListener('click', (evt)=>{ if(evt.target===checklistModal) checklistModal.style.display="none"; });
    }

    /* ----------------- Modals: Maturity Eval (M) ----------------- */
    function bindMaturityEval(container){
      const modal = container.querySelector('#maturity-modal');
      if(!modal) return;

      container.querySelectorAll('.maturity-btn').forEach(btn=>{
        btn.onclick = (e)=>{
          const stepId = e.target.dataset.mstep;
          const result = evaluateMaturity(stepId);
          renderMaturityModal(modal, stepId, result);
          modal.style.display='block';
        };
      });

      modal.querySelector('.modal-close-btn').onclick = ()=> modal.style.display="none";
      window.addEventListener('click',(evt)=>{ if(evt.target===modal) modal.style.display="none"; });
    }

    function evaluateMaturity(stepId){
      // read UI state & score against pragmatic rules
      const get = id => document.getElementById(id);
      const hasFileOrDemo = (deliverableId, inputId) => {
        const item = document.querySelector(`.deliverable-item[data-id="${deliverableId}"]`);
        const demo = item && item.dataset.demoComplete==='true';
        const inp = inputId ? get(inputId) : null;
        const has = inp && inp.files && inp.files.length>0;
        return demo || has;
      };
      const txtNotEmpty = id => (get(id)?.value||'').trim().length>0;
      const chk = id => !!get(id)?.checked;

      let level=1, nextNeeds=[];

      if(stepId==='s0'){
        // L2: either customer informed or plan uploaded
        const l2 = !!get('s0-cust-date')?.value || hasFileOrDemo('s0-d2','s0-plan-file');
        if(!l2) nextNeeds.push('Provide customer notification date OR upload a containment plan.');
        if(l2) level=2;

        // L3: stocks/quarantine evidence
        const l3 = hasFileOrDemo('s0-d4','s0-stock-file');
        if(l2 && !l3) nextNeeds.push('Upload evidence of stock checks/quarantine within 3 days.');
        if(l2 && l3) level=3;

        // L4: line stop + formal plan + customer informed
        const l4 = chk('s0-line-stop') && hasFileOrDemo('s0-d2','s0-plan-file') && !!get('s0-cust-date')?.value;
        if(level>=3 && !l4) nextNeeds.push('Ensure line stop is confirmed, formal plan present, and customer informed in 1–3 days.');
        if(level>=3 && l4) level=4;

        // L5: restart within 24h + initial customer-view (proxy not measurable here)
        // we keep L5 as stretch; list it if reached 4
        if(level===4) nextNeeds.push('Benchmark: demonstrate restart within 24h and add initial customer-view problem description.');
      }

      if(stepId==='s1'){
        const l2 = txtNotEmpty('s1-team') && txtNotEmpty('s1-leader');
        if(!l2) nextNeeds.push('Fill Team Charter and specify 9S Leader.');
        if(l2) level=2;

        const l3 = chk('s1-ops');
        if(level>=2 && !l3) nextNeeds.push('Include Operations representative in MFT.');
        if(level>=2 && l3) level=3;

        const l4 = txtNotEmpty('s1-sponsor') && chk('s1-supplier');
        if(level>=3 && !l4) nextNeeds.push('Nominate active Sponsor and integrate Supplier.');
        if(level>=3 && l4) level=4;

        if(level===4 && !txtNotEmpty('s1-ll')) nextNeeds.push('Benchmark: reference relevant Lessons Learned.');
        if(level===4 && txtNotEmpty('s1-ll')) level=5;
      }

      if(stepId==='s2'){
        const issue = (get('issue-description-input')?.value||'').toLowerCase();
        const l2 = txtNotEmpty('issue-description-input');
        if(!l2) nextNeeds.push('Provide a fact-based Issue Description.');
        if(l2) level=2;

        const l3 = /1\s*object/.test(issue) || /1\s*defect/.test(issue);
        if(level>=2 && !l3) nextNeeds.push('Ensure “1 object / 1 defect” clarity in Issue Description.');
        if(level>=2 && l3) level=3;

        const l4 = txtNotEmpty('s2-5w2h') && txtNotEmpty('s2-problem');
        if(level>=3 && !l4) nextNeeds.push('Complete 5W2H and derive a final Problem Statement.');
        if(level>=3 && l4) level=4;

        const l5 = txtNotEmpty('s2-isnot') && hasFileOrDemo('s2-d5','s2-workflow');
        if(level>=4 && !l5) nextNeeds.push('Add IS/IS NOT and a process workflow from origin to delivery.');
        if(level>=4 && l5) level=5;
      }

      if(stepId==='s3'){
        const l3 = hasFileOrDemo('s3-d2','s3-trace') || hasFileOrDemo('s3-d1','s3-proof');
        if(!l3) nextNeeds.push('Provide at least traceability or an initial effectiveness proof.');
        if(l3) level=3;

        const l4 = hasFileOrDemo('s3-d1','s3-proof') && hasFileOrDemo('s3-d2','s3-trace');
        if(level>=3 && !l4) nextNeeds.push('Provide formal proof of 100% effectiveness and full traceability.');
        if(level>=3 && l4) level=4;

        if(level===4) nextNeeds.push('Benchmark: set up continuous review and look-across to similar products.');
      }

      if(stepId==='s4'){
        const l3 = txtNotEmpty('rc1-input') && txtNotEmpty('rc2-input');
        if(!l3) nextNeeds.push('Complete 5-Why for Occurrence and Non-Detection (fill RC1 & RC2).');
        if(l3) level=3;

        const ishFilled = ['ish-man','ish-machine','ish-material','ish-method','ish-management','ish-milieu'].some(id=>txtNotEmpty(id));
        const l4 = ishFilled && txtNotEmpty('rc3-input') && (document.getElementById('s4-evidence')?.files?.length>0);
        if(level>=3 && !l4) nextNeeds.push('Use Ishikawa, identify Systemic RC, and attach evidence proving the RC.');
        if(level>=3 && l4) level=4;

        if(level===4) nextNeeds.push('Benchmark: apply advanced RCA method if complexity requires (Shainin/DoE).');
      }

      if(stepId==='s5'){
        const l3 = txtNotEmpty('s5-rc1-actions') && txtNotEmpty('s5-rc2-actions');
        if(!l3) nextNeeds.push('Define actions for RC1 and RC2 (Occurrence & Non-Detection).');
        if(l3) level=3;

        const l4 = l3; // already requires separate actions
        if(level>=3 && !l4) nextNeeds.push('Add specific actions per RC path.');
        if(level>=3 && l4) level=4;

        const l5 = txtNotEmpty('s5-kpi') && txtNotEmpty('s5-risk');
        if(level>=4 && !l5) nextNeeds.push('Define KPI (success criteria) and perform risk analysis.');
        if(level>=4 && l5) level=5;
      }

      if(stepId==='s6' || stepId==='s7' || stepId==='s8'){
        // keep generic messages for demo
        nextNeeds.push('Complete the previous steps and attach required evidence as applicable.');
      }

      return {level, nextNeeds};
    }

    function renderMaturityModal(modal, stepId, {level, nextNeeds}){
      const titleMap={s0:'S0 Containment',s1:'S1 Team',s2:'S2 Evidence Hub',s3:'S3 Validate Containment',s4:'S4 RCA',s5:'S5 Define Actions',s6:'S6 Implement & Check',s7:'S7 Standardize & Prevent',s8:'S8 Close'};
      modal.querySelector('#maturity-title').textContent = `Maturity Evaluation – ${titleMap[stepId]||stepId.toUpperCase()}`;
      const body=modal.querySelector('#maturity-body');
      const lvlTxt = `<p><strong>Detected Level:</strong> ${level} ${level===4?'(Requirements in place ✅)':''}</p>`;
      const nextTxt = nextNeeds.length
        ? `<p><strong>To reach next level:</strong></p><ul>${nextNeeds.map(n=>`<li>${n}</li>`).join('')}</ul>`
        : `<p><strong>Great!</strong> You already fulfill the next level criteria.</p>`;
      body.innerHTML = lvlTxt + nextTxt;
    }

    /* ----------------- Modals: 5-Why ----------------- */
    function bindWhyModal(container){
      const modal = container.querySelector('#five-why-modal');
      if(!modal) return;
      let activeWhyTarget=null;

      container.querySelectorAll('.analyze-btn').forEach(btn=>{
        btn.onclick = (e)=>{
          activeWhyTarget = container.querySelector(`#${e.target.dataset.rcTarget}`);
          modal.querySelector('#five-why-title').textContent = e.target.dataset.rcTitle;
          modal.querySelector('#why-container').innerHTML='';
          addWhyLevel(1, modal);
          modal.style.display='block';
        };
      });

      function addWhyLevel(level, modal){
        const cont = modal.querySelector('#why-container');
        const wrap = document.createElement('div');
        wrap.className='why-level-container';
        wrap.innerHTML = `
          <div class="why-level">
            <div class="why-level-content">
              <label>${level}. Why?</label>
              <textarea rows="2"></textarea>
            </div>
            ${level<5?`<button class="add-why-btn" data-level="${level+1}">+ Why</button>`:''}
          </div>`;
        cont.appendChild(wrap);
        const nextBtn = wrap.querySelector('.add-why-btn');
        if(nextBtn){
          nextBtn.onclick=(e)=>{
            e.target.style.display='none';
            addWhyLevel(parseInt(e.target.dataset.level,10), modal);
          };
        }
      }

      modal.querySelector('#save-why-btn').onclick=()=>{
        const t = modal.querySelectorAll('#why-container textarea');
        if(t.length>0 && activeWhyTarget){
          activeWhyTarget.value = t[t.length-1].value;
        }
        modal.style.display='none';
      };

      modal.querySelector('.modal-close-btn').onclick=()=> modal.style.display='none';
      window.addEventListener('click',(evt)=>{ if(evt.target===modal) modal.style.display='none'; });
    }

    /* ------------- S2: M1750 Suggestion Button ------------- */
    function bindM1750Suggestion(container){
      const btn = container.querySelector('#m1750-btn');
      if(!btn) return;
      const out = container.querySelector('#suggestion-output');
      btn.onclick=()=>{
        const txt = (container.querySelector('#issue-description-input')?.value||'').toLowerCase();
        const hits = new Map();
        M1750_KEYWORDS.forEach(({kw,code,label})=>{
          if(kw.some(k=>txt.includes(k))) hits.set(code,label);
        });
        if(hits.size===0){
          out.style.display='block';
          out.textContent = 'No strong match. Consider GEN-004 (Incorrect Assembly) if assembly-related, or apply Engineering Judgement.';
        } else {
          out.style.display='block';
          out.innerHTML = `<strong>Suggested M1750 criteria:</strong><ul>${[...hits.entries()].map(([c,l])=>`<li>${c} – ${l}</li>`).join('')}</ul>`;
        }
      };
    }

    /* -------------------- Boot -------------------- */
    // initial render
    renderDashboard();

    // demo: clicking hash routes
    window.addEventListener('hashchange',()=>{
      const hash = decodeURIComponent(window.location.hash||'');
      if(hash.startsWith('#/sari/')){
        const id = hash.replace('#/sari/','');
        showSariDetail(id);
      } else {
        showDashboard();
      }
    });

    // helper setters
    function setVal(id,val){ const el=document.getElementById(id); if(el) el.value=val; }
    function setCheck(id,val){ const el=document.getElementById(id); if(el) el.checked=!!val; }
    function setDateVal(id,val){ const el=document.getElementById(id); if(el) el.value=val; }
  });
  </script>
</body>
</html>